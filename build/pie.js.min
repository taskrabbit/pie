!function(t){var e=t.pie={apps:{},array:{},browser:{},date:{},dom:{},fn:{},math:{},object:{},string:{},mixins:{},pieId:1,ns:function(n){return e.object.getPath(t,n)||e.object.setPath(t,n,{})},setUid:function(t){return t.pieId=t.pieId||e.unique()},unique:function(){return String(e.pieId++)},guid:function(){var t,e;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){return t=16*Math.random()|0,e="x"===n?t:3&t|8,e.toString(16)})},util:function(){var t={};return t.a=e.array,t.b=e.browser,t.d=e.date,t.$=e.dom,t.fn=e.fn,t.m=e.math,t.o=e.object,t.s=e.string,t.x=e.mixins,t.unique=e.unique,t.setUid=e.setUid,t}};e.array.areAll=function(t,e){for(var n=0;n<t.length;n++)if(!e.call(null,t[n]))return!1;return!0},e.array.areAny=function(t,e){for(var n=0;n<t.length;n++)if(e.call(null,t[n]))return!0;return!1},e.array.change=function(){var t=e.array.from(arguments),n=t.shift();return t.forEach(function(t){n=e.array[t](n)}),n},e.array.avg=function(t){var n=e.array.sum(t),i=t.length;return i?n/i:0},e.array.compact=function(t,e){return t.filter(function(t){return e?!!t:null!=t})},e.array.detect=function(t,n){for(var i=0,r=t.length;r>i;i++)if(e.object.getValue(t[i],n))return t[i]},e.array.detectLast=function(t,n){for(var i=t.length-1,r=0;i>=r;i--)if(e.object.getValue(t[i],n))return t[i]},e.array.dup=function(t){return t.slice(0)},e.array.flatten=function(t,n,i){return i=i||[],Array.isArray(t)&&-1!==n?(null!=n&&n--,t.forEach(function(t){e.array.flatten(t,n,i)})):i.push(t),i},e.array.from=function(t){return Array.isArray(t)?t:e.object.isArguments(t)||t instanceof NodeList||t instanceof HTMLCollection?Array.prototype.slice.call(t,0):e.array.compact([t],!1)},e.array.get=function(t,e,n){return 0>e&&(e+=t.length),n?(0>n&&(n+=t.length),t.slice(e,n+1)):t[e]},e.array.grep=function(t,e){return t.filter(function(t){return e.test(String(t))})},e.array.groupBy=function(t,n){var i,r={};return t.forEach(function(t){i=e.object.getValue(t,n),null!=i&&(r[i]=r[i]||[],r[i].push(t))}),r},e.array.indexOf=function(t,n){for(var i=0,r=t.length;r>i;i++)if(e.object.getValue(t[i],n))return i;return-1},e.array.intersect=function(t,e){return t.filter(function(t){return~e.indexOf(t)})},e.array.last=function(t){return t&&t.length?t[t.length-1]:void 0},e.array.map=function(t,n,i){var r;return r=e.object.isFunction(n)?n:function(t){var r=t[n];return i&&e.object.isFunction(r)?r.apply(t):r},t.map(function(t){return r(t)})},e.array.remove=function(t,e){for(var n;~(n=t.indexOf(e));)t.splice(n,1);return t},e.array.subtract=function(t,e){return t.filter(function(t){return!~e.indexOf(t)})},e.array.sum=function(t){var e=0;return t.forEach(function(t){e+=parseFloat(t)}),e},e.array.sortBy=function(t,n){var i,r;return t.sort(function(t,a){return i=e.object.getValue(t,n),r=e.object.getValue(a,n),i===r?0:r>i?-1:1})},e.array.toSentence=function(t,n){if(!t.length)return"";n=e.object.merge({i18n:e.object.getPath(e,"appInstance.i18n")},n),n.delimeter=n.delimeter||n.i18n&&n.i18n.t("sentence.delimeter",{"default":", "}),n.and=n.and||n.i18n&&n.i18n.t("sentence.and",{"default":" and "}),n.punctuate=n.punctuate===!0?".":n.punctuate,t.length>2&&(t=[t.slice(0,t.length-1).join(n.delimeter),t.slice(t.length-1)]);var i=t.join(n.and);return n.punctuate&&!e.string.endsWith(i,n.punctuate)&&(i+=n.punctuate),i},e.array.union=function(){var t=e.array.from(arguments);return t=e.array.compact(t,!0),t=e.array.flatten(t),t=e.array.unique(t)},e.array.unique=function(t){return t.filter(function(e,n){return t.indexOf(e)===n})},e.browser.getCookie=function(t,e){for(var n,i=e&&e.raw?function(t){return t}:decodeURIComponent,r=document.cookie.split("; "),a=0;a<r.length;a++)if(n=r[a],n&&(n=n.split("="),i(n[0])===t))return i(n[1]||"");return null},e.browser.isRetina=function(){return t.devicePixelRatio>1},e.browser.isTouchDevice=function(){return"ontouchstart"in t||t.DocumentTouch&&document instanceof t.DocumentTouch||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0},e.browser.testMediaQuery=function(n){n=e.browser.mediaQueries[n]||n;var i=t.matchMedia||t.msMatchMedia;return i?i(n).matches:void 0},e.browser.orientation=function(){switch(t.orientation){case 90:case-90:return"landscape";default:return"portrait"}},e.browser.setCookie=function(t,n,i){if(i=e.object.merge({},i),null==n&&(i.expires=-1),e.object.isNumber(i.expires)){var r=i.expires;i.expires=new Date,i.expires.setDate(i.expires.getDate()+r)}n=String(n);var a=[encodeURIComponent(t),"=",i.raw?n:encodeURIComponent(n),i.expires?"; expires="+i.expires.toUTCString():"",i.path?"; path="+i.path:"",i.domain?"; domain="+i.domain:"",i.secure?"; secure":""].join("");return document.cookie=a,a},e.date.dateFromISO=function(t){if(!t)return null;var e=t.split(/T|\s/)[0].split("-");return new Date(e[0],e[1]-1,e[2])},e.date.now=function(){return(new Date).getTime()},e.date.timeFromISO=function(){var t=[1,4,5,6,7,10,11];return function(n){if(!n)return 0/0;if(!/T|\s/.test(n))return e.date.dateFromISO(n);var i,r,a=0;if(r=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/.exec(n)){for(var o,s=0;o=t[s];++s)r[o]=+r[o]||0;r[2]=(+r[2]||1)-1,r[3]=+r[3]||1,"Z"!==r[8]&&void 0!==r[9]&&(a=60*r[10]+r[11],"+"===r[9]&&(a=0-a)),i=Date.UTC(r[1],r[2],r[3],r[4],r[5]+a,r[6],r[7])}else i=0/0;return new Date(i)}}(),e.dom._all=function(t,n){var i,r,a,o,s=e.array.from(t[0]),h=t[1].split("."),u=Array.prototype.slice.call(t,2),c=h[h.length-1],l=/=$/.test(c);return l&&(c=c.substr(0,c.length-1)),n&&(i=[]),s.forEach(function(t){for(a=0;a<h.length-1;a++)r=t[h[a]],t=e.fn.valueFrom(r);l?o=t[c]=u[0]:(r=t[c],o=e.fn.valueFrom(r,t,u)),n&&i.push(o)}),n?i:void 0},e.dom.all=function(){return e.dom._all(arguments,!1)},e.dom.getAll=function(){return e.dom._all(arguments,!0)},e.dom.createElement=function(t){var e=document.createElement("div");return e.innerHTML=t,e.removeChild(e.firstElementChild)},e.dom.cache=function(){return e.elementCache=e.elementCache||new e.cache,e.elementCache},e.dom.remove=function(t){e.setUid(t),e.dom.cache().del("element-"+t.pieId),t.parentNode&&t.parentNode.removeChild(t)},e.dom.off=function(t,n,i,r,a){var o,s,h,u=n.split(".");e.setUid(t),n=u.shift(),o=u.join("."),s="*"===n,h=e.dom.cache().getOrSet("element-"+t.pieId+".dom-events",{}),(s?Object.keys(h):[n]).forEach(function(n){e.array.from(h[n]).forEach(function(s,u,c){a||"focus"!==n&&"blur"!==n||!s.sel||(a=!0),o&&o!==s.ns||i&&i!==s.fn||r&&r!==s.sel||a!==s.cap||(t.removeEventListener(n,s.cb,s.cap),delete c[u]),h[n]=e.array.compact(e.array.from(h[n]))})})},e.dom.on=function(t,n,i,r,a){var o,s,h,u=n.split(".");return n=u.shift(),s=u.join("."),e.setUid(t),a||"focus"!==n&&"blur"!==n||!r||(a=!0),h=e.dom.cache().getOrSet("element-"+t.pieId+".dom-events",{}),h[n]=h[n]||[],o=function(n){var a,o;s&&(n.namespace=s),r?(o=e.array.from(t.querySelectorAll(r)),a=e.array.detect(o,function(t){return t===n.target||t.contains(n.target)}),a&&(n.delegateTarget=a,i.call(a,n))):i.call(t,n)},h[n].push({ns:s,sel:r,cb:o,fn:i,cap:a}),t.addEventListener(n,o,a),o},e.dom.trigger=function(t,e,n){if(!n&&"click"===e)return t.click();var i=document.createEvent("Event");return i.initEvent(e,!0,!0),t.dispatchEvent(i)},e.fn.async=function(t,e,n){if(!t.length)return void e();var i=t.length,r=0,a=function(){n&&n.apply(null,arguments),++r===i&&e()};t.forEach(function(t){t(a)})},e.fn.debounce=function(t,n,i){var r,a,o,s,h,u=function(){var c=e.date.now()-s;n>c&&c>0?r=setTimeout(u,n-c):(r=null,i||(h=t.apply(o,a),r||(o=a=null)))};return function(){o=this,a=arguments,s=e.date.now();var c=i&&!r;return r||(r=setTimeout(u,n)),c&&(h=t.apply(o,a),o=a=null),h}},e.fn.valueFrom=function(t,n,i){return e.object.isFunction(t)?t.apply(n,i):t},e.math.precision=function(t,e){return Math.round(t*Math.pow(10,e))/Math.pow(10,e)},e.object.compact=function(t,n){var i=e.object.merge({},t);return Object.keys(i).forEach(function(t){(void 0===i[t]||null===i[t]||n&&0===i[t].toString().length)&&delete i[t]}),i},e.object.deepMerge=function(){function t(t){r[t]=t in r&&e.object.isObject(r[t])?e.object.deepMerge(r[t],n[t]):n[t]}for(var n,i=e.array.from(arguments),r=i.shift();i.length;)n=i.shift(),n&&Object.keys(n).forEach(t);return r},e.object.except=function(){var t=e.array.from(arguments),n=t.shift(),i={};return t=e.array.flatten(t),Object.keys(n).forEach(function(e){t.indexOf(e)<0&&(i[e]=n[e])}),i},e.object.deletePath=function(t,n,i){~n.indexOf(".")||delete t[n];for(var r,a,o=e.string.pathSteps(n);o.length;){if(r=e.array.last(o.shift().split(".")),a=e.object.getPath(t,o[0]),!a)return;if(delete a[r],!i||Object.keys(a).length)return}},e.object.flatten=function(t,n,i){var r=n||{};return i=i||"",e.object.forEach(t,function(t,n){e.object.isObject(n)?e.object.flatten(n,r,t+"."):r[i+t]=n}),r},["Object","Arguments","Function","String","Number","Date","RegExp","Boolean"].forEach(function(t){e.object["is"+t]=function(e){return Object.prototype.toString.call(e)==="[object "+t+"]"}}),function(){e.object.isArguments(arguments)||(e.object.isArguments=function(t){return t&&t.hasOwnProperty("callee")})}(),e.object.isUndefined=function(t){return void 0===t},e.object.merge=function(){function t(t){r[t]=n[t]}for(var n,i=e.array.from(arguments),r=i.shift();i.length;)n=i.shift(),n&&Object.keys(n).forEach(t);return r},e.object.forEach=function(t,e){t&&Object.keys(t).forEach(function(n){e(n,t[n])})},e.object.getPath=function(t,e){if(!e)return t;if(!~e.indexOf("."))return t[e];for(var n,i=e.split(".");i.length;){if(!t)return t;if(n=i.shift(),!i.length)return t[n];t=t[n]}return t},e.object.getValue=function(t,n){return e.object.isFunction(n)?n.call(null,t):null==t?void 0:e.object.isFunction(t[n])?t[n].call(t):e.object.has(t,n)?t[n]:void 0},e.object.has=function(t,e){return t&&t.hasOwnProperty(e)},e.object.hasPath=function(t,n){if(!~n.indexOf("."))return e.object.has(t,n);for(var i,r=n.split(".");i=r.shift();){if(!e.object.has(t,i))return!1;t=t[i]}return!0},e.object.serialize=function(t,n){var i,r,a,o=[],s=/\[\]$/;return i=function(t,i){i=e.fn.valueFrom(i),(!n||s.test(t)||null!=i&&i.toString().length)&&o.push(encodeURIComponent(t)+"="+encodeURIComponent(String(i)))},r=function(t){o.push(encodeURIComponent(t)+"=")},a=function(t,n,i){Array.isArray(n)?n.forEach(function(e){a(t+"[]",e,i)}):e.object.isObject(n)?Object.keys(n).sort().forEach(function(e){a(t+"["+e+"]",n[e],i)}):i(t,n)},Object.keys(t).sort().forEach(function(e){a(e,t[e],i)}),o.join("&")},e.object.setPath=function(t,e,n){if(!~e.indexOf("."))return t[e]=n;for(var i,r=e.split(".");r.length;){if(i=r.shift(),!r.length)return t[i]=n;t=t[i]?t[i]:t[i]={}}},e.object.slice=function(){var t=e.array.from(arguments),n=t.shift(),i={};return t=e.array.flatten(t),t.forEach(function(t){e.object.has(n,t)&&(i[t]=n[t])}),i},e.object.values=function(t){return Object.keys(t).map(function(e){return t[e]})},e.string.PROTOCOL_TEST=/\w+:\/\//,e.string.capitalize=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},e.string.change=function(){var t=e.array.from(arguments),n=t.shift();return t.forEach(function(t){n=e.string[t](n)}),n},e.string.deserialize=function(){function t(t){if("undefined"===t)return void 0;if("null"===t)return null;if("true"===t)return!0;if("false"===t)return!1;if(/^-?\d*(\.\d+)?$/.test(t)){var e=parseFloat(t,10),n=parseInt(e,10);if(!isNaN(e)&&e%1)return e;if(!isNaN(n))return n}return t}function e(t,e,n){var i,r,a,o=t.split("["),s=/^\[(.+)?\]$/;for(t=o.shift(),o=o.map(function(t){return"["+t}),a=n;r=o.shift();)i=r.match(s),i[1]?(a[t]=a[t]||{},a=a[t],t=i[1]):(a[t]=a[t]||[],a=a[t],t=a.length);return a[t]=e,n}return function(n,i){var r,a,o,s,h,u={};return n?(r=n.indexOf("?"),~r&&(n=n.slice(r+1)),a=n.split("&"),a.forEach(function(n){o=n.split("="),s=decodeURIComponent(o[0]||""),h=decodeURIComponent(o[1]||""),i&&(h=t(h)),e(s,h,u)}),u):u}}(),e.string.downcase=function(t){return t.toLowerCase()},e.string.escape=function(){var t=/[<>&"'\x00]/g,e={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"};return function(n){return null==n?n:(""+n).replace(t,function(t){return e[t]||""})}}(),e.string.endsWith=function(t,e){return-1!==t.indexOf(e,t.length-e.length)},e.string.expand=function(t,e){return e=e||{},t.replace(/\%\{(.+?)\}/g,function(t,n){return e[n]})},e.string.humanize=function(t){return t.replace(/_id$/,"").replace(/([a-z][A-Z]|[a-z]_[a-z])/g,function(t,e){return e[0]+" "+e[e.length-1]})},e.string.lowerize=function(t){return t.charAt(0).toLowerCase()+t.slice(1)},e.string.modularize=function(t){return t.replace(/([^_])_([^_])/g,function(t,e,n){return e+n.toUpperCase()})},e.string.normalizeUrl=function(t){if(e.string.PROTOCOL_TEST.test(t)||"/"===t.charAt(0)||(t="/"+t),t.indexOf("?")>0){var n=t.split("?");t=e.string.normalizeUrl(n.shift()),n.unshift(t),t=n.join("?")}return"#"===t.charAt(t.length-1)&&(t=t.substr(0,t.length-1)),t.length>1&&"/"===t.charAt(t.length-1)&&(t=t.substr(0,t.length-1)),t},e.string.pluralize=function(t,e){return 1===e?t:/ss$/i.test(t)?t+"es":/s$/i.test(t)?t:/[a-z]$/i.test(t)?t+"s":t},e.string.template=function(t,e){return new Function("data","var p=[];"+(e||"")+";with(data){p.push('"+t.replace(/[\r\t\n]/g," ").replace(/'(?=[^%]*%\])/g,"	").split("'").join("\\'").split("	").join("'").replace(/\[%=(.+?)%\]/g,"',$1,'").replace(/\[%-(.+?)%\]/g,"',pie.string.escape($1),'").split("[%").join("');").split("%]").join("p.push('")+"');}return p.join('');")},e.string.titleize=function(t){return t.replace(/(^| )([a-z])/g,function(t,e,n){return e+n.toUpperCase()})},e.string.pathSteps=function(t){for(var e=t.split("."),n=[];e.length;)n.push(e.join(".")),e.pop();return n},e.string.underscore=function(t){return t.replace(/([a-z])([A-Z])/g,function(t,e,n){return e+"_"+n.toLowerCase()}).toLowerCase()},e.string.upcase=function(t){return t.toUpperCase()},e.string.urlConcat=function(){var t=e.array.compact(e.array.from(arguments),!0),n=t.shift(),i=t.join("&");return i.length?(n.indexOf("?")<0&&(n+="?"),i=0===i.indexOf("?")?i.replace("?","&"):"&"+i,n+=i,n=n.replace("?&","?").replace("&&","&").replace("??","?"),n.indexOf("?")===n.length-1&&(n=n.substr(0,n.length-1)),n):n},e.mixins.bindings=function(){var t={attribute:function(){var t=function(t){return t.options.attribute||"data-"+t.attr};return{getValue:function(e,n){return e.getAttribute(t(n))},setValue:function(e,n){var i=n.model.get(n.attr);return e.setAttribute(t(n),i)}}}(),value:{getValue:function(t){return t.value},setValue:function(t,e){var n=e.model.get(e.attr);return null==n&&(n=""),t.value=n}},check:function(){var t=function(t,n){return n=String(n),e.array.indexOf(t,function(t){return String(t)===n})};return{getValue:function(n,i){var r,a=i.model.get(i.attr);if(Array.isArray(a)){if(a=e.array.dup(a),r=t(a,n.value),n.checked&&0>r)a.push(n.value);else{if(n.checked||!(r>=0))return void 0;a.splice(r,1)}return a}return n.checked?n.value:null},setValue:function(e,n){var i=n.model.get(n.attr),r=e.value;if(Array.isArray(i)){var a=t(i,r);return e.checked=!!~a}return e.checked=r==i}}}(),radio:{getValue:function(t){return t.checked?t.value:null},setValue:function(t,e){var n=e.model.get(e.attr),i=t.value;return t.checked=i==n}},text:{getValue:function(t){return t.innerText},setValue:function(t,e){var n=e.model.get(e.attr);return null==n&&(n=""),t.innerText=n}},html:{getValue:function(t){return t.innerHTML},setValue:function(t,e){var n=e.model.get(e.attr);return null==n&&(n=""),t.innerHTML=n}}},n={array:function(t){return e.array.from(t)},"boolean":function(){var t=/^(1|true|yes|t|ok)$/;return function(e){return e&&t.test(String(e))}}(),number:function(t){return parseFloat(t,10)},integer:function(t){return parseInt(t,10)},string:function(t){return String(t)},"default":function(t){return t}},i=function(t){if(!t.attr)throw new Error("An attr must be provided for data binding. "+JSON.stringify(t));var e={};return e.attr=t.attr,e.model=t.model||this.model,e.sel=t.sel||'[name="'+t.attr+'"]',e.type=t.type||"auto",e.dataType=t.dataType||"default",e.eachType=t.eachType||void 0,e.trigger=t.trigger||"change keyup",e.triggerSel=t.triggerSel||e.sel,e.toModel=t.toModel||void 0===t.toModel,e.toView=t.toView||void 0===t.toView,e.debounce=t.debounce||!1,e.options=t.options||{},e.debounce===!0&&(e.debounce=150),e},r=function(e,n){var i;return i=e.hasAttribute&&e.hasAttribute("data-"+n.attr)?"attribute":"INPUT"===e.nodeName&&"checkbox"===e.getAttribute("type")?"check":"INPUT"===e.nodeName&&"radio"===e.getAttribute("type")?"radio":"INPUT"===e.nodeName||"SELECT"===e.nodeName?"value":"text",t[i]},a=function(e,n){return"auto"===n.type?r(e,n):t[n.type]},o=function(t){return n[t]||n["default"]},s=function(t,e){void 0!==t&&(e.ignore=!0,e.model.set(e.attr,t),e.ignore=!1)},h=function(t,e){a(t,e).setValue(t,e)},u=function(t){if(!t.ignore){var n=e.array.from(this.qsa(t.sel));n.forEach(function(e){h(e,t)})}},c=function(t,e){var n=a(t,e).getValue(t,e),i=o(e.dataType);if(n=i(n),Array.isArray(n)&&e.eachType){var r=o(e.eachType);n=n.map(r)}return n},l=function(t){return t.toModel&&(t.toModel=function(e){var n=e.delegateTarget,i=c(n,t);s(i,t)},t.debounce&&(t.toModel=e.fn.debounce(t.toModel,t.debounce)),f.call(this,t)),t.toView&&(t.toView=function(){u.call(this,t)}.bind(this),d.call(this,t)),t},d=function(t){this.onChange(t.model,t.toView,t.attr)},f=function(t){var e=t.trigger.split(" ");e.forEach(function(e){this.on(e,t.triggerSel,t.toModel)}.bind(this))};return{init:function(){this._bindings=[],this._super&&this._super.apply(this,arguments),this.emitter&&this.emitter.on("afterRender",this.initBoundFields.bind(this))},bind:function(){var t=e.array.from(arguments);t=t.map(i.bind(this)),t=t.map(l.bind(this)),this._bindings=this._bindings.concat(t)},initBoundFields:function(){this._bindings.forEach(function(t){t.toView()})}}}(),e.mixins.changeSet={has:function(t){return e.array.areAny(this,function(e){return e.name===t})},get:function(t){return e.array.detectLast(this,function(e){return e.name===t})},hasAny:function(){var t=this.names(),n=e.array.from(arguments);return e.array.areAny(n,function(e){return!!~t.indexOf(e)})},hasAll:function(){var t=this.names(),n=e.array.from(arguments);return e.array.areAll(n,function(e){return!!~t.indexOf(e)})},last:function(){return e.array.last(this)},names:function(){return e.array.unique(e.array.map(this,"name"))}},e.mixins.container={init:function(){this.children=[],this.childNames={},this._super&&this._super.apply(this,arguments)},addChild:function(t,e){var n;return this.children.push(e),n=this.children.length-1,this.childNames[t]=n,e._indexWithinParent=n,e._nameWithinParent=t,e.parent=this,"addedToParent"in e&&e.addedToParent.call(e),this},addChildren:function(t){e.object.forEach(t,function(t,e){this.addChild(t,e)}.bind(this))},getChild:function(t){if(null!=t){if(t._nameWithinParent)return t;var e=this.childNames[t];return null==e&&(e=t),~e&&this.children[e]||void 0}},bubble:function(){for(var t=e.array.from(arguments),n=t.shift(),i=this.parent;i&&!(n in i);)i=i.parent;i&&i[n].apply(i,t)},removeChild:function(t){var e,n=this.getChild(t);if(n){for(e=n._indexWithinParent,this.children.splice(e,1);e<this.children.length;e++)this.children[e]._indexWithinParent=e,this.childNames[this.children[e]._nameWithinParent]=e;delete this.childNames[n._nameWithinParent],delete n._indexWithinParent,delete n._nameWithinParent,delete n.parent,"removedFromParent"in n&&n.removedFromParent.call(n,this)}return this},removeChildren:function(){for(var t;t=this.children[this.children.length-1];)this.removeChild(t);return this},__tree:function(t){t=t||0;var e=function(t,e){if(!e)return t;for(;e-->0;)t=" "+t;return t},n="\n",i=t+(t?4:1);return n+=e((t?"|- ":"")+this.className+" ("+(this._nameWithinParent||this.pieId)+")",t),this.children.forEach(function(t){n+="\n"+e("|",i),n+=t.__tree(i)}),t||(n+="\n"),n}},e.mixins.validatable={init:function(){this.validations=[],this.validationStrategy="dirty",this._super&&this._super.apply(this,arguments),this.data.validationErrors||(this.data.validationErrors={})},reportValidationError:function(t,e){this.set("validationErrors."+t,e||[])},validates:function(t,n){var i,r;this.validations=this.validations||{},Object.keys(t).forEach(function(n){i=e.array.from(t[n]),r=[],i.forEach(function(t){e.object.isString(t)?r.push({type:t,options:{}}):e.object.isFunction(t)?r.push({type:"fn",options:{fn:t}}):Object.keys(t).forEach(function(n){r.push(e.object.isObject(t[n])?{type:n,options:t[n]}:{type:n,options:e.object.merge({},t)})})}),this.validations[n]=this.validations[n]||[],this.validations[n]=this.validations[n].concat(r),this.observe(this.validationChangeObserver.bind(this),n)}.bind(this)),void 0!==n&&(this.validationStrategy=n)},validateAll:function(t){var n,i=!0,r=Object.keys(this.validations),a=function(){return void(t&&t(i))},o=function(t){i=!(!i||!t)};return r.length?(n=r.map(function(t){return function(e){return this.validate(t,e)}.bind(this)}.bind(this)),void e.fn.async(n,a,o)):a()},validationChangeObserver:function(t){var e=t[0];"validate"===this.validationStrategy?this.validate(e.name):"dirty"===this.validationStrategy&&this.data.validationErrors[e.name]&&this.data.validationErrors[e.name].length&&this.reportValidationError(e.name,!1)},validate:function(t,n){var i,r=this.app.validator,a=e.array.from(this.validations[t]),o=this.get(t),s=!0,h=[],u=function(t,e){s=!(!s||!e),e||h.push(r.errorMessage(t.type,t.options))},c=function(){return this.reportValidationError(t,h),void(n&&n(s))}.bind(this);return a.length?(i=a.map(function(t){return function(e){var n=r[t.type],i=function(n){e(t,n)},a=n.call(r,o,t.options,i);(a===!0||a===!1)&&e(t,a)}}),void e.fn.async(i,c,u)):c()}},e.base=function(){e.setUid(this),this.init.apply(this,arguments)},e.base.prototype.init=function(){},e.base.prototype.reopen=function(){var t=e.array.change(arguments,"from","flatten");return t.forEach(function(t){e.object.merge(this,e.object.except(t,"init")),t.init&&t.init.call(this)}.bind(this)),this},e.base.extend=function(){return e.base._extend(e.base.prototype,arguments)},e.base.reopen=function(){return e.base._reopen(e.base.prototype,arguments)},e.base._extend=function(t,n){n=e.array.change(n,"from","flatten","compact");var i,r="";return e.object.isString(n[0])&&(r=n.shift()),e.object.isFunction(n[0])&&n.unshift({init:n.shift()}),r||(r=e.object.getPath(n[0],"init.name")||""),i=new Function("return function "+r+"(){\n  var myProto = Object.getPrototypeOf(this);\n  var parentProto = Object.getPrototypeOf(myProto);\n  parentProto.constructor.apply(this, arguments);\n};")(),i.prototype=Object.create(t),i.prototype.className=r,i.extend=function(){return e.base._extend(i.prototype,arguments)},i.reopen=function(){return e.base._reopen(i.prototype,arguments)},n.length&&i.reopen(n),i},e.base._reopen=function(t,n){n=e.array.change(n,"from","flatten","compact"),n.forEach(function(n){e.object.forEach(n,function(n,i){t[n]=e.base._wrap(i,t[n])})})},e.base._wrap=function(){var t=/xyz/.test(function(){"xyz"});return t=t?/\b_super\b/:/.*/,function(n,i){return null==n?i:null==i?n:e.object.isFunction(n)&&e.object.isFunction(i)&&t.test(n)?function(){var t,e=this._super;return this._super=i,t=n.apply(this,arguments),e?this._super=e:delete this._super,t}:n}}(),e.app=e.base.extend("app",{init:function(t){this.options=e.object.deepMerge({uiTarget:"body",viewNamespace:"lib.views",templateSelector:'script[type="text/pie-template"]',root:"/"},t);var n=function(t,e){var n=this.options[t]||e;return new n(this)}.bind(this);this.emitter=n("emitter",e.emitter),this.i18n=n("i18n",e.i18n),this.ajax=n("ajax",e.ajax),this.notifier=n("notifier",e.notifier),this.errorHandler=n("errorHandler",e.errorHandler),this.router=n("router",e.router),this.resources=n("resources",e.resources),this.helpers=n("helpers",e.helpers),this.templates=n("templates",e.templates),this.navigator=n("navigator",e.navigator),this.validator=n("validator",e.validator),this.viewTransitionClass=this.options.viewTransitionClass||e.simpleViewTransition,this.parsedUrl={},this.navigator.observe(this.navigationChanged.bind(this),"url"),this.emitter.once("beforeStart",this.setupSinglePageLinks.bind(this)),this.emitter.once("afterStart",this.showStoredNotifications.bind(this)),document.addEventListener("DOMContentLoaded",this.start.bind(this)),e.appInstance=e.appInstance||this,e.apps[this.pieId]=this},confirm:function(e){t.confirm(e.text)?e.onConfirm&&e.onConfirm():e.onDeny&&e.onDeny()},debug:function(t){"production"!==this.env&&console&&console.log&&console.log("[PIE] "+t)},go:function(){var n,i,r,a=e.array.from(arguments);n=a.shift(),n="object"==typeof a[0]?this.router.path(n,a.shift()):this.router.path.apply(this.router,e.array.from(n)),e.object.isBoolean(a[0])&&(r=a.shift()),i=a,this.router.parseUrl(n).hasOwnProperty("view")?(this.navigator.go(n,{},r),i&&i.length&&(this.emitter.once("viewChanged"),this.notifier.notify.apply(this.notifier,i))):(i&&i.length&&this.store(this.notifier.storageKey,i),t.location.href=n)},goBack:function(){t.history.back()},handleSinglePageLinkClick:function(e){if(!e.delegateTarget.getAttribute("target")&&!e.ctrlKey&&!e.metaKey){var n=e.delegateTarget.getAttribute("href");n&&!/^(#|[a-z]+:\/\/)/.test(n)&&("?"===n.charAt(0)&&(n=t.location.pathname+n),e.preventDefault(),this.go(n))}},navigationChanged:function(){var t=this.getChild("currentView");if(this.previousUrl=this.parsedUrl,this.parsedUrl=this.router.parseUrl(this.navigator.get("fullPath")),this.previousUrl!==this.parsedUrl&&this.emitter.fire("urlChanged"),!this.parsedUrl.view){if(!this.parsedUrl.redirect)return;var e=this.parsedUrl.redirect;return e=app.router.path(e,this.parsedUrl.data),void this.go(e)}return t&&t._pieName===this.parsedUrl.view?void("navigationUpdated"in t&&t.navigationUpdated()):void this.transitionToNewView()},transitionToNewView:function(){var n,i=document.querySelector(this.options.uiTarget),r=this.getChild("currentView");this.emitter.fire("beforeViewChanged"),this.emitter.fireAround("aroundViewChanged",function(){this.emitter.fire("viewChanged");var a,o=e.object.getPath(t,this.options.viewNamespace+"."+this.parsedUrl.view);a=new o({app:this}),a._pieName=this.parsedUrl.view,n=new this.viewTransitionClass(this,e.object.merge({oldChild:r,newChild:a,childName:"currentView",targetEl:i},this.options.viewTransitionOptions)),n.emitter.on("afterRemoveOldChild",function(){this.emitter.fire("oldViewRemoved",r)}.bind(this)),n.emitter.on("afterTransition",function(){this.emitter.fire("newViewLoaded",a)}.bind(this)),n.transition(function(){this.emitter.fire("afterViewChanged")}.bind(this))}.bind(this))},refresh:function(){var t=this.getChild("currentView");t._pieName="__remove__",this.navigationChanged()},retrieve:function(e,n){var i,r;try{i=t.localStorage.getItem(e),r=i?JSON.parse(i):void 0}catch(a){this.errorHandler.reportError(a,{prefix:"[caught] app#retrieve/getItem:"})}try{(n||void 0===n)&&t.localStorage.removeItem(e)}catch(a){this.errorHandler.reportError(a,{prefix:"[caught] app#retrieve/removeItem:"})}return r},setupSinglePageLinks:function(){e.dom.on(document.body,"click",this.handleSinglePageLinkClick.bind(this),"a[href]")},showStoredNotifications:function(){var t,e=this.retrieve(this.notifier.storageKey);e&&(t=JSON.parse(e),this.notifier.notify.apply(this.notifier,t))},start:function(){this.emitter.fireSequence("start",this.navigator.start.bind(this.navigator))},store:function(e,n){try{t.localStorage.setItem(e,JSON.stringify(n))}catch(i){this.errorHandler.reportError(i,{prefix:"[caught] app#store:"})}}},e.mixins.container,e.mixins.events),e.model=e.base.extend("model",{init:function(t,n){this.data=e.object.merge({_version:1},t),this.options=n||{},this.app=this.app||this.options.app||e.appInstance,this.observations={},this.changeRecords=[],e.setUid(this)},trackVersion:function(){this.options.trackVersion!==!1&&this.changeRecords.length&&this.set("_version",this.get("_version")+1,{skipObservers:!0})},deliverChangeRecords:function(){if(!this.changeRecords.length)return this;var t,n,i,r,a={};for(this.trackVersion();i=this.changeRecords.shift();)for(t=e.array.union(this.observations[i.name],this.observations.__all__);n=t.shift();)a[n.pieId]||(r=[],e.object.merge(r,e.mixins.changeSet),a[n.pieId]={fn:n,changes:r}),a[n.pieId].changes.push(i);return e.object.forEach(a,function(t,e){e.fn.call(null,e.changes)}),this},get:function(t){return e.object.getPath(this.data,t)},getOrSet:function(t,e){var n=this.get(t);return null!=n?n:(this.set(t,e),this.get(t))},gets:function(){var t=e.array.from(arguments),n={};return t=e.array.flatten(t),t=e.array.compact(t),t.forEach(function(t){n[t]=e.object.getPath(this.data,t)}.bind(this)),e.object.compact(n)},has:function(t){return!!e.object.hasPath(this.data,t)},observe:function(){var t=e.array.from(arguments),n=t.shift();return e.setUid(n),t=e.array.flatten(t),t.length||t.push("__all__"),t.forEach(function(t){this.observations[t]=this.observations[t]||[],this.observations[t].indexOf(n)<0&&this.observations[t].push(n)}.bind(this)),this},reset:function(t){var e=Object.keys(this.data),n={};return e.forEach(function(t){"_version"!==t&&(n[t]=void 0)}),this.sets(n,t)},set:function(t,n,i){var r,a,o,s,h=~t.indexOf(".")?e.string.pathSteps(t):null;return s={name:t,object:this.data},!this.has(t)||(s.type="update",s.oldValue=e.object.getPath(this.data,t),i&&i.force||n!==s.oldValue)?(h&&(h.shift(),h=h.map(function(t){return r=this.get(t),[t,r&&Object.keys(r)]}.bind(this))),s.value=n,void 0===n?(e.object.deletePath(this.data,t,!0),s.type="delete"):(e.object.setPath(this.data,t,n),s.type=s.type||"add"),this.changeRecords.push(s),h&&h.forEach(function(t){a=t[1],t=t[0],r=this.get(t),o="delete"===s.type?r?"update":"delete":a?"update":"add",this.changeRecords.push({type:o,oldValue:a,value:r?Object.keys(r):void 0,name:t,object:this.data})}.bind(this)),i&&i.skipObservers?this:this.deliverChangeRecords()):this},sets:function(t,n){return e.object.forEach(t,function(t,e){this.set(t,e,{skipObservers:!0})}.bind(this)),n&&n.skipObservers?this:this.deliverChangeRecords()},unobserve:function(){var t,n=e.array.from(arguments),i=n.shift();return n.length||(n=Object.keys(this.observations)),n.forEach(function(e){t=this.observations[e].indexOf(i),~t&&this.observations[e].splice(t,1)}.bind(this)),this},compute:function(){var t=e.array.from(arguments),n=t.shift(),i=t.shift();e.object.isFunction(i)||(t.unshift(i),i=this[n].bind(this)),this.observe(function(){this.set(n,i.call(this))}.bind(this),t),this.set(n,i.call(this))}}),e.view=e.base.extend("view",{init:function(t){this.options=t||{},this.app=this.options.app||e.appInstance,this.el=this.options.el||e.dom.createElement("<div></div>"),this.eventedEls=[],this.changeCallbacks=[],this.emitter=new e.emitter,this.options.uiTarget&&this.emitter.once("afterSetup",this.appendToDom.bind(this)),this.options.setup&&this.setup()},addedToParent:function(){this.emitter.fire("addedToParent")},appendToDom:function(t){t=t||this.options.uiTarget,t!==this.el.parentNode&&this.emitter.fireSequence("attach",function(){t.appendChild(this.el)}.bind(this))},consumeEvent:function(t,e){t&&(t.preventDefault(),t.stopPropagation(),e&&t.stopImmediatePropagation())},eventNamespace:function(){return"view"+this.pieId},navigationUpdated:function(){this.children.forEach(function(t){"navigationUpdated"in t&&t.navigationUpdated()})},on:function(t,n,i,r){r=r||this.el,~this.eventedEls.indexOf(r)||this.eventedEls.push(r);var a=this.eventNamespace(),o=function(t){return t.namespace===a?i.apply(this,arguments):void 0};return t.split(" ").forEach(function(t){t+="."+a,e.dom.on(r,t,o,n)}.bind(this)),this},onChange:function(){var t=arguments[0],n=e.array.from(arguments).slice(1);if(!("observe"in t))throw new Error("Observable does not respond to observe");this.changeCallbacks.push([t,n]),t.observe.apply(t,n)},qs:function(t){return this.el.querySelector(t)},qsa:function(t){return this.el.querySelectorAll(t)},removeFromDom:function(){this.el.parentNode&&this.emitter.fireSequence("detach",function(){this.el.parentNode.removeChild(this.el)}.bind(this))},removedFromParent:function(){this.emitter.fire("removedFromParent")
},setup:function(){return this.emitter.fireSequence("setup"),this},teardown:function(){return this.emitter.fireSequence("teardown",function(){this.removeFromDom(),this._unobserveEvents(),this._unobserveChangeCallbacks(),this.teardownChildren(),this.removeChildren()}.bind(this)),this},teardownChildren:function(){this.children.forEach(function(t){t.teardown()})},_unobserveEvents:function(){var t="*."+this.eventNamespace();this.eventedEls.forEach(function(n){e.dom.off(n,t)})},_unobserveChangeCallbacks:function(){for(var t;this.changeCallbacks.length;)t=this.changeCallbacks.pop(),t[0].unobserve.apply(t[0],t[1])}},e.mixins.container),e.activeView=e.view.extend("activeView",{setup:function(){if(this.options.autoRender&&this.model){var t=e.object.isString(this.options.autoRender)?this.options.autoRender:"_version";this.onChange(this.model,this.render.bind(this),t)}this.options.renderOnSetup&&this.emitter.once("setup",this.render.bind(this)),this.emitter.on("render",this._renderTemplateToEl.bind(this)),this._super()},_renderTemplateToEl:function(){var t=this.templateName();if(t){var e=this.app.templates.render(t,this.renderData());this.el.innerHTML=e}},parseFields:function(){var t,n,i={},r=arguments[0],a=0;for(e.object.isString(r)?r=this.el:a++;a<arguments.length;a++)t=arguments[a],n=r.querySelector('[name="'+t+'"]:not([disabled])'),n&&e.object.setPath(i,t,n.value);return i},renderData:function(){return this.model?this.model.data:{}},render:function(){this.emitter.fireSequence("render")},templateName:function(){return this.options.template}}),e.ajax=e.base.extend("ajax",{init:function(t){this.app=t,this.defaultAjaxOptions={}},GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE",_defaultAjaxOptions:function(){return e.object.merge({},this.defaultAjaxOptions,{accept:"application/json",verb:this.GET,error:this.app.errorHandler.handleXhrError.bind(this.app.errorHandler)})},ajax:function(t){if(t=e.object.compact(t),t=e.object.merge({},this._defaultAjaxOptions(),t),t.verb=t.verb.toUpperCase(),t.extraError){var n=t.error;t.error=function(e){n(e),t.extraError(e)}}var i,r=new XMLHttpRequest,a=t.url,o=this;return t.verb===this.GET&&t.data&&(a=e.string.urlConcat(a,e.object.serialize(t.data))),a=e.string.normalizeUrl(a),t.progress?r.addEventListener("progress",t.progress,!1):t.uploadProgress&&r.upload.addEventListener("progress",t.uploadProgress,!1),r.open(t.verb,a,!0),this._applyHeaders(r,t),t.setup&&t.setup(r,t),r.onload=function(){t.tracker&&t.tracker(this),o._parseResponse(this,t),this.status>=200&&this.status<300||304===this.status?(t.dataSuccess&&t.dataSuccess(this.data),t.success&&t.success(this.data,this)):t.error&&t.error(this),t.complete&&t.complete(this)},t.verb!==this.GET&&(i=t.data?e.object.isString(t.data)?t.data:JSON.stringify(e.object.compact(t.data)):void 0),r.send(i),r},get:function(t){return t=e.object.merge({verb:this.GET},t),this.ajax(t)},post:function(t){return t=e.object.merge({verb:this.POST},t),this.ajax(t)},put:function(t){return t=e.object.merge({verb:this.PUT},t),this.ajax(t)},del:function(t){return t=e.object.merge({verb:this.DELETE},t),this.ajax(t)},_applyCsrfToken:function(t,n){var i,r=e.fn.valueFrom(n.csrfToken);r||(i=document.querySelector('meta[name="csrf-token"]'),r=i?i.getAttribute("content"):null),r&&t.setRequestHeader("X-CSRF-Token",r)},_applyHeaders:function(t,n){this._applyCsrfToken(t,n),n.accept&&t.setRequestHeader("Accept",n.accept),n.contentType?t.setRequestHeader("Content-Type",n.contentType):e.object.isString(n.data)?t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):t.setRequestHeader("Content-Type","application/json")},_parseResponse:function(t,e){var n=e.accept&&this.responseParsers[e.accept]||this.responseParsers["default"];t.data=n(t,e)},responseParsers:{"application/json":function(t){try{return t.responseText.trim().length?JSON.parse(t.responseText):{}}catch(e){return this.app.debug("could not parse JSON response: "+e),{}}},"default":function(t){return t.responseText}}}),e.cache=e.model.extend("cache",{init:function(t,e){this._super(t,e)},del:function(t){this.set(t,void 0)},expire:function(t,e){var n=this.get(t);return void 0===n?!1:(this.set(t,n,{ttl:e}),!0)},get:function(t){var n=e.model.prototype.get.call(this,t);return n?n.expiresAt&&n.expiresAt<=this.currentTime()?void this.set(t,void 0):n.data:void 0},getOrSet:function(t,e,n){var i=this.get(t);return void 0!==i?i:(this.set(t,e,n),e)},set:function(t,n,i){if(void 0===n)e.model.prototype.set.call(this,t,void 0,i);else{var r=this.wrap(n,i);e.model.prototype.set.call(this,t,r,i)}},wrap:function(t,n){n=n||{};var i=n.expiresAt||n.expiresIn||n.ttl;return i&&(i instanceof Date&&(i=i.getTime()),e.object.isString(i)&&(i=/^\d+$/.test(i)?parseInt(i,10):e.date.timeFromISO(i).getTime()),String(i).length<13&&(i=this.currentTime()+i)),{data:t,expiresAt:i}},currentTime:function(){return e.date.now()}}),e.emitter=e.model.extend("emitter",{init:function(){this._super({triggeredEvents:[],eventCallbacks:{}})},debug:function(t){this.isDebugging=t||void 0===t},hasEvent:function(t){return!!~this.get("triggeredEvents").indexOf(t)},_on:function(t,n,i,r){i=i||{},this.getOrSet("eventCallbacks."+t,[])[r](e.object.merge({fn:n},i))},_once:function(t,e,n,i){return n=n||{},n.immediate&&this.hasEvent(t)?void e():void this._on(t,e,{onceOnly:!0},i)},on:function(t,e,n){this._on(t,e,n,"push")},prepend:function(t,e,n){this._on(t,e,n,"unshift")},once:function(t,e,n){this._once(t,e,n,"push")},prependOnce:function(t,e,n){this._once(t,e,n,"unshift")},fire:function(){var t=e.array.from(arguments),n=t.shift(),i=this.get("eventCallbacks."+n),r=!1;this.isDebugging&&this.app.debug(n),i&&i.forEach(function(e,n){e.fn.apply(null,t),e.onceOnly&&(r=!0,e[n]=void 0)}),r&&this.set("eventCallbacks."+n,e.array.compact(this.get("eventCallbacks."+n))),this.hasEvent(n)||this.get("triggeredEvents").push(n)},fireSequence:function(t,n){var i=e.string.modularize("before_"+t),r=e.string.modularize("after_"+t),a=e.string.modularize("around_"+t);this.fire(i),this.fireAround(a,function(){n&&n(),this.fire(t),this.fire(r)}.bind(this))},fireAround:function(t,n){var i,r=this.get("eventCallbacks."+t)||[],a=!1;i=r.map(function(t,e){return t.onceOnly&&(a=!0,t[e]=void 0),t.fn}),a&&this.set("eventCallbacks."+t,e.array.compact(this.get("eventCallbacks."+t))),this.hasEvent(t)||this.get("triggeredEvents").push(t),e.fn.async(i,n)}}),e.errorHandler=e.model.extend("errorHandler",{init:function(t){this._super({responseCodeHandlers:{}},{app:t})},xhrData:function(t){return t.data=t.data||(t.status?JSON.parse(t.response):{})},errorMessagesFromRequest:function(t){var n,i=this.xhrData(t),r=e.array.map(i.errors||[],"message");return r=e.array.compact(r,!0),n=this.app.i18n.t("app.errors."+t.status,{"default":r}),this.app.debug(r),e.array.from(n)},getResponseCodeHandler:function(t){return this.get("responseCodeHandlers."+t)},handleXhrError:function(t){var e=this.getResponseCodeHandler(t.status.toString());e?e.call(t,t):this.notifyErrors(t)},notifyErrors:function(t){var e=this.app.notifier,n=this.errorMessagesFromRequest(t);n.length&&(e.clear("error"),setTimeout(function(){e.notify(n,"error",1e4)},100))},registerHandler:function(t,e){this.set("responseCodeHandlers."+t.toString(),e)},reportError:function(t,e){e=e||{},e.prefix&&"message"in t&&(t.message=e.prefix+" "+t.message),e.prefix&&"name"in t&&(t.name=e.prefix+" "+t.name),this._reportError(t,e)},_reportError:function(t){this.app.debug(t)}}),e.formView=e.activeView.extend("formView",{init:function(t){t=this.normalizeFormOptions(t),this._super(t),this.model=this.model||new e.model({}),this.model.validates||this.model.reopen(e.mixins.validatable)},setup:function(){this.emitter.once("setup",this.setupFormBindings.bind(this)),this._super()},applyFieldsToModel:function(t){var e=this.formData(t);this.model.sets(e)},formData:function(t){var n=e.array.map(this.options.fields,"name");return n.push(t),this.parseFields.apply(this,n)},handleErrors:function(){},normalizeFormOptions:function(t){return t=t||{},t.fields=t.fields||[],t.fields.forEach(function(t){if(t=e.object.isString(t)?{name:t}:t||{},!t.name)throw new Error("A `name` property must be provided for all fields.");t.binding=t.binding||{},t.binding.attr=t.binding.attr||t.name}),t},setupFormBindings:function(){var t;this.on("submit",this.options.formSel||"form",this.validateAndSubmitForm.bind(this)),this.options.fields.forEach(function(e){this.bind(e.binding),t=e.validation,t&&(t={},t[e.name]=e.validation,this.model.validates(t))}.bind(this))},submissionData:function(){var t=e.array.map(this.options.fields,"name");return this.model.gets(t)},submitForm:function(t){var n=this.submissionData(t);app.ajax.ajax(e.object.merge({url:t.getAttribute("action"),verb:t.getAttribute("method")||"post",data:n},this.options.ajax))},validateAndSubmitForm:function(t){t.preventDefault(),this.applyFieldsToModel(t.delegateTarget),this.model.validateAll(function(e){e?this.submitForm(t.delegateTarget):this.handleErrors()}.bind(this),this.options.validateImmediately)}},e.mixins.bindings),e.helpers=e.model.extend("helpers",{init:function(t){this._super({},{app:t});var n=this.app.i18n;this.register("t",n.t.bind(n)),this.register("l",n.l.bind(n)),this.register("timeago",n.timeago.bind(n)),this.register("path",this.app.router.path.bind(this.app.router)),this.register("get",e.object.getPath)},register:function(t,e){return this[t]||(this[t]=e),this.set(t,e)},provide:function(){return this.data}}),e.i18n=e.model.extend("i18n",{init:function(t){this._super(e.object.merge({},e.i18n.defaultTranslations),{app:t})},_ampm:function(t){return this.t("app.time.meridiems."+(t>=12?"pm":"am"))},_countAlias:{0:"zero",1:"one","-1":"negone"},_dayName:function(t){return this.t("app.time.day_names."+t)},_hour:function(t){return t>12&&(t-=12),t||(t+=12),t},_monthName:function(t){return this.t("app.time.month_names."+t)},_nestedTranslate:function(t,e){return t.replace(/\$\{([^\}]+)\}/,function(t,n){return this.translate(n,e)}.bind(this))},_normalizedDate:function(t){return String(t).match(/^\d+$/)?(t=parseInt(t,10),String(t).length<13&&(t*=1e3),t=new Date(t)):t=e.object.isString(t)?e.date.timeFromISO(t):new Date(t),t},_shortDayName:function(t){return this.t("app.time.short_day_names."+t)||this._dayName(t).slice(0,3)},_shortMonthName:function(t){return this.t("app.time.short_month_names."+t)||this._monthName(t).slice(0,3)},_pad:function(t,e,n,i){var r="",a=e-t.toString().length;for(void 0===n&&(n=" ");a>0;)r+=i?n+r:r+n,a-=1;return r+t.toString()},_ordinal:function(t){var e=t%100;return e=e>=11&&13>=e?0:t%10,this.t("app.time.ordinals.o"+e)},_timezoneAbbr:function(t){var e=t&&t.toString();return e&&e.split(/\((.*)\)/)[1]},_utc:function(t){var e=new Date(t.getTime());return e.setMinutes(e.getMinutes()+e.getTimezoneOffset()),e},keyCheck:/^\.(.+)$/,attempt:function(t){var e=t&&t.match(this.keyCheck);return e?this.t(e[1],{"default":t}):t},load:function(t,n){var i=n?e.object.merge:e.object.deepMerge;i.call(null,this.data,t)},translate:function(){var t,n=e.array.from(arguments),i=n.shift(),r=e.object.isObject(n[0])?n.shift():void 0,a=this.get(i);if(e.object.has(r,"count")&&e.object.isObject(a)&&(t=(r.count||0).toString(),t=this._countAlias[t]||(t>0?"other":"negother"),a=void 0===a[t]?a.other:a[t]),!a){if(!r||!r.hasOwnProperty("default"))return this.app.debug("Translation not found: "+i),"";a=e.fn.valueFrom(r["default"])}return e.object.isString(a)&&(a=-1===a.indexOf("${")?a:this._nestedTranslate(a,r),a=-1===a.indexOf("%{")?a:e.string.expand(a,r)),n.length&&(n.unshift(a),a=e.string.change.apply(null,n)),a},timeago:function(t,e,n){t=this._normalizedDate(t).getTime()/1e3,e=this._normalizedDate(e||new Date).getTime()/1e3;var i,r=e-t;return n=n||"app",60>r?this.t(n+".timeago.now",{count:r}):3600>r?(i=Math.floor(r/60),this.t(n+".timeago.minutes",{count:i})):86400>r?(i=Math.floor(r/3600),this.t(n+".timeago.hours",{count:i})):604800>r?(i=Math.floor(r/86400),this.t(n+".timeago.days",{count:i})):2592e3>r?(i=Math.floor(r/604800),this.t(n+".timeago.weeks",{count:i})):31594125>r?(i=Math.floor(r/2629800),this.t(n+".timeago.months",{count:i})):(i=Math.floor(r/31557600),this.t(n+".timeago.years",{count:i}))},strftime:function(t,e){t=this._normalizedDate(t),~e.indexOf("%")||(e=this.t("app.time.formats."+e));var n=t.getDay(),i=t.getDate(),r=t.getFullYear(),a=t.getMonth()+1,o=t.getHours(),s=this._hour(o),h=this._ampm(o),u=t.getSeconds(),c=t.getMinutes(),l=t.getMilliseconds(),d=t.getTimezoneOffset(),f=Math.floor(Math.abs(d/60)),p=Math.abs(d)-60*f,m=(d>0?"-":"+")+this._pad(f,2,"0")+this._pad(p,2,"0");return e=e.replace("%a",this._shortDayName(n)).replace("%A",this._dayName(n)).replace("%B",this._monthName(a-1)).replace("%b",this._shortMonthName(a-1)).replace("%d",this._pad(i,2,"0")).replace("%e",this._pad(i,2," ")).replace("%-do",i+this._ordinal(i)).replace("%-d",i).replace("%H",this._pad(o,2,"0")).replace("%k",this._pad(o,2," ")).replace("%-H",o).replace("%-k",o).replace("%I",this._pad(s,2,"0")).replace("%l",s).replace("%m",this._pad(a,2,"0")).replace("%-m",a).replace("%M",this._pad(c,2,"0")).replace("%p",h.toUpperCase()).replace("%P",h).replace("%S",this._pad(u,2,"0")).replace("%-S",u).replace("%L",this._pad(l,3,"0")).replace("%-L",l).replace("%w",n).replace("%y",this._pad(r%100)).replace("%Y",r).replace("%z",m).replace("%:z",m.slice(0,3)+":"+m.slice(3)).replace("%Z",this._timezoneAbbr(t))}}),e.i18n.prototype.t=e.i18n.prototype.translate,e.i18n.prototype.l=e.i18n.prototype.strftime,e.i18n.defaultTranslations={app:{timeago:{now:"just now",minutes:{one:"%{count} minute ago",other:"%{count} minutes ago"},hours:{one:"%{count} hour ago",other:"%{count} hours ago"},days:{one:"%{count} day ago",other:"%{count} days ago"},weeks:{one:"%{count} week ago",other:"%{count} weeks ago"},months:{one:"%{count} month ago",other:"%{count} months ago"},years:{one:"%{count} year ago",other:"%{count} years ago"}},time:{formats:{isoDate:"%Y-%m-%d",isoTime:"%Y-%m-%dT%H:%M:%S.%L%:z",shortDate:"%m/%d/%Y",longDate:"%B %-do, %Y"},meridiems:{am:"am",pm:"pm"},ordinals:{o0:"th",o1:"st",o2:"nd",o3:"rd",o4:"th",o5:"th",o6:"th",o7:"th",o8:"th",o9:"th"},day_names:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],short_day_names:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],month_names:["January","February","March","April","May","June","July","August","September","October","November","December"],short_month_names:["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"]},validations:{ccNumber:"does not look like a credit card number",ccSecurity:"is not a valid security code",ccExpirationMonth:"is not a valid expiration month",ccExpirationYear:"is not a valid expiration year",chosen:"must be chosen",date:"is not a valid date",email:"must be a valid email",format:"is invalid",integer:"must be an integer",length:"length must be",number:"must be a number",phone:"is not a valid phone number",presence:"can't be blank",url:"must be a valid url",range_messages:{eq:"equal to %{count}",lt:"less than %{count}",gt:"greater than %{count}",lte:"less than or equal to %{count}",gte:"greater than or equal to %{count}"}}}},e.list=e.model.extend("list",{init:function(t,e){t=t||[],this._super({items:t},e)},_normalizedIndex:function(t){return t=parseInt(t,10),!isNaN(t)&&0>t&&(t+=this.data.items.length),t},_trackMutations:function(t,e){var n=this.data.items.length,i=[e.call()],r=this.data.items.length;return n!==r&&i.push({name:"length",type:"update",object:this.data.items,oldValue:n,value:r}),this.changeRecords=this.changeRecords.concat(i),t&&t.skipObservers?this:this.deliverChangeRecords()},forEach:function(t){return this.get("items").forEach(t)},get:function(t){var n,i=this._normalizedIndex(t);return n=isNaN(i)?t:"items."+i,e.model.prototype.get.call(this,n)},indexOf:function(t){return this.get("items").indexOf(t)},insert:function(t,e,n){var i=this._normalizedIndex(t);return this._trackMutations(n,function(){var t={name:String(i),object:this.data.items,type:"add",oldValue:this.data.items[i],value:e};return this.data.items.splice(i,0,e),t}.bind(this))},length:function(){return this.get("items.length")},push:function(t,e){return this._trackMutations(e,function(){var e={name:String(this.data.items.length),object:this.data.items,type:"add",value:t,oldValue:void 0};return this.data.items.push(t),e}.bind(this))},remove:function(t,e){var n=this._normalizedIndex(t);return this._trackMutations(e,function(){var t={name:String(n),object:this.data.items,type:"delete",oldValue:this.data.items[n],value:void 0};return this.data.items.splice(n,1),t}.bind(this))},set:function(t,n,i){var r=this._normalizedIndex(t);return isNaN(r)?e.model.prototype.set.call(this,t,n,i):this._trackMutations(i,function(){var t={name:String(r),object:this.data.items,type:"update",oldValue:this.data.items[r]};return this.data.items[r]=t.value=n,t}.bind(this))},shift:function(t){return this._trackMutations(t,function(){var t={name:"0",object:this.data.items,type:"delete"};return t.oldValue=this.data.items.shift(),t.value=this.data.items[0],t}.bind(this))},unshift:function(t,e){return this.insert(0,t,e)}}),e.navigator=e.model.extend("navigator",{init:function(t){this.app=t,this._super({})},go:function(n,i,r){var a=n;return i=i||{},this.get("path")===n&&this.get("query")===i?this:(Object.keys(i).length&&(a+="?",a+=e.object.serialize(i)),t.history[r?"replaceState":"pushState"]({},document.title,a),void t.historyObserver())},start:function(){return t.historyObserver||(t.historyObserver=function(){e.dom.trigger(t,"pieHistoryChange")}),e.dom.on(t,"popstate",function(){t.historyObserver()}),e.dom.on(t,"pieHistoryChange.nav-"+this.pieId,this.setDataFromLocation.bind(this)),this.setDataFromLocation()},setDataFromLocation:function(){var n=t.location.search.slice(1),i=e.string.deserialize(n);this.sets({url:t.location.href,path:t.location.pathname,fullPath:e.array.compact([t.location.pathname,n],!0).join("?"),query:i})}}),e.notifier=e.base.extend("notifier",{init:function(t,n){this.options=n||{},this.app=t||this.options.app||e.appInstance,this.notifications=new e.list([])},clear:function(t){if(t)this.notifications.forEach(function(t){this.remove(t.id)}.bind(this));else for(;this.notifications.length();)this.remove(this.notifications.get(0).id)},notify:function(t,n,i){n=n||"message",i=this.getAutoRemoveTimeout(i),t=e.array.from(t),t=t.map(this.app.i18n.attempt.bind(this.app.i18n));var r={id:e.unique(),messages:t,type:n};this.notifications.push(r),i&&setTimeout(function(){this.remove(r.id)}.bind(this),i)},getAutoRemoveTimeout:function(t){return void 0===t&&(t=!0),t&&!e.object.isNumber(t)&&(t=7e3),t},remove:function(t){var n=e.array.indexOf(this.notifications.get("items"),function(e){return e.id===t});~n&&this.notifications.remove(n)}}),e.resources=e.model.extend("resources",{init:function(t,e){this._super({srcMap:e||{},loaded:{}},{app:t})},_appendNode:function(t){var e=document.querySelector("head");e=e||document.body,e.appendChild(t)},_inferredResourceType:function(t){return/(\.|\/)js(\?|$)/.test(t)?"script":/(\.|\/)css(\?|$)/.test(t)?"link":"ajax"},_normalizeSrc:function(t){var n="string"==typeof t?{src:t}:e.object.merge({},t);return n},_loadajax:function(t,n){var i=e.object.merge({verb:"GET",url:t.src},t,{success:n});this.app.ajax.ajax(i)},_loadscript:function(t,e){var n=document.createElement("script");t.noAsync&&(n.async=!1),t.callbackName||(n.onload=e),this._appendNode(n),n.src=t.src},_loadlink:function(t,e){var n=document.createElement("link");n.href=t.src,n.media=t.media||"screen",n.rel=t.rel||"stylesheet",n.type=t.contentType||"text/css",this._appendNode(n),e()},define:function(t,e){var n=this._normalizeSrc(e);this.set("srcMap."+t,n)},load:function(){var n,i=e.array.change(e.array.from(arguments),"flatten","compact"),r=e.object.isFunction(e.array.last(i))?i.pop():function(){};i=i.map(this._normalizeSrc.bind(this)),n=i.map(function(e){e=this.get("srcMap."+e.src)||e;var n=e.src,i="loaded."+n;return function(n){if(this.get(i)===!0)return n(),!0;if(this.get(i))return this.get(i).push(n),!1;this.set(i,[n]);var r=e.type||this._inferredResourceType(e.src),a=function(){this.get(i).forEach(function(t){t&&t()}),this.set(i,!0),e.callbackName&&delete t[e.callbackName]}.bind(this);return e.callbackName&&(t[e.callbackName]=a),this["_load"+r](e,a),!1}.bind(this)}.bind(this)),e.fn.async(n,r)}}),e.route=e.model.extend("route",{init:function(t,n){this._super({pathTemplate:e.string.normalizeUrl(t)},n),this.name=this.options.name,this.compute("splitPathTemplate","pathTemplate"),this.compute("pathRegex","pathTemplate")},splitPathTemplate:function(){return this.get("pathTemplate").split("/")},pathRegex:function(){return new RegExp("^"+this.get("pathTemplate").replace(/(:[^\/]+)/g,"([^\\/]+)")+"$")},interpolations:function(t,n){for(var i=t.split("/"),r={},a=0;a<i.length;a++)/^:/.test(this.get("splitPathTemplate."+a))&&(r[this.get("splitPathTemplate."+a).replace(/^:/,"")]=i[a]);return n&&(r=e.string.deserialize(e.object.serialize(r),!0)),r},isDirectMatch:function(t){return t===this.get("pathTemplate")},isMatch:function(t){return this.get("pathRegex").test(t)},path:function(t,n){var i,r,a=[],o=this.get("pathTemplate");return t=t||{},o=o.replace(/\:([a-zA-Z0-9_]+)/g,function(e,n){if(a.push(n),void 0===t[n]||null===t[n]||0===t[n].toString().length)throw new Error("[PIE] missing route interpolation: "+e);return t[n]}),o=e.string.normalizeUrl(o),r=e.object.except(t,a),i=e.object.serialize(e.object.compact(r,!0)),!n&&i.length&&(o=e.string.urlConcat(o,i)),o}}),e.router=e.model.extend("router",{init:function(t){this._super({routes:[],routeNames:{},root:t.options.root||"/",cache:{}},{app:t}),this.compute("rootRegex","root")},rootRegex:function(){return new RegExp("^"+this.get("root"))},changedUrl:function(t){var n=this.app.parsedUrl;return this.path(n.route&&n.route.name||n.path,e.object.merge({},n.data,t))},findRoute:function(t){var n=this.get("routeNames."+t);return n=n||e.array.detect(this.get("routes"),function(e){return e.isDirectMatch(t)}),n=n||e.array.detect(this.get("routes"),function(e){return e.isMatch(t)})},route:function(t,n){n=n||{};var i,r,a;e.object.forEach(t,function(t,o){e.object.isObject(o)?(i=t,r=o):(i=o,r={name:t}),n&&(r=e.object.merge({},n,r)),a=new e.route(i,r),this.get("routes").push(a),a.name&&this.set("routeNames."+a.name,a)}.bind(this)),this.sortRoutes(),this.set("cache",{})},path:function(t,n,i){var r=this.findRoute(t)||new e.route(t),a=r.path(n,i);return e.string.PROTOCOL_TEST.test(a)||this.get("rootRegex").test(a)||(a=this.get("root")+a,a=e.string.normalizeUrl(a)),a},sortRoutes:function(){var t,e,n,i=Array(0);this.get("routes").sort(function(r,a){return r=r.get("pathTemplate"),a=a.get("pathTemplate"),t=(r.match(/:/g)||i).length,e=(a.match(/:/g)||i).length,n=t-e,n=n||a.length-r.length,n=n||(e>t?1:t>e?-1:0)})},parseUrl:function(t,n){var i=this.get("cache")[t];if(i)return i;var r,a,o,s,h;return r=t.split("?"),t=r.shift(),t=t.replace(this.get("rootRegex"),""),t=e.string.normalizeUrl(t),a=r.join("&")||"",o=this.findRoute(t),a=e.string.deserialize(a,n),s=e.array.compact([t,e.object.serialize(a)],!0).join("?"),h=o&&o.interpolations(t,n),i=e.object.merge({path:t,fullPath:s,interpolations:h||{},query:a,data:e.object.merge({},h,a),route:o},o&&o.options),this.get("cache")[t]=i,i}}),e.templates=e.model.extend("templates",{init:function(t){this._super({},{app:t})},_node:function(t){return document.querySelector(this.app.options.templateSelector+'[id="'+t+'"]')},_registerTemplate:function(t,n){this.app.debug("Compiling and storing template: "+t);var i="var h = pie.apps["+this.app.pieId+"].helpers.provide();";i+="var get = function(p){ return pie.object.getPath(data, p); };",Object.keys(this.app.helpers.provide()).forEach(function(t){i+="var "+t+" = h."+t+";"}),this.set(t,e.string.template(n,i))},load:function(t,e){var n=this._node(t),i=n&&n.getAttribute("data-src")||t;this.app.resources.load({type:"ajax",accept:"text/html",src:i,dataSuccess:function(e){this._registerTemplate(t,e)}.bind(this),error:function(){throw new Error("[PIE] Template fetch error: "+t)}},e)},render:function(t,e){if(!this.get(t)){var n=this._node(t);if(!n)throw new Error("[PIE] Unknown template error: "+t);this._registerTemplate(t,n.content||n.textContent)}return this.get(t)(e||{})},renderAsync:function(t,e,n){if(this.get(t)){var i=this.render(t,e);return void n(i)}this.load(t,function(){this.renderAsync(t,e,n)}.bind(this))}}),e.validator=e.base.extend("validator",function(){var t=function(t,e,n,i,r){for(i=+t[e=t.length-1],r=0;e--;)n=+t[e],i+=++r%2?2*n%10+(n>4):n;return!(i%10)};return{init:function(t){this.app=t||e.appInstance,this.i18n=t.i18n},errorMessage:function(t,n){if(n.message)return this.app.i18n.attempt(n.message);var i=this.i18n.t("app.validations."+t),r=new e.validator.rangeOptions(this.app,n),a=r.message();return a||"length"!==t||(r=new e.validator.rangeOptions(this.app,{gt:0}),a=r.message()),(i+" "+a).trim()},withStandardChecks:function(t,e,n){return e=e||{},e.allowBlank&&!this.presence(t)?!0:e.unless&&e.unless.call()?!0:e["if"]&&!e["if"].call()?!0:n.call()},ccNumber:function(e,n){return this.withStandardChecks(e,n,function(){var n=String(e).replace(/[^a-zA-Z0-9]/g,"");return this.number(n)&&this.length(n,{gte:10,lte:16})&&t(n)}.bind(this))},ccExpirationMonth:function(t,e){return this.withStandardChecks(t,e,function(){return this.integer(t,{gte:1,lte:12})}.bind(this))},ccExpirationYear:function(t,e){return this.withStandardChecks(t,e,function(){var e=new Date;return this.integer(t,{gte:e.getFullYear(),lte:e.getFullYear()+20})}.bind(this))},ccSecurity:function(t,e){return this.withStandardChecks(t,e,function(){return this.number(t)&&this.length(t,{gte:3,lte:4})}.bind(this))},chosen:function(t,e){return this.presence(t,e)},date:function(t,n){return n=n||{},this.withStandardChecks(t,n,function(){var i,r=t.split("-"),a=r[0],o=r[1],s=r[2];if(!a||!o||!s)return!1;if(!this.length(a,{eq:4})&&this.length(o,{eq:2})&&this.length(s,{eq:2}))return!1;n.sanitized||(Object.keys(n).forEach(function(t){i=n[t],i=this.app.i18n.l(i,"isoDate"),n[t]=i}),n.sanitized=!0);var h=new e.validator.rangeOptions(this.app,n);return h.matches(t)}.bind(this))},email:function(t,n){return n=e.object.merge({allowBlank:!1},n||{}),this.withStandardChecks(t,n,function(){return/^.+@.+\..+$/.test(t)})},fn:function(t,e,n){return this.withStandardChecks(t,e,function(){return e.fn.call(null,t,e,n)})},format:function(t,e){return e=e||{},this.withStandardChecks(t,e,function(){var n=e.format||e["with"];return"isoDate"===n?n=/^\d{4}\-\d{2}\-\d{2}$/:"epochs"===n?n=/^\d{10}$/:"epochms"===n&&(n=/^\d{13}$/),!!n.test(String(t))})},integer:function(t,e){return this.withStandardChecks(t,e,function(){return this.number(t,e)&&parseInt(t,10)===parseFloat(t,10)}.bind(this))},length:function(t,n){return n=e.object.merge({allowBlank:!1},n),"gt"in n||"gte"in n||"lt"in n||"lte"in n||"eq"in n||(n.gt=0),this.withStandardChecks(t,n,function(){var e=String(t).trim().length;return this.number(e,n)}.bind(this))},number:function(t,n){return n=n||{},this.withStandardChecks(t,n,function(){if(!/^([\-])?([\d]+)?\.?[\d]+$/.test(String(t)))return!1;var i=parseFloat(t),r=new e.validator.rangeOptions(this.app,n);return r.matches(i)})},phone:function(t,n){return n=e.object.merge({allowBlank:!1},n||{}),this.withStandardChecks(t,n,function(){var e=String(t).replace(/[^\+\d]+/g,"");return this.length(e,{gte:10})}.bind(this))},presence:function(t,n){return this.withStandardChecks(t,e.object.merge({},n,{allowBlank:!1}),function(){return!(!t||!/[^ ]/.test(String(t)))})},url:function(t,e){return this.withStandardChecks(t,e,function(){return/^.+\..+$/.test(t)})}}}()),e.validator.rangeOptions=e.base.extend("rangeOptions",{init:function(t,e){this.i18n=t.i18n,this.rangedata=e||{},this.rangedata.rangedata&&(this.rangedata=this.rangedata.rangedata)},get:function(t){return e.fn.valueFrom(this.rangedata[t])},has:function(t){return!!(t in this.rangedata)},t:function(t,e){return this.i18n.t("app.validations.range_messages."+t,e)},matches:function(t){var e=!0;return e=e&&(!this.has("gt")||t>this.get("gt")),e=e&&(!this.has("lt")||t<this.get("lt")),e=e&&(!this.has("gte")||t>=this.get("gte")),e=e&&(!this.has("lte")||t<=this.get("lte")),e=e&&(!this.has("eq")||t===this.get("eq"))},message:function(){if(this.has("eq"))return this.t("eq",{count:this.get("eq")});var t=["",""];return this.has("gt")?t[0]+=this.t("gt",{count:this.get("gt")}):this.has("gte")&&(t[0]+=this.t("gte",{count:this.get("gte")})),this.has("lt")?t[1]+=this.t("lt",{count:this.get("lt")}):this.has("lte")&&(t[1]+=this.t("lte",{count:this.get("lte")})),e.array.toSentence(e.array.compact(t,!0),this.i18n).trim()}}),e.abstractViewTransition=e.base.extend("abstractViewTransition",{init:function(t,n){if(n=n||{},this.emitter=new e.emitter,this.parent=t,this.oldChild=n.oldChild,this.newChild=n.newChild,this.childName=n.childName||this.oldChild&&this.oldChild._nameWithinParent,this.targetEl=n.targetEl||this.oldChild&&this.oldChild.el.parentNode,!this.childName)throw new Error("No child name provided for view transition");if(!this.targetEl)throw new Error("No target element provided for view transition");this.options=n,this.emitter.on("beforeTransition",this.manageChildren.bind(this))},transition:function(t){var e=this.emitter;e.on("afterAddNewChild",function(){e.fire("afterTransition"),t&&t()}),e.on("afterRemoveOldChild",function(){e.fire("beforeAddNewChild"),e.fireAround("aroundAddNewChlid",function(){e.fire("addNewChild")})}),e.on("transition",function(){e.fire("beforeRemoveOldChild"),e.fireAround("aroundRemoveOldChild",function(){e.fire("removeOldChild")})}),e.fire("beforeTransition"),e.fireAround("aroundTransition",function(){e.fire("transition")})},manageChildren:function(){this.oldChild&&this.parent.removeChild(this.oldChild),this.newChild&&(this.parent.addChild(this.childName,this.newChild),this.newChild.setup())}}),e.simpleViewTransition=e.abstractViewTransition.extend("simpleViewTransition",{init:function(){this._super.apply(this,arguments),this.emitter.on("removeOldChild",this.removeOldChild.bind(this)),this.emitter.on("addNewChild",this.addNewChild.bind(this))},addNewChild:function(){this.newChild?this.newChild.emitter.once("afterSetup",function(){this.newChild.appendToDom(this.targetEl),this.emitter.fire("afterAddNewChild")}.bind(this),{immediate:!0}):this.emitter.fire("afterAddNewChild")},removeOldChild:function(){this.oldChild&&this.oldChild.teardown(),this.emitter.fire("afterRemoveOldChild")}}),e.loadingViewTransition=e.simpleViewTransition.extend("loadingViewTransition",{init:function(){this._super.apply(this,arguments),this.options.loadingClass=this.options.loadingClass||"is-loading"},setLoading:function(t){this.targetEl.classList[t?"add":"remove"](this.options.loadingClass)},addNewChild:function(){return this.newChild?(this.begin=e.date.now(),this.setLoading(!0),this.options.minDelay&&setTimeout(this.attemptToAddChild.bind(this),this.options.minDelay),void this.newChild.emitter.once("afterSetup",function(){this.attemptToAddChild(!0)}.bind(this),{immediate:!0})):void this.emitter.fire("afterAddNewChild")},attemptToAddChild:function(t){var n=e.date.now();(t||this.newChild.emitter.hasEvent("afterSetup"))&&(!this.options.minDelay||n>=this.begin+this.options.minDelay)&&(this.newChild.emitter.hasEvent("removedFromParent")||(this.setLoading(!1),this.newChild.appendToDom(this.targetEl),this.emitter.fire("afterAddNewChild")))}}),e.inOutViewTransition=e.abstractViewTransition.extend("inOutViewTransition",{init:function(){this._super.apply(this,arguments),this.options=e.object.merge({inClass:"view-in",outClass:"view-out",backupDuration:250,async:!1},this.options),this.setupObservations()},setupObservations:function(){var t=this.emitter;this.oldChild?(t.on("transitionOldChild",this.cancelWrap("transitionOldChild")),t.on("afterTransitionOldChild",this.cancelWrap("teardownOldChild"))):t.on("transitionOldChild",function(){t.fire("afterTransitionOldChild")}),this.newChild?(t.on("addNewChild",this.cancelWrap("addNewChild")),t.on("aroundTransitionNewChild",this.cancelWrap("ensureNewChildPrepared")),t.on("transitionNewChild",this.cancelWrap("refresh")),t.on("transitionNewChild",this.cancelWrap("transitionNewChild")),this.newChild.emitter.once("removedFromParent",this.cancel.bind(this))):t.on("transitionNewChild",function(){t.fire("afterTransitionNewChild")
})},cancelWrap:function(t){return function(){this.emitter.hasEvent("cancel")||this[t].apply(this,arguments)}.bind(this)},applyClass:function(t,e){var n=e?this.options.inClass:this.options.outClass,i=e?this.options.outClass:this.options.inClass;n&&t.classList.add(n),i&&t.classList.remove(i)},transition:function(t){var e=this.emitter;e.on("afterTransitionNewChild",function(){e.fire("afterTransition"),t&&t()}),this.options.async?e.on("transition",function(){e.fireSequence("addNewChild")}):e.on("afterRemoveOldChild",function(){e.fireSequence("addNewChild")}),e.on("afterAddNewChild",function(){e.fire("beforeTransitionNewChild"),e.fireAround("aroundTransitionNewChild",function(){e.fire("transitionNewChild")})}),e.on("afterTransitionOldChild",function(){e.fireSequence("removeOldChild")}),e.on("transition",function(){e.fire("beforeTransitionOldChild"),e.fireAround("aroundTransitionOldChild",function(){e.fire("transitionOldChild")})}),e.fire("beforeTransition"),e.fireAround("aroundTransition",function(){e.fire("transition")})},cancel:function(){this.emitter.hasEvent("afterTransitionNewChild")||(this.oldChild&&this.teardownOldChild(),this.newChild&&(this.applyClass(this.newChild.el,!0),this.newChild.appendToDom(this.targetEl)),this.emitter.fire("cancel"))},teardownOldChild:function(){this.oldChild.emitter.hasEvent("beforeTeardown")||this.oldChild.teardown()},addNewChild:function(){this.applyClass(this.newChild.el,!1),this.newChild.appendToDom(this.targetEl)},ensureNewChildPrepared:function(t){this.newChild.emitter.once("afterRender",t,{immediate:!0})},transitionNewChild:function(){this.observeTransitionEnd(this.newChild.el,!0,"afterTransitionNewChild")},transitionOldChild:function(){this.oldChild.el.parentNode?this.observeTransitionEnd(this.oldChild.el,!1,"afterTransitionOldChild"):this.emitter.fire("afterTransitionOldChild")},observeTransitionEnd:function(t,n,i){var r=this.transitionEndEvent(),a=!1,o=function(){a||(a=!0,r&&e.dom.off(t,r,o),this.emitter.fire(i))}.bind(this);if(this.emitter.once("cancel",o),r&&e.dom.on(t,r,o),this.applyClass(t,n),r){var s=this.determineBackupDuration(t);isNaN(s)||setTimeout(o,1.1*s)}else setTimeout(o,this.options.backupDuration)},transitionEndEvent:function(){return void 0===this._transitionEndEvent&&(this._transitionEndEvent="ontransitionend"in t?"transitionend":"onwebkittransitionend"in t?"webkitTransitionEnd":"msTransitionEnd"in t?"msTransitionEnd":"onotransitionend"in document.body||"Opera"===navigator.appName?"oTransitionEnd":!1),this._transitionEndEvent},transitionProperty:function(t){var n=this.transitionEndEvent();return n&&n.replace(/end/i,e.string.capitalize(t))},refresh:function(t){this.oldChild&&this.oldChild.el.getBoundingClientRect(),this.newChild&&this.newChild.el.getBoundingClientRect(),t&&t()},determineBackupDuration:function(e){var n,i,r=this.transitionProperty("duration"),a=this.transitionProperty("delay"),o=t.getComputedStyle(e);return n=parseInt(o[r].toLowerCase(),10),i=parseInt(o[a].toLowerCase(),10),r.indexOf("ms")<0&&(n=1e3*n,i=1e3*i),n+i}}),"function"==typeof define&&define.amd?define(function(){return e}):t.pie=e}(this);