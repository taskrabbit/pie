sudo.templateSettings={evaluate:/\[%([\s\S]+?)%\]/g,interpolate:/\[%=([\s\S]+?)%\]/g,escape:/\[%-([\s\S]+?)%\]/g},window.pie={array:{},date:{},func:{},math:{},object:{},string:{},inheritance:{},services:{},uid:0,unique:function(){return this.uid++},util:{}},pie.array.compact=function(e,t){return e.filter(function(e){return t?!!e:void 0!==e&&null!==e})},pie.array.dup=function(e){return e.slice(0)},pie.array.remove=function(e,t){for(var i;~(i=e.indexOf(t));)e.splice(i,1);return e},pie.array.sum=function(e){var t=0;return e.forEach(function(e){t+=parseFloat(e)}),t},pie.array.avg=function(e){var t=pie.array.sum(e),i=e.length;return t/i},pie.array.subtract=function(e,t){return e.filter(function(e){return t.indexOf(e)<0})},pie.array.intersect=function(e,t){return e.filter(function(e){return-1!==t.indexOf(e)})},pie.array.last=function(e){return e&&e.length?e[e.length-1]:void 0},pie.array.from=function(e){return Array.isArray(e)?e:pie.array.compact([e],!1)},pie.array.grep=function(e,t){return e.filter(function(e){return t.test(e.toString())})},pie.array.flatten=function(e,t){return t=t||[],Array.isArray(e)?e.forEach(function(e){pie.array.flatten(e,t)}):t.push(e),t},pie.array.map=function(e,t,i){var r,n=[];return r="function"!=typeof t?function(e){var r=e[t];return i&&"function"==typeof r?r.apply(e):r}:t,e.forEach(function(e){n.push(r(e))}),n},pie.array.sortBy=function(e,t){var i,r;return e.sort(function(e,n){return i=pie.func.valueFrom(e[t]),r=pie.func.valueFrom(n[t]),i===r?0:r>i?-1:1})},pie.array.detect=function(e,t){for(var i=0,r=e.length;r>i;i++)if("function"==typeof t){if(t(e[i]))return e[i]}else if(e[i]&&pie.func.valueFrom(e[i][t]))return e[i]},pie.array.args=function(e){return Array.prototype.slice.call(e)},pie.array.uniq=function(e){return e.filter(function(t,i){return e.indexOf(t)===i})},pie.array.union=function(){var e=pie.array.compact(pie.array.args(arguments),!0),t=e.shift();return t?(t=pie.array.dup(t),e.forEach(function(e){e.forEach(function(e){~t.indexOf(e)&&t.push(e)})}),t):[]},pie.array.toSentence=function(e){return e.length?(e.length>2&&(e=[e.slice(0,e.length-1).join(", "),e.slice(e.length-1)]),e.join(" and ")):void 0},pie.date.dateFromISO=function(e){if(!e)return null;var t=e.split("T")[0].split("-");return new Date(t[0],t[1]-1,t[2])},pie.date.timeFromISO=function(e){return e?e.indexOf("T")<0?pie.date.dateFromISO(e):new Date(e):null},pie.func.debounce=function(e,t,i){var r;return function(){var n=this,o=arguments,a=function(){r=null,i||e.apply(n,o)},s=i&&!r;clearTimeout(r),r=setTimeout(a,t),s&&e.apply(n,o)}},pie.func.valueFrom=function(e){return"function"==typeof e?e():e},pie.math.precision=function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},pie.object.slice=function(){var e={},t=1,i=arguments,r=i[0];for(Array.isArray(i[1])&&(i=i[1],t=0);t<i.length;t++)r.hasOwnProperty(i[t])&&(e[i[t]]=r[i[t]]);return e},pie.object.except=function(){var e={},t=pie.array.args(arguments),i=t[0];return t=pie.array.flatten(t.splice(1)),Object.keys(i).forEach(function(r){t.indexOf(r)<0&&(e[r]=i[r])}),e},pie.object.compact=function(e,t){var i=pie.util.extend({},e);return Object.keys(i).forEach(function(e){(void 0===i[e]||null===i[e]||t&&0===i[e].toString().length)&&delete i[e]}),i},pie.object.values=function(e){var t=[];return Object.keys(e).forEach(function(i){t.push(e[i])}),t},pie.object.forEach=function(e,t){Object.keys(e).forEach(function(i){t(i,e[i])})},pie.string.expand=function(e,t){return t=t||{},e.replace(/\%\{(.+?)\}/g,function(e,i){return t[i]})},pie.string.change=function(){var e=Array.args(arguments),t=e[0];return e=e.slice(1),e.forEach(function(e){t=pie.string[e](t)}),t},pie.string.urlConcat=function(){var e=pie.array.compact(pie.array.args(arguments),!0),t=e.shift(),i=e.join("&");return i.length?(t.indexOf("?")<0&&(t+="?"),0===i.indexOf("?")&&(i=i.replace("?","&")),t+=i,t=t.replace("?&","?").replace("&&","&").replace("??","?"),t.indexOf("?")===t.length-1&&(t=t.substr(0,t.length-1)),t):t},pie.string.escape=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},pie.string.underscore=function(e){return e.replace(/([a-z])([A-Z])/g,function(e,t,i){return t+"_"+i.toLowerCase()}).toLowerCase()},pie.string.humanize=function(e){return e.replace(/_id$/,"").replace(/([a-z][A-Z]|[a-z]_[a-z])/g,function(e,t){return t[0]+" "+t[t.length-1]})},pie.string.titleize=function(e){return e.replace(/(^| )([a-z])/g,function(e,t,i){return t+i.toUpperCase()})},pie.string.pluralize=function(e){return/ss$/i.test(e)?e+"es":/s$/i.test(e)?e:/[a-z]$/i.test(e)?e+"s":e},pie.string.capitalize=function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},pie.string.lowerize=function(e){return e.charAt(0).toLowerCase()+e.slice(1)},pie.string.modularize=function(e){return e.replace(/([^_])_([^_])/g,function(e,t,i){return t+i.toUpperCase()})},pie.util.createElement=function(){return $.createElement.apply(null,arguments).q[0]},pie.util.deepExtend=function(){function e(e){r[e]=e in r&&"object"==typeof r[e]?pie.util.deepExtend(r[e],t[e]):t[e]}for(var t,i=pie.array.args(arguments),r=i.shift();i.length&&(t=i.shift());)Object.keys(t).forEach(e);return r},pie.util.deserialize=$.deserialize,pie.util.extend=$.extend,pie.util.getPath=sudo.getPath,pie.util.serialize=$.serialize,pie.util.setPath=sudo.setPath,pie.util.template=sudo.template,pie.inheritance={_super:function(){for(var e,t=pie.array.args(arguments),i=t.shift(),r=this;;){if(e=Object.getPrototypeOf(r),e===r)return;if(e[i]&&e[i]!==this[i])return e[i].apply(this,t);r=e}}},pie.container={addChild:function(e,t){var i,r=this.children(),n=this.childNames();return r.push(t),i=r.length-1,n[e]=i,t._indexWithinParent=i,t._nameWithinParent=e,"addedToParent"in t&&t.addedToParent.call(t,this),this},addChildren:function(e){pie.object.forEach(e,function(e,t){this.addChild(e,t)}.bind(this))},childNames:function(){return this._childNames=this._childNames||[]},children:function(){return this._children=this._children||[]},getChild:function(e){var t=e._nameWithinParent||e,i=this.childNames()[t]||e;return~i&&this.children()[i]||void 0},removeChild:function(e){var t,i=this.getChild(e),r=this.childNames(),n=this.children();if(i){for(t=i._indexWithinParent,delete r[i._nameWithinParent],n.splice(t,1);t<n.length;t++)n[t]._indexWithinParent=t;"removedFromParent"in i&&i.removedFromParent.call(i,this)}return this},removeChildren:function(){for(var e,t=this.children();e=t[t.length-1];)this.removeChild(e);return this}},pie.model=function(e){this.data={},this.uid=pie.unique(),this.observations={},this.changeRecords=[],this.sets(e||{})},pie.util.extend(pie.model.prototype,pie.inheritance),pie.model.prototype.deliverChangeRecords=function(){for(var e,t,i;t=this.changeRecords.shift();)for(e=pie.array.union(this.observations[t.name],this.observations.__all__);i=e.shift();)i.call(null,t);return this},pie.model.prototype.get=function(e){return this.data[e]},pie.model.prototype.gets=function(){var e=pie.array.args(arguments);return e=pie.array.flatten(e),e=pie.array.compact(e),e.unshift(this.data),pie.object.slice.apply(null,e)},pie.model.prototype.observe=function(){var e=pie.array.args(arguments),t=e.shift();return e.length||e.push("__all__"),e.forEach(function(e){this.observations[e]=this.observations[e]||[],this.observations[e].indexOf(t)<0&&this.observations[e].push(t)}.bind(this)),this},pie.model.prototype.set=function(e,t,i){var r={name:e,object:this.data};return e in this.data?(r.type="update",r.oldValue=this.data[e]):r.type="add",this.data[e]=t,this.changeRecords.push(r),i?this:this.deliverChangeRecords()},pie.model.prototype.sets=function(e,t){return pie.object.forEach(e,function(e,t){this.set(e,t,!0)}.bind(this)),t?this:this.deliverChangeRecords()},pie.model.prototype.unobserve=function(){var e,t=pie.array.args(arguments),i=t.shift();return t.length||(t=Object.keys(this.observations)),t.forEach(function(t){e=this.observations[t].indexOf(i),~e&&this.observations[t].splice(e,1)}.bind(this)),this},pie.view=function(e,t){this.el=e||pie.util.createElement("<div />"),this.uid=pie.unique(),this.options=t,this.changeCallbacks=[]},pie.util.extend(pie.view.prototype,pie.container),pie.view.prototype.addedToParent=function(){return this},pie.view.prototype.eventNamespace=function(){return"view"+this.uid},pie.view.prototype.loadingStyle=function(e){void 0===e&&(e=!0),this._loadingStyle(e)},pie.view.prototype.navigationUpdated=function(){this.children.forEach(function(e){"navigationUpdated"in e&&e.navigationUpdated()})},pie.view.prototype.on=function(e,t,i){var r=this.eventNamespace(),n=function(e){return e.namespace===r?i.apply(this,arguments):void 0};return e.split(" ").forEach(function(e){e+="."+r,$(this.el).on(e,n,t)}.bind(this)),this},pie.view.prototype.onChange=function(){var e,t=arguments[0],i=arguments[1],r=pie.array.args(arguments).slice(2);if(!("observe"in t))throw new Error("Observable does not respond to observe");e=function(e){(!r.length||~r.indexOf(e.name))&&e.oldValue!==e.object[e.name]&&i(e)},this.changeCallbacks.push([t,e]),t.observe(e)},pie.view.prototype.parseFields=function(){var e,t,i={},r=arguments[0],n=0;for("string"==typeof r?r=this.el:n++;n<arguments.length;n++)e=arguments[n],t=r.querySelector('[name="'+e+'"]:not([disabled])'),t&&pie.util.setPath(e,t.value,i);return i},pie.view.prototype.qs=function(e){return this.el.querySelector(e)},pie.view.prototype.qsa=function(e){return this.el.querySelectorAll(e)},pie.view.prototype.removedFromParent=function(){return this._unobserveEvents(),this._unobserveChangeCallbacks(),this.removeChildren(),this},pie.view.prototype.removeLoadingStyle=function(){this._loadingStyle(!1)},pie.view.prototype._unobserveEvents=function(){$(this.el).off("*."+this.eventNamespace()),$(document.body).off("*."+this.eventNamespace())},pie.view.prototype._unobserveChangeCallbacks=function(){for(var e;this.changeCallbacks.length;)e=this.changeCallbacks.pop(),e[0].unobserve(e[1])},pie.view.prototype._loadingStyle=function(e){this.el.classList[e?"add":"remove"]("loading"),$(this.qsa(".submit-container button.btn-primary, .btn-loading, .btn-loadable")).all(e?"classList.add":"classList.remove","btn-loading").all(e?"setAttribute":"removeAttribute","disabled","disabled")},pie.services.ajax=function(e){this.app=e,this.defaultAjaxOptions={}},pie.services.ajax.prototype._defaultAjaxOptions=function(){return $.extend({},this.defaultAjaxOptions,{dataType:"json",type:"GET",error:this.app.errorHandler.handleXhrError})},pie.services.ajax.prototype.ajax=function(e){if(e=pie.object.compact(e),e=pie.util.extend({},this._defaultAjaxOptions(),e),e.extraError){var t=e.error;e.error=function(i){t(i),e.extraError(i)}}var i,r=this.app,n=new XMLHttpRequest,o=e.url;return o="GET"===e.type&&e.data?r.router.path(o,e.data):r.router.path(o),e.progress?n.addEventListener("progress",e.progress,!1):e.uploadProgress&&n.upload.addEventListener("progress",e.uploadProgress,!1),n.open(e.type,o,!0),n.setRequestHeader("Accept","application/json"),n.setRequestHeader("Content-Type","application/json"),this._applyCsrfToken(n),n.onload=function(){e.tracker&&e.tracker(this);try{this.data=this.responseText.trim().length?JSON.parse(this.responseText):{}}catch(t){r.debug("could not parse JSON response: "+t),this.data={}}this.status>=200&&this.status<300||304===this.status?(e.dataSuccess&&e.dataSuccess(this.data),e.success&&e.success(this.data,this)):e.error&&e.error(this),e.complete&&e.complete(this)},"GET"!==e.type&&(i=e.data?"string"==typeof e.data?e.data:JSON.stringify(pie.object.compact(e.data)):void 0),n.send(i),n},pie.services.ajax.prototype.get=function(e){return e=pie.util.extend({type:"GET"},e),this.ajax(e)},pie.services.ajax.prototype.post=function(e){return e=pie.util.extend({type:"POST"},e),this.ajax(e)},pie.services.ajax.prototype.put=function(e){return this.post($.extend({type:"PUT"},e))},pie.services.ajax.prototype.del=function(e){return this.post($.extend({type:"DELETE"},e))},pie.services.ajax.prototype._applyCsrfToken=function(e){var t=document.querySelector('meta[name="csrf-token"]'),i=t?t.getAttribute("content"):null;i&&e.setRequestHeader("X-CSRF-Token",i)},pie.services.errorHandler=function(e){this.app=e,this.responseCodeHandlers={}},pie.services.errorHandler.prototype.data=function(e){return e.data=e.data||(e.status?JSON.parse(e.response):{})},pie.services.errorHandler.prototype.errorMessagesFromRequest=function(e){var t,i=this.data(e),r=pie.array.map(i.errors||[],"message");return r=pie.array.compact(r,!0),t=this.app.i18n.t("app.errors."+e.status,{"default":r}),this.app.debug(r),pie.array.from(t)},pie.services.errorHandler.prototype.handleXhrError=function(e){var t=this.responseCodeHandlers[e.status.toString()];t?t.call(e,e):this.notifyErrors(e)},pie.services.errorHandler.prototype.notifyErrors=function(e){var t=this.app.notifier,i=this.errorMessagesFromRequest(e);i.length&&(t.clear(),setTimeout(function(){t.clear("error"),t.notify(i,"error",1e4)},100))},pie.services.errorHandler.prototype.registerHandler=function(e,t){this.responseCodeHandlers[e.toString()]=t},pie.services.errorHandler.prototype.reportError=function(e,t){t=t||{},t.prefix&&"message"in e&&(e.message=t.prefix+" "+e.message),t.prefix&&"name"in e&&(e.name=t.prefix+" "+e.name),this._reportError(e,t)},pie.services.errorHandler.prototype._reportError=function(e){this.app.debug(e)},pie.services.i18n=function(e){this.translations={},this.app=e},pie.services.i18n.prototype._ampm=function(e){return e>=12?"pm":"am"},pie.services.i18n.prototype._countAlias={0:"zero",1:"one","-1":"negone"},pie.services.i18n.prototype._dayName=function(e){return this.t("app.time.day_names."+e)},pie.services.i18n.prototype._hour=function(e){return e>12&&(e-=12),e||(e+=12),e},pie.services.i18n.prototype._isoDate=function(e,t){return t&&(e=this._utc(e)),e.getFullYear()+"-"+this._pad(e.getMonth()+1,2,"0")+"-"+this._pad(e.getDate(),2,"0")},pie.services.i18n.prototype._isoTime=function(e){return e=this._utc(e),this._pad(e.getHours(),2,"0")+":"+this._pad(e.getMinutes(),2,"0")+":"+this._pad(e.getSeconds(),2,"0")+"."+this._pad(e.getMilliseconds(),3,"0")+"Z"},pie.services.i18n.prototype._monthName=function(e){return this.t("app.time.month_names."+e)},pie.services.i18n.prototype._normalizedDate=function(e){return String(e).match(/^\d+$/)?(e=parseInt(e,10),String(e).length<13&&(e*=1e3),e=new Date(e)):e="string"==typeof e?pie.date.timeFromISO(e):new Date(e),e},pie.services.i18n.prototype._shortDayName=function(e){return this.t("app.time.short_day_names."+e)||this._dayName(e).slice(0,3)},pie.services.i18n.prototype._shortMonthName=function(e){return this.t("app.time.short_month_names."+e)||this._monthName(e).slice(0,3)},pie.services.i18n.prototype._pad=function(e,t,i){var r="",n=t-e.toString().length;for(void 0===i&&(i=" ");n>0;)r+=i,n-=1;return r+e.toString()},pie.services.i18n.prototype._timezoneAbbr=function(e){var t=e&&e.toString();return t&&t.split(/\((.*)\)/)[1]},pie.services.i18n.prototype._utc=function(e){var t=new Date(e.getTime());return t.setMinutes(t.getMinutes()+t.getTimezoneOffset()),t},pie.services.i18n.prototype.load=function(e,t){var i=t?pie.util.extend:pie.util.deepExtend;i.call(null,this.translations,e)},pie.services.i18n.prototype.translate=function(e,t){var i,r=pie.util.getPath(e,this.translations);return t&&t.hasOwnProperty("count")&&"object"==typeof r&&(i=(t.count||0).toString(),i=this._countAlias[i]||(i>0?"other":"negother"),r=void 0===r[i]?r.other:r[i]),r?"string"==typeof r?-1===r.indexOf("%{")?r:pie.string.expand(r,t):r:t&&t.hasOwnProperty("default")?t.default:(this.app.debug("Translation not found: "+e),"")},pie.services.i18n.prototype.timeago=function(e,t,i){e=this._normalizedDate(e).getTime()/1e3,t=this._normalizedDate(t||new Date).getTime()/1e3;var r,n=t-e;return i=i||"app",60>n?this.t(i+".timeago.now",{count:n}):3600>n?(r=Math.floor(n/60),this.t(i+".timeago.minutes",{count:r})):86400>n?(r=Math.floor(n/3600),this.t(i+".timeago.hours",{count:r})):604800>n?(r=Math.floor(n/86400),this.t(i+".timeago.days",{count:r})):2592e3>n?(r=Math.floor(n/604800),this.t(i+".timeago.weeks",{count:r})):31594125>n?(r=Math.floor(n/2629800),this.t(i+".timeago.months",{count:r})):(r=Math.floor(n/31557600),this.t(i+".timeago.years",{count:r}))},pie.services.i18n.prototype.strftime=function(e,t){e=this._normalizedDate(e),t&&"%"!==t.charAt(0)&&(t=this.t("app.time.formats."+t));var i=e.getDay(),r=e.getDate(),n=e.getFullYear(),o=e.getMonth()+1,a=e.getHours(),s=this._hour(a),p=this._ampm(a),u=e.getSeconds(),c=e.getMinutes(),h=e.getTimezoneOffset(),l=Math.floor(Math.abs(h/60)),d=Math.abs(h)-60*l,f=(h>0?"-":"+")+this._pad(l,2,"0")+this._pad(d,2,"0");return t=t.replace("%a",this._shortDayName(i)).replace("%A",this._dayName(i)).replace("%b",this._shortMonthName(o-1)).replace("%d",this._pad(r,2,"0")).replace("%e",this._pad(r,2," ")).replace("%-d",r).replace("%H",this._pad(a,2,"0")).replace("%k",a).replace("%I",this._pad(s,2,"0")).replace("%l",s).replace("%m",this._pad(o,2,"0")).replace("%-m",o).replace("%M",this._pad(c,2,"0")).replace("%p",p.toUpperCase()).replace("%P",p).replace("%S",this._pad(u,2,"0")).replace("%-S",u).replace("%w",i).replace("%y",this._pad(n%100)).replace("%Y",n).replace("%z",f).replace("%Z",this._timezoneAbbr(e))},pie.services.i18n.prototype.t=pie.services.i18n.prototype.translate,pie.services.i18n.prototype.l=pie.services.i18n.prototype.strftime,pie.services.navigator=function(e){this.app=e,pie.model.prototype.constructor.call(this,{})},pie.services.navigator.prototype=Object.create(pie.model.prototype),pie.services.navigator.prototype.go=function(e,t,i){var r=e;return t=t||{},this.get("path")===e&&this.get("query")===t?this:(Object.keys(t).length&&(r+="?",r+=$.serialize(t)),window.history[i?"replaceState":"pushState"]({},document.title,r),this.setDataFromLocation())},pie.services.navigator.prototype.start=function(){return this.setDataFromLocation()},pie.services.navigator.prototype.setDataFromLocation=function(){var e=window.location.search.slice(1);return e=pie.util.deserialize(e),this.sets({url:window.location.href,path:window.location.pathname,query:e}),this},pie.services.notifier=function(e){pie.view.prototype.constructor.call(this),this.app=e,this.notifications={}},pie.services.notifier.prototype=Object.create(pie.view.prototype),pie.services.notifier.prototype.addedToParent=function(){this.on("click",".page-alert",this.handleAlertClick.bind(this))},pie.services.notifier.prototype.clear=function(e){if(e)for(var t=this.notifications[e]||[];t.length;)this.remove(t[t.length-1]);else for(;this.el.childNodes.length;)this.remove(this.el.childNodes[0])},pie.services.notifier.prototype.notify=function(e,t,i){t=t||"message",i=this.getAutoCloseTimeout(i),e=pie.array.from(e);var r=this.app.template("alert",{type:t,messages:e});r=pie.util.createElement(r),this.notifications[t]=this.notifications[t]||[],this.notifications[t].push(r),r._pieNotificationType=t,this.el.insertBefore(r,this.el.firstElementChild),i&&setTimeout(function(){this.remove(r)}.bind(this),i)},pie.services.notifier.prototype.getAutoCloseTimeout=function(e){return void 0===e&&(e=!0),e&&"number"!=typeof e&&(e=7e3),e},pie.services.notifier.prototype.remove=function(e){var t=e._pieNotificationType;t&&pie.array.remove(this.notifications[t]||[],e),$(e).remove()},pie.services.notifier.prototype.handleAlertClick=function(e){this.remove(e.delegateTarget),e.preventDefault()},pie.services.router=function(e){this.app=e,this.routes={},this.namedRoutes={}},pie.services.router.prototype.changedUrl=function(e){var t=this.app.parsedUrl;return this.router.path(t.name||t.path,pie.util.extend({},t.interpolations,t.query,e))},pie.services.router.prototype.normalizePath=function(e){if("/"!==e.charAt(0)&&(e="/"+e),e.indexOf("?")>0){var t=e.split("?");e=this.normalizePath(t.shift()),t.unshift(e),e=t.join("?")}return"#"===e.charAt(e.length-1)&&(e=e.substr(0,e.length-1)),"/"===e.charAt(e.length-1)&&(e=e.substr(0,e.length-1)),e},pie.services.router.prototype.route=function(e,t){t=t||{},delete this._routeKeys,pie.object.forEach(e,function(e,i){"object"==typeof i?(e=this.normalizePath(e),this.routes[e]=pie.util.extend({},t,i),i.hasOwnProperty("name")&&(this.namedRoutes[i.name]=e)):this.namedRoutes[e]=i}.bind(this))},pie.services.router.prototype.path=function(e,t,i){var r,n,o=this.namedRoutes[e],a="string"==typeof o?o:e,s=[];return t=t||{},a=this.normalizePath(a),a=a.replace(/\:([a-zA-Z0-9_]+)/g,function(e,i){if(s.push(i),void 0===t[i]||null===t[i]||0===t[i].toString().length)throw new Error("[PIE] missing route interpolation: "+e);return t[i]}),n=pie.object.except(t,s),r=pie.util.serialize(pie.object.compact(n,!0)),!i&&r.length&&(a=pie.string.urlConcat(a,r)),a},pie.services.router.prototype.routeKeys=function(){if(this._routeKeys)return this._routeKeys;this._routeKeys=Object.keys(this.routes);var e,t,i,r=[];return this._routeKeys.sort(function(n,o){return e=(n.match(/:/g)||r).length,t=(o.match(/:/g)||r).length,i=e-t,i=i||o.length-n.length,i=i||(t>e?1:e>t?-1:0)}),this._routeKeys},pie.services.router.prototype.parseUrl=function(e){var t,i,r,n,o,a,s,p,u,c=this.routeKeys(),h=0;if(u=e.split("?"),e=u.shift(),e=this.normalizePath(e),a=u.join("&")||"",e.length>1&&"/"===e[e.length-1]&&(e=e.slice(0,-1)),r=this.routes[e],s={},n=e.split("/"),r)r=pie.util.extend({routeKey:e},r);else for(;h<c.length&&!r;)if(i=c[h],"object"==typeof this.routes[i]){if(this.routes[i].regex=this.routes[i].regex||new RegExp("^"+i.replace(/(:[^\/]+)/g,"([^\\/]+)")+"$"),this.routes[i].regex.test(e))for(r=pie.util.extend({routeKey:i},this.routes[i]),o=i.split("/"),t=0;t<o.length;t++)/^:/.test(o[t])&&(s[o[t].replace(/^:/,"")]=n[t],r[o[t]]=n[t]);h++}else h++;return a=pie.util.deserialize(a),p=pie.array.compact([e,pie.util.serialize(a)],!0).join("?"),pie.util.extend({interpolations:s,path:e,query:a,fullPath:p},r)},pie.app=function(e){this.options=pie.util.deepExtend({uiTarget:"body",viewNamespace:"lib.views",notificationUiTarget:".notification-container",navigatorOptions:{root:"/"}},e);var t=function(e,t){var i=this.options[e]||t;return new i(this)}.bind(this);this.i18n=t("i18n",pie.services.i18n),this.addChild("i18n",this.i18n),this.ajax=t("ajax",pie.services.ajax),this.addChild("ajax",this.ajax),this.notifier=t("notifier",pie.services.notifier),this.addChild("notifier",this.notifier),this.errorHandler=t("errorHandler",pie.services.errorHandler),this.addChild("errorHandler",this.errorHandler),this.router=t("router",pie.services.router),this.addChild("router",this.router),this.navigator=t("navigator",pie.services.navigator),this.addChild("navigator",this.navigator),this.models={},this._templates={},this.parsedUrl={},this.eventCallbacks={},this.triggeredEvents=[],this.navigator.observe(this.navigationChanged.bind(this),"url"),this.on("beforeStart",this.showStoredNotifications.bind(this)),this.on("beforeStart",this.setupSinglePageLinks.bind(this)),this.on("beforeStart",this.setupNotifier.bind(this)),document.addEventListener("DOMContentLoaded",this.start.bind(this))},pie.util.extend(pie.app.prototype,pie.container),pie.app.prototype.confirm=function(e){window.confirm(e.text)?e.success&&e.success():e.failure&&e.failure()},pie.app.prototype.debug=function(e){"production"!==this.env&&console&&console.log&&console.log("[PIE] "+e)},pie.app.prototype.go=function(){var e,t,i,r,n=pie.array.args(arguments);e=n.shift(),"string"==typeof n[0]&&0===n[0].indexOf("?")?(e=this.router.path(e),r=n.shift(),e=pie.string.urlConcat(this.router.path(e),r)):e="object"==typeof n[0]?this.router.path(e,n.shift()):this.router.path.apply(this.router,pie.array.from(e)),(n[0]===!0||n[0]===!1)&&(i=n.shift()),t=n,this.router.parseUrl(e).hasOwnProperty("view")?(this.navigator.go(e,i),t&&t.length&&this.notifier.notify.apply(this.notifier,t)):(t&&t.length&&this.store(this.notifier.storageKey,t),window.location.href=e)},pie.app.prototype.goBack=function(){window.history.back()},pie.app.prototype.handleSinglePageLinkClick=function(e){if(!e.delegateTarget.getAttribute("target")&&!e.ctrlKey&&!e.metaKey){var t=e.delegateTarget.getAttribute("href");t&&"#"!==t&&("?"===t.charAt(0)&&(t=window.location.pathname+t),e.preventDefault(),this.go(t))}},pie.app.prototype.navigationChanged=function(){var e=document.querySelector(this.options.uiTarget),t=this.getChild("currentView");if(this.previousUrl=this.parsedUrl,this.parsedUrl=this.router.parseUrl(this.navigator.get("url")),this.previousUrl!==this.parsedUrl&&this.trigger("urlChanged"),this.parsedUrl.view){if(t&&t._pieName===this.parsedUrl.view)return void("navigationUpdated"in t&&t.navigationUpdated());t&&(this.removeChild(t),t.el.parentNode&&t.el.parentNode.removeChild(t.el),this.on("oldViewRemoved")),this.notifier.clear();var i,r=pie.util.getPath(this.viewNamespace+"."+this.parsedUrl.view,window);i=new r(this),i._pieName=this.parsedUrl.view,this.addChild("currentView",i),e.appendChild(i.el),this.models={},window.scrollTo(0,0),this.trigger("newViewLoaded")}},pie.app.prototype.on=function(e,t,i){!i&&~this.triggeredEvents.indexOf(e)?t():(this.eventCallbacks[e]=this.eventCallbacks[e]||[],this.eventCallbacks[e].push(t))},pie.app.prototype.refresh=function(){var e=this.getChild("currentView");e._pieName="__remove__",this.navigationChanged()},pie.app.prototype.retrieve=function(e,t){var i,r;try{i=window.localStorage.getItem(e),r=i?JSON.parse(i):void 0}catch(n){this.errorHandler.reportError(n,{prefix:"[caught] app#retrieve/getItem:"})}try{(t||void 0===t)&&window.localStorage.removeItem(e)}catch(n){this.errorHandler.reportError(n,{prefix:"[caught] app#retrieve/removeItem:"})}return r},pie.app.prototype.setupNotifier=function(){var e=document.querySelector(this.options.notificationUiTarget);e&&e.appendChild(this.getChild("notifier").el)},pie.app.prototype.setupSinglePageLinks=function(){$(document.body).on("click",this.handleSinglePageLinkClick.bind(this),"a[href]")},pie.app.prototype.showStoredNotifications=function(){var e,t=this.retrieve(this.notifier.storageKey);t&&(e=JSON.parse(t),this.on("afterStart",function(){this.notifier.notify.apply(this.notifier,e)}.bind(this)))},pie.app.prototype.start=function(){this.navigator.start(),this.trigger("beforeStart");var e=this.navigator.get("url");this.navigator.data.url=null,this.navigator.set("url",e),this.started=!0,this.trigger("afterStart")},pie.app.prototype.store=function(e,t){try{window.localStorage.setItem(e,JSON.stringify(t))}catch(i){this.errorHandler.reportError(i,{prefix:"[caught] app#store:"})}},pie.app.prototype.template=function(e,t){if(!this._templates[e]){var i=document.querySelector('script[id="'+e+'"][type="text/pie-template"]');if(!i)throw"[PIE] Unknown template error: "+e;this.debug("Compiling and storing template: "+e),this._templates[e]=sudo.template(i.textContent)}return t=t||{},this._templates[e](t)},pie.app.prototype.trigger=function(e){this.triggeredEvents.indexOf(e)<0&&this.triggeredEvents.push(e),(this.eventCallbacks[e]||[]).forEach(function(e){e()})};