<!DOCTYPE html>

<html>
<head>
  <title>pie.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>pie.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(window)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="pie">Pie</h1>
<p>The top level namespace of the framework.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> pie = <span class="hljs-built_in">window</span>.pie = {

  apps: {},

  <span class="hljs-comment">/* native extensions */</span>
  array: {},
  browser: {},
  date: {},
  dom: {},
  fn: {},
  math: {},
  object: {},
  string: {},

  <span class="hljs-comment">/* extensions to be used within pie apps. */</span>
  mixins: {},

  pieId: <span class="hljs-number">1</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><strong> pie.guid </strong></p>
<p>Generate a globally unique id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  guid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> r, v;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'</span>.replace(<span class="hljs-regexp">/[xy]/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span> </span>{
      r = <span class="hljs-built_in">Math</span>.random()*<span class="hljs-number">16</span>|<span class="hljs-number">0</span>,
      v = c === <span class="hljs-string">'x'</span> ? r : (r&amp;<span class="hljs-number">0x3</span>|<span class="hljs-number">0x8</span>);
      <span class="hljs-keyword">return</span> v.toString(<span class="hljs-number">16</span>);
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><strong> pie.ns </strong></p>
<p>If it’s not already present, build a path on <code>base</code>.
By default, <code>base</code> is the global <code>window</code>.
The deepest namespace object is returned so you can immediately use it.</p>
<pre><code>pie.ns(<span class="hljs-string">'lib.foo.bar'</span>).baz = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{};
<span class="hljs-comment">//=&gt; generates { lib: { foo: { bar: { baz: function(){} } } } }</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  ns: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, base)</span> </span>{
    base = base || <span class="hljs-built_in">window</span>;
    <span class="hljs-keyword">return</span> pie.object.getPath(base, path) || pie.object.setPath(base, path, {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><strong> pie.qs </strong></p>
<p>Alias for <code>document.querySelector</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  qs: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.querySelector.apply(<span class="hljs-built_in">document</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><strong> pie.qsa </strong></p>
<p>Alias for <code>document.querySelectorAll</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  qsa: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.querySelectorAll.apply(<span class="hljs-built_in">document</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><strong> pie.setUid </strong></p>
<p>Set the <code>pieId</code> of <code>obj</code> if it isn’t already present.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setUid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> obj.pieId = obj.pieId || pie.unique();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><strong> pie.unique </strong></p>
<p>Provide a unique integer not yet used by pie.
This is good for unique local ids.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unique: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>(pie.pieId++);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><strong> pie.util </strong></p>
<p>Provide a util object for your app which utilizes pie’s features.</p>
<pre><code><span class="hljs-built_in">window</span>._ = pie.util();
_.a.detect(<span class="hljs-comment">/* .. */</span>);
_.o.merge(a, b);
_.unique(); <span class="hljs-comment">//=&gt; '95'</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  util: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> o = {};

    o.a   = pie.array;
    o.b   = pie.browser;
    o.d   = pie.date;
    o.$   = pie.dom;
    o.fn  = pie.fn;
    o.m   = pie.math;
    o.o   = pie.object;
    o.s   = pie.string;
    o.x   = pie.mixins;

    o.guid    = pie.guid;
    o.ns      = pie.ns;
    o.qs      = pie.qs;
    o.qsa     = pie.qsa;
    o.setUid  = pie.setUid;
    o.unique  = pie.unique;

    <span class="hljs-keyword">return</span> o;
  }

};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h1 id="pie-array-utilities">Pie Array Utilities</h1>
<p>A series of helpful methods for working with arrays.</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><strong> pie.array.areAll </strong></p>
<p>Provides a way to test if all items of <code>a</code> match the function <code>f</code>.
Since this uses <code>pie.object.getValue</code> you can pass an attribute name for <code>f</code> as well.</p>
<pre><code>pie.array.areAll([<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>{ <span class="hljs-keyword">return</span> x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; });
<span class="hljs-comment">//=&gt; false</span>

pie.array.areAll([o1,o2], <span class="hljs-string">'computed'</span>)
<span class="hljs-comment">//=&gt; !!(o1.computed &amp;&amp; o2.computed)</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.areAll = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span>(;i &lt; a.length; i++) {
    <span class="hljs-keyword">if</span>(!pie.object.getValue(a[i], f)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><strong> pie.array.areAny </strong></p>
<p>Tests whether any items of <code>a</code> match the function <code>f</code>.
Since this uses <code>pie.object.getValue</code> you can pass an attribute name for <code>f</code> as well.</p>
<pre><code>pie.array.areAny([<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>{ <span class="hljs-keyword">return</span> x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; });
<span class="hljs-comment">//=&gt; true</span>

pie.array.areAny([o1,o2], <span class="hljs-string">'computed'</span>)
<span class="hljs-comment">// =&gt; !!(o1.computed || o2.computed)</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.areAny = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span>(;i &lt; a.length; i++) {
    <span class="hljs-keyword">if</span>(pie.object.getValue(a[i], f)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><strong> pie.array.change </strong></p>
<p>Change an array by many <code>pie.array</code> utilities.</p>
<pre><code>pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>, <span class="hljs-string">'compact'</span>, <span class="hljs-string">'unique'</span>);
<span class="hljs-comment">// is equivalent to:</span>
arr = pie.array.from(<span class="hljs-built_in">arguments</span>);
arr = pie.array.flatten(arr);
arr = pie.array.compact(arr);
arr = pie.array.unique(arr);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.change = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
  arr = args.shift();
  args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
    arr = pie.array[m](arr);
  });

  <span class="hljs-keyword">return</span> arr;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><strong> pie.array.avg </strong></p>
<p>Find the average of a series of numbers.</p>
<pre><code>pie.array.avg([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">8</span>])
<span class="hljs-comment">//=&gt; 3.8333</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.avg = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">var</span> s = pie.array.sum(a), l = a.length;
  <span class="hljs-keyword">return</span> l ? (s / l) : <span class="hljs-number">0</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><strong> pie.array.compact </strong></p>
<p>Remove all null or undefined items.
Optionally remove all falsy values by providing true for <code>removeAllFalsy</code>.</p>
<pre><code>pie.array.compact([<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>])
<span class="hljs-comment">//=&gt; [true, false, 1, 0]</span>

pie.array.compact([<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>], <span class="hljs-literal">true</span>)
<span class="hljs-comment">//=&gt; [true, 1]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.compact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, removeAllFalsy)</span></span>{
  <span class="hljs-keyword">return</span> a.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span></span>{
    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">return</span> removeAllFalsy ? !!i : (i != <span class="hljs-literal">null</span>);
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><strong> pie.array.detect </strong></p>
<p>Return the first item where the provided function evaluates to a truthy value.
If a function is not provided, the second argument will be assumed to be an attribute check.</p>
<pre><code>pie.array.detect([<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> e % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; })
<span class="hljs-comment">//=&gt; 4</span>

pie.array.detect([{foo: <span class="hljs-string">'bar'</span>}, {baz: <span class="hljs-string">'foo'</span>}], <span class="hljs-string">'baz'</span>)
<span class="hljs-comment">//=&gt; {baz: 'foo'}</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.detect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = a.length;
  <span class="hljs-keyword">for</span>(;i&lt;l;i++) {
    <span class="hljs-keyword">if</span>(pie.object.getValue(a[i], f)) {
      <span class="hljs-keyword">return</span> a[i];
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><strong> pie.array.detectLast </strong></p>
<p>Return the last item where the provided function evaluates to a truthy value.
If a function is not provided, the second argument will be assumed to be an attribute check.</p>
<pre><code>pie.array.detectLast([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> e % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; })
<span class="hljs-comment">//=&gt; 4</span>


pie.array.detectLast([{foo: <span class="hljs-string">'bar'</span>}, {baz: <span class="hljs-string">'foo'</span>}], <span class="hljs-string">'baz'</span>)
<span class="hljs-comment">//=&gt; {baz: 'foo'}</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.detectLast = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  <span class="hljs-keyword">var</span> i = a.length-<span class="hljs-number">1</span>, l = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span>(;i&gt;=l;i--) {
    <span class="hljs-keyword">if</span>(pie.object.getValue(a[i], f)) {
      <span class="hljs-keyword">return</span> a[i];
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><strong> pie.array.dup </strong></p>
<p>Return a new array containing the same values of the provided array <code>a</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.dup = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">return</span> a.slice(<span class="hljs-number">0</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><strong> pie.array.flatten </strong></p>
<p>Flattens an array of arrays or elements into a single depth array</p>
<pre><code>pie.array.flatten([<span class="hljs-string">'a'</span>, [<span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]])
<span class="hljs-comment">//=&gt; ['a', 'b', 'c']</span>
</code></pre><p>You may also restrict the depth of the flattening:</p>
<pre><code>pie.array.flatten([[<span class="hljs-string">'a'</span>], [<span class="hljs-string">'b'</span>, [<span class="hljs-string">'c'</span>]]], <span class="hljs-number">1</span>)
<span class="hljs-comment">//=&gt; ['a', 'b', ['c']]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.flatten = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, depth, into)</span> </span>{
  into = into || [];

  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(a) &amp;&amp; depth !== -<span class="hljs-number">1</span>) {

    <span class="hljs-keyword">if</span>(depth != <span class="hljs-literal">null</span>) depth--;

    a.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
      pie.array.flatten(e, depth, into);
    });

  } <span class="hljs-keyword">else</span> {
    into.push(a);
  }

  <span class="hljs-keyword">return</span> into;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><strong> pie.array.from </strong></p>
<p>Return an array from a value. if the value is an array it will be returned.
If the value is a NodeList or an HTMLCollection, you will get back an array.
If the value is undefined or null, you’ll get back an empty array.</p>
<pre><code>pie.array.from(<span class="hljs-literal">null</span>)
<span class="hljs-comment">//=&gt; []</span>

pie.array.from([<span class="hljs-string">'foo'</span>])
<span class="hljs-comment">//=&gt; ['foo']</span>

pie.array.from(<span class="hljs-string">'value'</span>)
<span class="hljs-comment">//=&gt; ['value']</span>

pie.array.from(<span class="hljs-built_in">document</span>.querySelectorAll(<span class="hljs-string">'body'</span>))
<span class="hljs-comment">//=&gt; [&lt;body&gt;]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.from = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(value)) <span class="hljs-keyword">return</span> value;
  <span class="hljs-keyword">if</span>(pie.object.isArguments(value) || value <span class="hljs-keyword">instanceof</span> NodeList || value <span class="hljs-keyword">instanceof</span> HTMLCollection) <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.prototype.slice.call(value, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> pie.array.compact([value], <span class="hljs-literal">false</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p><strong> pie.array.get </strong></p>
<p>Retrieve a value or a range of values from an array.
Negative values are allowed and are considered to be relative to the end of the array.</p>
<pre><code>arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>]
pie.array.get(arr, <span class="hljs-number">1</span>)
<span class="hljs-comment">//=&gt; 'b'</span>

pie.array.get(arr, -<span class="hljs-number">2</span>)
<span class="hljs-comment">//=&gt; 'd'</span>

pie.array.get(arr, -<span class="hljs-number">1</span>)
<span class="hljs-comment">//=&gt; 'e'</span>

pie.array.get(arr, <span class="hljs-number">1</span>, -<span class="hljs-number">2</span>)
<span class="hljs-comment">//=&gt; ['b', 'c', 'd']</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.get = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, startIdx, endIdx)</span> </span>{
  <span class="hljs-keyword">if</span>(startIdx &lt; <span class="hljs-number">0</span>) startIdx += arr.length;

  <span class="hljs-keyword">if</span>(endIdx !== <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">if</span>(endIdx &lt; <span class="hljs-number">0</span>) endIdx += arr.length;
    <span class="hljs-keyword">return</span> arr.slice(startIdx, endIdx + <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> arr[startIdx];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p><strong> pie.array.grep </strong></p>
<p>Return string based matches of <code>regex</code> from the provided array <code>arr</code>.</p>
<pre><code>arr = [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'too'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'too'</span>]
pie.array.grep(arr, <span class="hljs-regexp">/oo/</span>)
<span class="hljs-comment">//=&gt; ['foo', 'too', 'too']</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.grep = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, regex)</span> </span>{
  <span class="hljs-keyword">return</span> arr.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span></span>{ <span class="hljs-keyword">return</span> regex.test(<span class="hljs-built_in">String</span>(a)); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p><strong> pie.array.groupBy </strong></p>
<p>Construct an object of arrays representing the items grouped by <code>groupingF</code>.
The grouping function can be a function or an attribute of the objects.</p>
<pre><code>arr = [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>]
fn = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span></span>{ <span class="hljs-keyword">return</span> x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; }
pie.array.groupBy(arr, fn)
<span class="hljs-comment">//=&gt; { true : [0, 2, 4], false : [1, 3, 5] }</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.groupBy = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, groupingF)</span> </span>{
  <span class="hljs-keyword">var</span> h = {}, g;
  arr.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span></span>{

    g = pie.object.getValue(a, groupingF);

    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">if</span>(g != <span class="hljs-literal">null</span>) {
      h[g] = h[g] || [];
      h[g].push(a);
    }
  });

  <span class="hljs-keyword">return</span> h;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><strong> pie.array.indexOf </strong></p>
<p>Find the first index of the item that matches <code>f</code>.
The function <code>f</code> can be a function or an attribute.
```
arr = [{foo: true}, {bar: true}, {bar: true, foo: true}]
pie.array.indexOf(arr, ‘foo’)
//=&gt; 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.indexOf = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f)</span> </span>{
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = a.length;
  <span class="hljs-keyword">for</span>(;i&lt;l;i++) {
    <span class="hljs-keyword">if</span>(pie.object.getValue(a[i], f)) {
      <span class="hljs-keyword">return</span> i;
    }
  }

  <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><strong> pie.array.intersect </strong></p>
<p>Retrieve the intersection of two arrays <code>a</code> and <code>b</code>.</p>
<pre><code>a = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
b = [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>]
pie.array.intersect(a, b)
<span class="hljs-comment">//=&gt; [0, 2, 4]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.intersect = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> a.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span> </span>{ <span class="hljs-keyword">return</span> ~b.indexOf(i); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p><strong> pie.array.last </strong></p>
<p>Retrieve the last item of the array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.last = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr)</span> </span>{
  <span class="hljs-keyword">if</span>(arr &amp;&amp; arr.length) <span class="hljs-keyword">return</span> arr[arr.length - <span class="hljs-number">1</span>];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><strong> pie.array.map </strong></p>
<p>Return an array filled with the return values of <code>f</code>.
If f is not a function, it will be assumed to be a key of the item.
If the resulting value is a function, it can be invoked by passing true as the third argument.</p>
<pre><code>pie.array.map([<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> e.toUpperCase(); })
<span class="hljs-comment">//=&gt; ["A", "B", "C"]</span>

pie.array.map([<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>], <span class="hljs-string">'length'</span>)
<span class="hljs-comment">//=&gt; [1, 1, 1]</span>

pie.array.map([<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-string">'toFixed'</span>)
<span class="hljs-comment">//=&gt; [toFixed(){}, toFixed(){}, toFixed(){}]</span>

pie.array.map([<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-string">'toFixed'</span>, <span class="hljs-literal">true</span>)
<span class="hljs-comment">//=&gt; ["0", "1", "2"]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.map = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, f, callInternalFunction)</span></span>{
  <span class="hljs-keyword">var</span> callingF;

  <span class="hljs-keyword">if</span>(!pie.object.isFunction(f)) {
    callingF = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
      <span class="hljs-keyword">var</span> ef = e[f];

      <span class="hljs-keyword">if</span>(callInternalFunction &amp;&amp; pie.object.isFunction(ef))
        <span class="hljs-keyword">return</span> ef.apply(e);
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> ef;
    };
  } <span class="hljs-keyword">else</span> {
    callingF = f;
  }

  <span class="hljs-keyword">return</span> a.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> callingF(e); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><strong> pie.array.remove </strong></p>
<p>Remove all occurences of object <code>o</code> from array <code>a</code>.
```
a = [0, 1, 3, 5, 0, 2, 4, 0]
pie.array.remove(a, 0)
//=&gt; [1, 3, 5, 2, 4]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.remove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, o)</span> </span>{
  <span class="hljs-keyword">var</span> idx;
  <span class="hljs-keyword">while</span>(~(idx = a.indexOf(o))) {
    a.splice(idx, <span class="hljs-number">1</span>);
  }
  <span class="hljs-keyword">return</span> a;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><strong> pie.array.subtract </strong></p>
<p>Return an array that consists of any <code>a</code> elements that <code>b</code> does not contain.
```
a = [0, 1, 2, 3, 4]
b = [0, 2, 4, 6, 8]
pie.array.subtract(a, b)
//=&gt; [1, 3]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.subtract = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
  <span class="hljs-keyword">return</span> a.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span> </span>{ <span class="hljs-keyword">return</span> !~b.indexOf(i); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p><strong> pie.array.sum </strong></p>
<p>Sum the values of <code>a</code> and return a float.</p>
<pre><code>arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>]
pie.array.sum(arr)
<span class="hljs-comment">//=&gt; 8.0</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.sum = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">var</span> s = <span class="hljs-number">0</span>;
  a.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span></span>{ s += <span class="hljs-built_in">parseFloat</span>(i); });
  <span class="hljs-keyword">return</span> s;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p><strong> pie.array.sortBy </strong></p>
<p>Sort the array based on the value dictated by the function <code>sortF</code>.
The function can also be an attribute of the array’s items.</p>
<pre><code>arr = [{name: <span class="hljs-string">'Doug'</span>}, {name: <span class="hljs-string">'Alex'</span>}, {name: <span class="hljs-string">'Bill'</span>}]
pie.array.sortBy(arr, <span class="hljs-string">'name'</span>)
<span class="hljs-comment">//=&gt; [{name: 'Alex'}, {name: 'Bill'}, {name: 'Doug'}]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.sortBy = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, sortF)</span></span>{
  <span class="hljs-keyword">var</span> aVal, bVal;
  <span class="hljs-keyword">return</span> arr.sort(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> </span>{
    aVal = pie.object.getValue(a, sortF);
    bVal = pie.object.getValue(b, sortF);
    <span class="hljs-keyword">if</span>(aVal === bVal) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(aVal &lt; bVal) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p><strong> pie.array.toSentence </strong></p>
<p>Convert a series of words into a human readable sentence.
Available options:</p>
<ul>
<li><strong>i18n</strong> - the i18n instance to be used for lookups. Defaults to <code>pie.appInstance.i18n</code>.</li>
<li><strong>delimeter</strong> - the delimeter to be placed between the 0 - N-1 items. Defaults to <code>&#39;, &#39;</code>.</li>
<li><strong>conjunction</strong> - the conjunction to be placed between the last two items. Defaults to <code>&#39; and &#39;</code>.</li>
<li><strong>punctuate</strong> - the punctuation to be added to the end. If <code>true</code> is provided, a <code>&#39;.&#39;</code> will be used. Defaults to none.</li>
</ul>
<pre><code>words = [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>]
pie.array.toSentence(words)
<span class="hljs-string">"foo, bar and baz"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.toSentence = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, options)</span> </span>{
  <span class="hljs-keyword">if</span>(!arr.length) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;

  options = pie.object.merge({
    i18n: pie.object.getPath(pie, <span class="hljs-string">'appInstance.i18n'</span>)
  }, options);

  options.delimeter = options.delimeter || options.i18n &amp;&amp; options.i18n.t(<span class="hljs-string">'app.sentence.delimeter'</span>, {<span class="hljs-keyword">default</span>: <span class="hljs-string">', '</span>});
  options.conjunction = options.conjunction || options.i18n &amp;&amp; options.i18n.t(<span class="hljs-string">'app.sentence.conjunction'</span>, {<span class="hljs-keyword">default</span>: <span class="hljs-string">' and '</span>});
  options.punctuate = options.punctuate === <span class="hljs-literal">true</span> ? <span class="hljs-string">'.'</span> : options.punctuate;

  <span class="hljs-keyword">if</span>(arr.length &gt; <span class="hljs-number">2</span>) arr = [arr.slice(<span class="hljs-number">0</span>,arr.length-<span class="hljs-number">1</span>).join(options.delimeter), arr.slice(arr.length-<span class="hljs-number">1</span>)];

  <span class="hljs-keyword">var</span> sentence = arr.join(options.conjunction);
  <span class="hljs-keyword">if</span>(options.punctuate &amp;&amp; !pie.string.endsWith(sentence, options.punctuate)) sentence += options.punctuate;

  <span class="hljs-keyword">return</span> sentence;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p><strong> pie.array.union </strong></p>
<p>Return the union of N provided arrays.
a = [1, 2]
b = [2, 3, 4]
c = [3, 4, 5]
pie.array.union(a, b, c)
//=&gt; [1, 2, 3, 4, 5]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.union = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> arrs = pie.array.from(<span class="hljs-built_in">arguments</span>);
  arrs = pie.array.compact(arrs, <span class="hljs-literal">true</span>);
  arrs = pie.array.flatten(arrs);
  arrs = pie.array.unique(arrs);
  <span class="hljs-keyword">return</span> arrs;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><strong> pie.array.unique </strong></p>
<p>Remove any duplicate values from the provided array <code>arr</code>.</p>
<pre><code>arr = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>]
pie.array.unique(arr)
[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>]
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.array.unique = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr)</span> </span>{
  <span class="hljs-keyword">return</span> arr.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, i)</span></span>{ <span class="hljs-keyword">return</span> arr.indexOf(e) === i; });
};

<span class="hljs-comment">/* From old jQuery */</span>
pie.browser.agent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span>(pie.browser.__agent) <span class="hljs-keyword">return</span> pie.browser.__agent;

  <span class="hljs-keyword">var</span> ua = navigator.userAgent.toLowerCase(),
  match = <span class="hljs-regexp">/(chrome)[ \/]([\w.]+)/</span>.exec( ua ) ||
    <span class="hljs-regexp">/(webkit)[ \/]([\w.]+)/</span>.exec( ua ) ||
    <span class="hljs-regexp">/(opera)(?:.*version|)[ \/]([\w.]+)/</span>.exec( ua ) ||
    <span class="hljs-regexp">/(msie) ([\w.]+)/</span>.exec( ua ) ||
    ua.indexOf(<span class="hljs-string">"compatible"</span>) &lt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-regexp">/(mozilla)(?:.*? rv:([\w.]+)|)/</span>.exec( ua ) ||
    [];

  <span class="hljs-keyword">var</span> b = {
    browser: match[ <span class="hljs-number">1</span> ] || <span class="hljs-string">""</span>,
    version: match[ <span class="hljs-number">2</span> ] || <span class="hljs-string">"0"</span>
  };

  <span class="hljs-keyword">if</span>(b.browser) {
    b[b.browser] = <span class="hljs-literal">true</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Chrome is Webkit, but Webkit is also Safari.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> ( b.chrome ) {
    b.webkit = <span class="hljs-literal">true</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( b.webkit ) {
    b.safari = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">return</span> pie.browser.__agent = b;
};

pie.browser.getCookie = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, options)</span> </span>{
  <span class="hljs-keyword">var</span> decode = options &amp;&amp; options.raw ? <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(s)</span> </span>{ <span class="hljs-keyword">return</span> s; } : <span class="hljs-built_in">decodeURIComponent</span>,
  pairs = <span class="hljs-built_in">document</span>.cookie.split(<span class="hljs-string">'; '</span>),
  pair;

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; pairs.length; i++) {
    pair = pairs[i];
    <span class="hljs-keyword">if</span>(!pair) <span class="hljs-keyword">continue</span>;

    pair = pair.split(<span class="hljs-string">'='</span>);
    <span class="hljs-keyword">if</span>(decode(pair[<span class="hljs-number">0</span>]) === key) <span class="hljs-keyword">return</span> decode(pair[<span class="hljs-number">1</span>] || <span class="hljs-string">''</span>);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};


pie.browser.isRetina = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.devicePixelRatio &gt; <span class="hljs-number">1</span>;
};


pie.browser.isTouchDevice = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> pie.object.has(<span class="hljs-built_in">window</span>, <span class="hljs-string">'ontouchstart'</span>) ||
    (<span class="hljs-built_in">window</span>.DocumentTouch &amp;&amp; <span class="hljs-built_in">document</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">window</span>.DocumentTouch) ||
    navigator.MaxTouchPoints &gt; <span class="hljs-number">0</span> ||
    navigator.msMaxTouchPoints &gt; <span class="hljs-number">0</span>;
};

pie.browser.testMediaQuery = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(query)</span> </span>{
  query = pie.browser.mediaQueries[query] || query;
  <span class="hljs-keyword">var</span> matchMedia = <span class="hljs-built_in">window</span>.matchMedia || <span class="hljs-built_in">window</span>.msMatchMedia;
  <span class="hljs-keyword">if</span>(matchMedia) <span class="hljs-keyword">return</span> matchMedia(query).matches;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
};

pie.browser.orientation = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">window</span>.orientation) {
  <span class="hljs-keyword">case</span> <span class="hljs-number">90</span>:
  <span class="hljs-keyword">case</span> -<span class="hljs-number">90</span>:
    <span class="hljs-keyword">return</span> <span class="hljs-string">'landscape'</span>;
  <span class="hljs-keyword">default</span>:
    <span class="hljs-keyword">return</span> <span class="hljs-string">'portrait'</span>;
  }
};

pie.browser.setCookie = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, options)</span> </span>{
  options = pie.object.merge({}, options);

  <span class="hljs-comment">/* jslint eqnull:true */</span>
  <span class="hljs-keyword">if</span>(value == <span class="hljs-literal">null</span>) options.expires = -<span class="hljs-number">1</span>;

  <span class="hljs-keyword">if</span> (pie.object.isNumber(options.expires)) {
    <span class="hljs-keyword">var</span> days = options.expires;
    options.expires = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    options.expires.setDate(options.expires.getDate() + days);
  }

  value = <span class="hljs-built_in">String</span>(value);

  <span class="hljs-keyword">var</span> cookieValue = [
    <span class="hljs-built_in">encodeURIComponent</span>(key), <span class="hljs-string">'='</span>, options.raw ? value : <span class="hljs-built_in">encodeURIComponent</span>(value),
    options.expires ? <span class="hljs-string">'; expires='</span> + options.expires.toUTCString() : <span class="hljs-string">''</span>, <span class="hljs-comment">// use expires attribute, max-age is not supported by IE</span>
    options.path    ? <span class="hljs-string">'; path='</span> + options.path : <span class="hljs-string">''</span>,
    options.domain  ? <span class="hljs-string">'; domain='</span> + options.domain : <span class="hljs-string">''</span>,
    options.secure  ? <span class="hljs-string">'; secure'</span> : <span class="hljs-string">''</span>
  ].join(<span class="hljs-string">''</span>);

  <span class="hljs-built_in">document</span>.cookie = cookieValue;
  <span class="hljs-keyword">return</span> cookieValue;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>takes a iso date string and converts to a local time representing 12:00am, on that date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.date.dateFromISO = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(isoDateString)</span> </span>{
  <span class="hljs-keyword">if</span>(!isoDateString) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> parts = isoDateString.split(<span class="hljs-regexp">/T|\s/</span>)[<span class="hljs-number">0</span>].split(<span class="hljs-string">'-'</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(parts[<span class="hljs-number">0</span>], parts[<span class="hljs-number">1</span>] - <span class="hljs-number">1</span>, parts[<span class="hljs-number">2</span>]);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>current timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.date.now = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
};

<span class="hljs-comment">/**
 * STOLEN FROM HERE:
 * Date.parse with progressive enhancement for ISO 8601 &lt;https://github.com/csnover/js-iso8601&gt;
 * © 2011 Colin Snover &lt;http://zetafleet.com&gt;
 * Released under MIT license.
 */</span>

pie.date.timeFromISO = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

  <span class="hljs-keyword">var</span> numericKeys = [<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>];

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(date)</span> </span>{
    <span class="hljs-keyword">if</span>(!date) <span class="hljs-keyword">return</span> <span class="hljs-literal">NaN</span>;
    <span class="hljs-keyword">if</span>(!<span class="hljs-regexp">/T|\s/</span>.test(date)) <span class="hljs-keyword">return</span> pie.date.dateFromISO(date);

    <span class="hljs-keyword">var</span> timestamp, struct, minutesOffset = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>ES5 §15.9.4.2 states that the string should attempt to be parsed as a Date Time String Format string
before falling back to any implementation-specific date parsing, so that’s what we do, even if native
implementations could be faster
             1 YYYY                2 MM       3 DD           4 HH    5 mm       6 ss        7 msec        8 Z 9 ±    10 tzHH    11 tzmm</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> ((struct = <span class="hljs-regexp">/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/</span>.exec(date))) {</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>avoid NaN timestamps caused by “undefined” values being passed to Date.UTC</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, k; (k = numericKeys[i]); ++i) {
        struct[k] = +struct[k] || <span class="hljs-number">0</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>allow undefined days and months</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      struct[<span class="hljs-number">2</span>] = (+struct[<span class="hljs-number">2</span>] || <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>;
      struct[<span class="hljs-number">3</span>] = +struct[<span class="hljs-number">3</span>] || <span class="hljs-number">1</span>;

      <span class="hljs-keyword">if</span> (struct[<span class="hljs-number">8</span>] !== <span class="hljs-string">'Z'</span> &amp;&amp; struct[<span class="hljs-number">9</span>] !== <span class="hljs-literal">undefined</span>) {
        minutesOffset = struct[<span class="hljs-number">10</span>] * <span class="hljs-number">60</span> + struct[<span class="hljs-number">11</span>];

        <span class="hljs-keyword">if</span> (struct[<span class="hljs-number">9</span>] === <span class="hljs-string">'+'</span>) {
          minutesOffset = <span class="hljs-number">0</span> - minutesOffset;
        }
      }

      timestamp = <span class="hljs-built_in">Date</span>.UTC(struct[<span class="hljs-number">1</span>], struct[<span class="hljs-number">2</span>], struct[<span class="hljs-number">3</span>], struct[<span class="hljs-number">4</span>], struct[<span class="hljs-number">5</span>] + minutesOffset, struct[<span class="hljs-number">6</span>], struct[<span class="hljs-number">7</span>]);
    } <span class="hljs-keyword">else</span> {
      timestamp = <span class="hljs-literal">NaN</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(timestamp);
  };

})();
pie.dom._all = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(originalArgs, returnValues)</span> </span>{
  <span class="hljs-keyword">var</span> nodes = pie.array.from(originalArgs[<span class="hljs-number">0</span>]),
  meths = originalArgs[<span class="hljs-number">1</span>].split(<span class="hljs-string">'.'</span>),
  args = <span class="hljs-built_in">Array</span>.prototype.slice.call(originalArgs, <span class="hljs-number">2</span>),
  meth = meths[meths.length-<span class="hljs-number">1</span>],
  assign = <span class="hljs-regexp">/=$/</span>.test(meth),
  r, f, i, v;

  <span class="hljs-keyword">if</span>(assign) meth = meth.substr(<span class="hljs-number">0</span>,meth.length-<span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span>(returnValues) r = [];

  nodes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i &lt; meths.length-<span class="hljs-number">1</span>;i++) {
      f = e[meths[i]];
      e = pie.fn.valueFrom(f);
    }
    <span class="hljs-keyword">if</span>(assign) v = e[meth] = args[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">else</span> {
      f = e[meth];
      v = pie.fn.valueFrom(f, e, args);
    }

    <span class="hljs-keyword">if</span>(returnValues) r.push(v);
  });

  <span class="hljs-keyword">return</span> returnValues ? r : <span class="hljs-literal">undefined</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h3 id="all">all</h3>
<p>Invokes the provided method or method chain with the provided arguments to all elements in the nodeList.
Example usage:</p>
<ul>
<li>pie.dom.all(nodeList, ‘setAttribute’, ‘foo’, ‘bar’);</li>
<li>pie.dom.all(nodeList, ‘classList.add’, ‘active’);</li>
<li>pie.dom.all(nodeList, ‘clicked=’, true);</li>
</ul>
<p><code>nodeList</code> can either be a node, nodeList, or an array of nodes.
<code>methodName</code> can be a string representing a method name, an attribute, or a property. Can be chained with periods. Can end in a <code>=</code> to invoke an assignment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.all = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* nodeList, methodName[, arg1, arg2, ...] */</span>)</span> </span>{
  <span class="hljs-keyword">return</span> pie.dom._all(<span class="hljs-built_in">arguments</span>, <span class="hljs-literal">false</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Has the same method signature of <code>pie.dom.all</code> but returns the values of the result
Example usage:</p>
<ul>
<li>pie.dom.getAll(nodeList, ‘clicked’) //=&gt; [true, true, false]</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.getAll = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> pie.dom._all(<span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>create an element based on the content provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.dom.createElement = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">var</span> wrap = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
  wrap.innerHTML = str;
  <span class="hljs-keyword">return</span> wrap.removeChild(wrap.firstElementChild);
};

pie.dom.cache = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  pie.elementCache = pie.elementCache || <span class="hljs-keyword">new</span> pie.cache();
  <span class="hljs-keyword">return</span> pie.elementCache;
};

pie.dom.remove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
  pie.setUid(el);
  pie.dom.cache().del(<span class="hljs-string">'element-'</span> + el.pieId);
  <span class="hljs-keyword">if</span>(el.parentNode) el.parentNode.removeChild(el);
};


pie.dom.off = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, event, fn, selector, cap)</span> </span>{
  <span class="hljs-keyword">var</span> eventSplit = event.split(<span class="hljs-string">'.'</span>),
    namespace, all, events;

  pie.setUid(el);
  event = eventSplit.shift();
  namespace = eventSplit.join(<span class="hljs-string">'.'</span>);
  all = event === <span class="hljs-string">'*'</span>;

  events = pie.dom.cache().getOrSet(<span class="hljs-string">'element-'</span> + el.pieId + <span class="hljs-string">'.dom-events'</span>, {});

  (all ? <span class="hljs-built_in">Object</span>.keys(events) : [event]).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    pie.array.from(events[k]).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, i, ary)</span> </span>{
      <span class="hljs-keyword">if</span>(!cap &amp;&amp; (k === <span class="hljs-string">'focus'</span> || k === <span class="hljs-string">'blur'</span>) &amp;&amp; obj.sel) cap = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">if</span>((!namespace || namespace === obj.ns) &amp;&amp; (!fn || fn === obj.fn) &amp;&amp; (!selector || selector === obj.sel) &amp;&amp; (cap === obj.cap)) {
        el.removeEventListener(k, obj.cb, obj.cap);
        <span class="hljs-keyword">delete</span> ary[i];
      }

      events[k] = pie.array.compact(pie.array.from(events[k]));
    });
  });
};


pie.dom.on = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, event, fn, selector, capture)</span> </span>{
  <span class="hljs-keyword">var</span> eventSplit = event.split(<span class="hljs-string">'.'</span>),
      cb, namespace, events;

  event = eventSplit.shift();
  namespace = eventSplit.join(<span class="hljs-string">'.'</span>);
  pie.setUid(el);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>we force capture so that delegation works.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!capture &amp;&amp; (event === <span class="hljs-string">'focus'</span> || event === <span class="hljs-string">'blur'</span>) &amp;&amp; selector) capture = <span class="hljs-literal">true</span>;

  events = pie.dom.cache().getOrSet(<span class="hljs-string">'element-'</span> + el.pieId  + <span class="hljs-string">'.dom-events'</span>, {});
  events[event] = events[event] || [];

  cb = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
    <span class="hljs-keyword">var</span> targ, els;

    <span class="hljs-keyword">if</span>(namespace) {
      e.namespace = namespace;
    }

    <span class="hljs-keyword">if</span>(!selector) {
      fn.call(el, e);
    } <span class="hljs-keyword">else</span> {
      els = pie.array.from(el.querySelectorAll(selector));

      targ = pie.array.detect(els, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(qel)</span> </span>{
        <span class="hljs-keyword">return</span> qel === e.target || qel.contains(e.target);
      });

      <span class="hljs-keyword">if</span>(targ) {
        e.delegateTarget = targ;
        fn.call(targ, e);
      }
    }
  };

  events[event].push({
    ns: namespace,
    sel: selector,
    cb: cb,
    fn: fn,
    cap: capture
  });

  el.addEventListener(event, cb, capture);
  <span class="hljs-keyword">return</span> cb;
};

pie.dom.parseForm = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
  form = args.shift(),
  names = pie.array.flatten(args),
  inputs = form.querySelectorAll(<span class="hljs-string">'input[name], select[name], textarea[name]'</span>),
  o = {};

  inputs = pie.array.from(inputs);
  inputs = pie.array.groupBy(inputs, <span class="hljs-string">'name'</span>);

  pie.object.forEach(inputs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name,fields)</span> </span>{
    <span class="hljs-keyword">if</span>(names.length &amp;&amp; names.indexOf(name) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span>(!(name <span class="hljs-keyword">in</span> o)) {
      o[name] = form.querySelectorAll(<span class="hljs-string">'input[name="'</span> + name + <span class="hljs-string">'"], select[name="'</span> + name + <span class="hljs-string">'"], textarea[name="'</span> + name + <span class="hljs-string">'"]'</span>).length &gt; <span class="hljs-number">1</span> ? [] : <span class="hljs-literal">null</span>;
    }
    fields = fields.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span></span>{ <span class="hljs-keyword">return</span> f.type.toLowerCase() === <span class="hljs-string">'radio'</span> || f.type.toLowerCase() === <span class="hljs-string">'checkbox'</span> ? f.checked : <span class="hljs-literal">true</span>; });

    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(o[name])) o[name] = pie.array.map(fields, <span class="hljs-string">'value'</span>);
    <span class="hljs-keyword">else</span> o[name] = fields[<span class="hljs-number">0</span>] &amp;&amp; fields[<span class="hljs-number">0</span>].value;
  });

  <span class="hljs-keyword">return</span> o;
};

pie.dom.trigger = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, e, forceEvent)</span> </span>{

  <span class="hljs-keyword">if</span>(!forceEvent &amp;&amp; e === <span class="hljs-string">'click'</span>) <span class="hljs-keyword">return</span> el.click();

  <span class="hljs-keyword">var</span> event = <span class="hljs-built_in">document</span>.createEvent(<span class="hljs-string">'Event'</span>);
  event.initEvent(e, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">return</span> el.dispatchEvent(event);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p><strong>pie.fn.async</strong></p>
<p>Invoke all <code>fns</code> and when they have completed their execution, invoke the callback <code>cb</code>.
Each provided function is expected to invoke a callback supplied as it’s first argument.</p>
<pre><code><span class="hljs-keyword">var</span> a = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span></span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'hey'</span>); cb(); };
<span class="hljs-keyword">var</span> b = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span></span>{ app.ajax.get(...).complete(cb); };
<span class="hljs-keyword">var</span> complete = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'complete!'</span>); };

pie.fn.async([a, b], complete);
<span class="hljs-comment">//=&gt; "hey" is logged, ajax is completed, then "complete!" is logged.</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
pie.fn.async = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fns, cb, counterObserver)</span> </span>{

  <span class="hljs-keyword">if</span>(!fns.length) {
    cb();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">var</span> completeCount = fns.length,
  completed = <span class="hljs-number">0</span>,
  counter = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(counterObserver) counterObserver.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">if</span>(++completed === completeCount) cb();
  };

  fns.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn)</span> </span>{ fn(counter); });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p><strong>pie.fn.debounce</strong></p>
<p>Returns a function, that, as long as it continues to be invoked, will not
be triggered. The function will be called after it stops being called for
N milliseconds. If <code>immediate</code> is passed, trigger the function on the
leading edge, instead of the trailing.
Lifted from underscore.js</p>
<pre><code>pie.fn.debounce(submitForm, <span class="hljs-number">500</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.fn.debounce = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func, wait, immediate)</span> </span>{
  <span class="hljs-keyword">var</span> timeout, args, context, timestamp, result;

  <span class="hljs-keyword">var</span> later = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> last = pie.date.now() - timestamp;

    <span class="hljs-keyword">if</span> (last &lt; wait &amp;&amp; last &gt; <span class="hljs-number">0</span>) {
      timeout = setTimeout(later, wait - last);
    } <span class="hljs-keyword">else</span> {
      timeout = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">if</span> (!immediate) {
        result = func.apply(context, args);
        <span class="hljs-keyword">if</span> (!timeout) context = args = <span class="hljs-literal">null</span>;
      }
    }
  };

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    context = <span class="hljs-keyword">this</span>;
    args = <span class="hljs-built_in">arguments</span>;
    timestamp = pie.date.now();
    <span class="hljs-keyword">var</span> callNow = immediate &amp;&amp; !timeout;
    <span class="hljs-keyword">if</span> (!timeout) timeout = setTimeout(later, wait);
    <span class="hljs-keyword">if</span> (callNow) {
      result = func.apply(context, args);
      context = args = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">return</span> result;
  };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p><strong>pie.fn.ease</strong></p>
<p>Invoke a callback <code>cb</code> with the coordinates of an easing function.
The callback will receive the <code>y</code> &amp; <code>t</code> values where t ranges from 0 to 1 and <code>y</code> ranges
from the <code>from</code> and to the <code>to</code> options. The easing function can be described by passing
a name option which coincides with the easing functions defined in <code>pie.math</code>.</p>
<pre><code>pie.fn.ease(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(y, t)</span></span>{
  <span class="hljs-built_in">window</span>.scrollTo(<span class="hljs-number">0</span>, y);
}, { from: <span class="hljs-number">0</span>, to: <span class="hljs-number">300</span>, name: <span class="hljs-string">'easeOutCubic'</span> });
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.fn.ease = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb, o)</span> </span>{
  o = pie.object.merge({
    name: <span class="hljs-string">'linear'</span>,
    duration: <span class="hljs-number">250</span>,
    from: <span class="hljs-number">0</span>,
    to: <span class="hljs-number">1</span>
  }, o);

  <span class="hljs-keyword">if</span>(o.name === <span class="hljs-string">'none'</span>) {
    cb(o.to, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span>;
  }

  o.steps = o.steps || <span class="hljs-built_in">Math</span>.max(o.duration / <span class="hljs-number">16</span>, <span class="hljs-number">12</span>);

  <span class="hljs-comment">/* the easing function */</span>
  <span class="hljs-keyword">var</span> fn = pie.math.easing[o.name],</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>the current “time” 0 to 1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  t = <span class="hljs-number">0</span>,
  delta = (o.to - o.from),
  dt = (<span class="hljs-number">1</span> / o.steps),
  dy,
  y,
  pid,
  runner = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    dy = fn(t);
    y = o.from + (dy * delta);
    cb(y, t);
    <span class="hljs-keyword">if</span>(t &gt;= <span class="hljs-number">1</span>) clearInterval(pid);
    <span class="hljs-keyword">else</span> t += dt;
    <span class="hljs-keyword">if</span>(t &gt; <span class="hljs-number">1</span>) t = <span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>return ourself so we can invoke as part of setInterval</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> runner;
  };

  pid = setInterval(runner(), o.duration / o.steps);
  <span class="hljs-keyword">return</span> pid;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p><strong>pie.fn.once</strong></p>
<p>Only ever invoke the function <code>f</code> once. The return value will always be the same.
```
var count = 0;</p>

            </div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>var f = pie.fn.once(function(){
  count++;
  return count;
});</p>
<p>f();
//=&gt; 1
f();
//=&gt; 1
```</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.fn.once = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span> </span>{
  <span class="hljs-keyword">var</span> called = <span class="hljs-literal">false</span>,
  result;

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!called) {
      called = <span class="hljs-literal">true</span>;
      result = f();
    }

    <span class="hljs-keyword">return</span> result;
  };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p><strong>pie.fn.valueFrom</strong></p>
<p>If a function is provided, it will be invoked otherwise the provided value will be returned.</p>
<pre><code>pie.fn.valueFrom(<span class="hljs-number">4</span>)
<span class="hljs-comment">//=&gt; 4</span>
pie.fn.valueFrom(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>; });
<span class="hljs-comment">//=&gt; 5</span>
pie.fn.valueFrom(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>); }, {<span class="hljs-string">'foo'</span> : <span class="hljs-string">'bar'</span>});
<span class="hljs-comment">//=&gt; ["foo"];</span>
pie.fn.valueFrom(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(o); }, <span class="hljs-literal">null</span>, {<span class="hljs-string">'foo'</span> : <span class="hljs-string">'bar'</span>});
<span class="hljs-comment">//=&gt; ["foo"];</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.fn.valueFrom = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f, binding, args)</span> </span>{
  <span class="hljs-keyword">if</span>(pie.object.isFunction(f)) <span class="hljs-keyword">return</span> f.apply(binding, args) ;
  <span class="hljs-keyword">return</span> f;
};
pie.math.precision = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(number, places)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.round(number * <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, places)) / <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, places);
};

pie.math.easing = {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>no easing, no acceleration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  linear: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>just get us to the end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  none: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* t */</span>)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; },</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>accelerating from zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInQuad: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>decelerating to zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeOutQuad: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t*(<span class="hljs-number">2</span>-t); },</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>acceleration until halfway, then deceleration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInOutQuad: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t&lt;<span class="hljs-number">.5</span> ? <span class="hljs-number">2</span>*t*t : -<span class="hljs-number">1</span>+(<span class="hljs-number">4</span>-<span class="hljs-number">2</span>*t)*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>accelerating from zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInCubic: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>decelerating to zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeOutCubic: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> (--t)*t*t+<span class="hljs-number">1</span>; },</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>acceleration until halfway, then deceleration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInOutCubic: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t&lt;<span class="hljs-number">.5</span> ? <span class="hljs-number">4</span>*t*t*t : (t-<span class="hljs-number">1</span>)*(<span class="hljs-number">2</span>*t-<span class="hljs-number">2</span>)*(<span class="hljs-number">2</span>*t-<span class="hljs-number">2</span>)+<span class="hljs-number">1</span>; },</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>accelerating from zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInQuart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t*t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>decelerating to zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeOutQuart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>-(--t)*t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>acceleration until halfway, then deceleration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInOutQuart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t&lt;<span class="hljs-number">.5</span> ? <span class="hljs-number">8</span>*t*t*t*t : <span class="hljs-number">1</span>-<span class="hljs-number">8</span>*(--t)*t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>accelerating from zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInQuint: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t*t*t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>decelerating to zero velocity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeOutQuint: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>+(--t)*t*t*t*t; },</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>acceleration until halfway, then deceleration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeInOutQuint: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> </span>{ <span class="hljs-keyword">return</span> t&lt;<span class="hljs-number">.5</span> ? <span class="hljs-number">16</span>*t*t*t*t*t : <span class="hljs-number">1</span>+<span class="hljs-number">16</span>*(--t)*t*t*t*t; }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>deletes all undefined and null values.
returns a new object less any empty key/values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.compact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, removeEmpty)</span></span>{
  <span class="hljs-keyword">var</span> b = pie.object.merge({}, a);
  <span class="hljs-built_in">Object</span>.keys(b).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    <span class="hljs-comment">/* jslint eqnull:true */</span>
    <span class="hljs-keyword">if</span>(b[k] == <span class="hljs-literal">null</span> || (removeEmpty &amp;&amp; b[k].toString().length === <span class="hljs-number">0</span>)) <span class="hljs-keyword">delete</span> b[k];
  });
  <span class="hljs-keyword">return</span> b;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>deep merge. Does not preserve identity of inner objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.deepMerge = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
      targ = args.shift(),
      obj;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn</span><span class="hljs-params">(k)</span> </span>{

    <span class="hljs-keyword">if</span>(pie.object.has(targ, k) &amp;&amp; pie.object.isPlainObject(targ[k])) {
      targ[k] = pie.object.deepMerge({}, targ[k], obj[k]);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.isPlainObject(obj[k])) {
      targ[k] = pie.object.deepMerge({}, obj[k]);
    } <span class="hljs-keyword">else</span> {
      targ[k] = obj[k];
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>iterate over each passed in obj remaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (; args.length;) {
    obj = args.shift();
    <span class="hljs-keyword">if</span>(obj) <span class="hljs-built_in">Object</span>.keys(obj).forEach(fn);
  }
  <span class="hljs-keyword">return</span> targ;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>grab the sub-object from the provided object less the provided keys.
pie.object.except({foo: ‘bar’, biz: ‘baz’}, ‘biz’) =&gt; {‘foo’: ‘bar’}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.except = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> keys = pie.array.from(<span class="hljs-built_in">arguments</span>),
  a = keys.shift(),
  b = {};

  keys = pie.array.flatten(keys);

  <span class="hljs-built_in">Object</span>.keys(a).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
    <span class="hljs-keyword">if</span>(keys.indexOf(k) &lt; <span class="hljs-number">0</span>) b[k] = a[k];
  });

  <span class="hljs-keyword">return</span> b;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>delete a path,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.deletePath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, path, propagate)</span> </span>{

  <span class="hljs-keyword">if</span>(!~path.indexOf(<span class="hljs-string">'.'</span>)) {
    <span class="hljs-keyword">delete</span> obj[path];
  }

  <span class="hljs-keyword">var</span> steps = pie.string.pathSteps(path), attr, subObj;

  <span class="hljs-keyword">while</span>(steps.length) {
    attr = pie.array.last(steps.shift().split(<span class="hljs-string">'.'</span>));
    subObj = pie.object.getPath(obj, steps[<span class="hljs-number">0</span>]);
    <span class="hljs-keyword">if</span>(!subObj) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">delete</span> subObj[attr];
    <span class="hljs-keyword">if</span>(!propagate || <span class="hljs-built_in">Object</span>.keys(subObj).length) <span class="hljs-keyword">return</span>;
  }

};

pie.object.dup = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, deep)</span> </span>{
  <span class="hljs-keyword">return</span> pie.object[deep ? <span class="hljs-string">'deepMerge'</span> : <span class="hljs-string">'merge'</span>]({}, obj);
};

pie.object.flatten = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, object, prefix)</span> </span>{
  <span class="hljs-keyword">var</span> b = object || {};
  prefix = prefix || <span class="hljs-string">''</span>;

  pie.object.forEach(a, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
    <span class="hljs-keyword">if</span>(pie.object.isPlainObject(v)) {
      pie.object.flatten(v, b, k + <span class="hljs-string">'.'</span>);
    } <span class="hljs-keyword">else</span> {
      b[prefix + k] = v;
    }
  });

  <span class="hljs-keyword">return</span> b;
};

pie.object.isWindow = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> obj &amp;&amp; <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">"object"</span> &amp;&amp; <span class="hljs-string">"setInterval"</span> <span class="hljs-keyword">in</span> obj;
};


<span class="hljs-comment">/* From jQuery */</span>
pie.object.isPlainObject = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{

  <span class="hljs-keyword">if</span> ( !obj || !pie.object.isObject(obj) || obj.nodeType || pie.object.isWindow(obj) ) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> ( obj.constructor &amp;&amp;
    !pie.object.has(obj, <span class="hljs-string">"constructor"</span>) &amp;&amp;
    !pie.object.has(obj.constructor.prototype, <span class="hljs-string">"isPrototypeOf"</span>) ) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Own properties are enumerated firstly, so to speed up,
if last one is own, then all properties are own.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> key;
  <span class="hljs-keyword">for</span> ( key <span class="hljs-keyword">in</span> obj ) {}
  <span class="hljs-keyword">return</span> key === <span class="hljs-literal">undefined</span> || pie.object.has(obj, key);
},


[<span class="hljs-string">'Object'</span>, <span class="hljs-string">'Arguments'</span>, <span class="hljs-string">'Function'</span>, <span class="hljs-string">'String'</span>, <span class="hljs-string">'Number'</span>, <span class="hljs-string">'Date'</span>, <span class="hljs-string">'RegExp'</span>, <span class="hljs-string">'Boolean'</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
  pie.object[<span class="hljs-string">'is'</span> + name] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(obj) === <span class="hljs-string">'[object '</span> + name + <span class="hljs-string">']'</span>;
  };
});

(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">if</span>(!pie.object.isArguments(<span class="hljs-built_in">arguments</span>)) {
    pie.object.isArguments = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
      <span class="hljs-keyword">return</span> obj &amp;&amp; obj.hasOwnProperty(<span class="hljs-string">'callee'</span>);
    };
  }
})();

pie.object.isUndefined = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
  <span class="hljs-keyword">return</span> obj === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>shallow merge</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.merge = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
      targ = args.shift(),
      obj;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn</span><span class="hljs-params">(k)</span> </span>{
    targ[k] = obj[k];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>iterate over each passed in obj remaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (; args.length; ) {
    obj = args.shift();
    <span class="hljs-keyword">if</span>(obj) <span class="hljs-built_in">Object</span>.keys(obj).forEach(fn);
  }

  <span class="hljs-keyword">return</span> targ;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>yield each key value pair to a function
pie.object.forEach({‘foo’ : ‘bar’}, function(k,v){ console.log(k, v); });</p>
<p>=&gt; foo, bar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.forEach = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o, f)</span> </span>{
  <span class="hljs-keyword">if</span>(!o) <span class="hljs-keyword">return</span>;

  <span class="hljs-built_in">Object</span>.keys(o).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    f(k, o[k]);
  });
};


pie.object.getPath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, path)</span> </span>{
  <span class="hljs-keyword">if</span>(!path) <span class="hljs-keyword">return</span> obj;
  <span class="hljs-keyword">if</span>(!~path.indexOf(<span class="hljs-string">'.'</span>)) <span class="hljs-keyword">return</span> obj[path];

  <span class="hljs-keyword">var</span> p = path.split(<span class="hljs-string">'.'</span>), key;
  <span class="hljs-keyword">while</span>(p.length) {
    <span class="hljs-keyword">if</span>(!obj) <span class="hljs-keyword">return</span> obj;
    key = p.shift();
    <span class="hljs-keyword">if</span> (!p.length) <span class="hljs-keyword">return</span> obj[key];
    <span class="hljs-keyword">else</span> obj = obj[key];
  }
  <span class="hljs-keyword">return</span> obj;
};


pie.object.getValue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o, attribute)</span> </span>{
  <span class="hljs-keyword">if</span>(pie.object.isFunction(attribute))          <span class="hljs-keyword">return</span> attribute.call(<span class="hljs-literal">null</span>, o);
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span>)                           <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.isFunction(o[attribute]))  <span class="hljs-keyword">return</span> o[attribute].call(o);
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.has(o, attribute, <span class="hljs-literal">true</span>))   <span class="hljs-keyword">return</span> o[attribute];
  <span class="hljs-keyword">else</span>                                          <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
};

pie.object.has = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, key, includeInherited)</span> </span>{
  <span class="hljs-keyword">return</span> obj &amp;&amp; (obj.hasOwnProperty(key) || (includeInherited &amp;&amp; (key <span class="hljs-keyword">in</span> obj)));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>does the object have the described path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.hasPath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, path)</span> </span>{
  <span class="hljs-keyword">if</span>(!~path.indexOf(<span class="hljs-string">'.'</span>)) <span class="hljs-keyword">return</span> pie.object.has(obj, path);

  <span class="hljs-keyword">var</span> parts = path.split(<span class="hljs-string">'.'</span>), part;
  <span class="hljs-keyword">while</span>(part = parts.shift()) {

    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">if</span>(pie.object.has(obj, part)) {
      obj = obj[part];
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};

pie.object.reverseMerge = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* args */</span>)</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>);
  args.reverse();
  <span class="hljs-keyword">return</span> pie.object.merge.apply(<span class="hljs-literal">null</span>, args);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>serialize object into query string
{foo: ‘bar’} =&gt; foo=bar
{foo: {inner: ‘bar’}} =&gt; foo[inner]=bar
{foo: [3]} =&gt; foo[]=3
{foo: [{inner: ‘bar’}]} =&gt; foo[][inner]=bar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.serialize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, removeEmpty)</span> </span>{
  <span class="hljs-keyword">var</span> s = [], append, appendEmpty, build, rbracket = <span class="hljs-regexp">/\[\]$/</span>;

  append = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span></span>{
    v = pie.fn.valueFrom(v);
    <span class="hljs-keyword">if</span>(removeEmpty &amp;&amp; !rbracket.test(k) &amp;&amp; (v == <span class="hljs-literal">null</span> || !v.toString().length)) <span class="hljs-keyword">return</span>;
    s.push(<span class="hljs-built_in">encodeURIComponent</span>(k) + <span class="hljs-string">'='</span> + <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">String</span>(v)));
  };

  appendEmpty = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    s.push(<span class="hljs-built_in">encodeURIComponent</span>(k) + <span class="hljs-string">'='</span>);
  };

  build = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(prefix, o, append)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(o)) {
      o.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span> </span>{
        build(prefix + <span class="hljs-string">'[]'</span>, v, append);
      });
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.isPlainObject(o)) {
      <span class="hljs-built_in">Object</span>.keys(o).sort().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
        build(prefix + <span class="hljs-string">'['</span> + k + <span class="hljs-string">']'</span>, o[k], append);
      });
    } <span class="hljs-keyword">else</span> {
      append(prefix, o);
    }
  };

  <span class="hljs-built_in">Object</span>.keys(obj).sort().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{
    build(k, obj[k], append);
  });

  <span class="hljs-keyword">return</span> s.join(<span class="hljs-string">'&amp;'</span>);
};


pie.object.setPath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, path, value)</span> </span>{
  <span class="hljs-keyword">if</span>(!~path.indexOf(<span class="hljs-string">'.'</span>)) <span class="hljs-keyword">return</span> obj[path] = value;

  <span class="hljs-keyword">var</span> p = path.split(<span class="hljs-string">'.'</span>), key;
  <span class="hljs-keyword">while</span>(p.length) {
    key = p.shift();
    <span class="hljs-keyword">if</span> (!p.length) <span class="hljs-keyword">return</span> obj[key] = value;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (obj[key]) obj = obj[key];
    <span class="hljs-keyword">else</span> obj = obj[key] = {};
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>grab a sub-object from the provided object.
pie.object.slice({foo: ‘bar’, biz: ‘baz’}, ‘biz’) =&gt; {‘biz’: ‘baz’}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.slice = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> keys = pie.array.from(<span class="hljs-built_in">arguments</span>),
  a = keys.shift(),
  b = {};

  keys = pie.array.flatten(keys);
  keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
    <span class="hljs-keyword">if</span>(pie.object.has(a, k)) b[k] = a[k];
  });

  <span class="hljs-keyword">return</span> b;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>return all the values of the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.object.values = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(a).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{ <span class="hljs-keyword">return</span> a[k]; });
};
pie.string.PROTOCOL_TEST = <span class="hljs-regexp">/\w+:\/\//</span>;

pie.string.capitalize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.charAt(<span class="hljs-number">0</span>).toUpperCase() + str.slice(<span class="hljs-number">1</span>);
};


pie.string.change = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
  str = args.shift();
  args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
    str = pie.string[m](str);
  });

  <span class="hljs-keyword">return</span> str;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>deserialize query string into object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.deserialize = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseQueryValue</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'null'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'true'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(value === <span class="hljs-string">'false'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/^-?\d*(\.\d+)?$/</span>.test(value)) {
      <span class="hljs-keyword">var</span> f = <span class="hljs-built_in">parseFloat</span>(value, <span class="hljs-number">10</span>),
          i = <span class="hljs-built_in">parseInt</span>(f, <span class="hljs-number">10</span>);
      <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isNaN</span>(f) &amp;&amp; f % <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> f;
      <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isNaN</span>(i)) <span class="hljs-keyword">return</span> i;
    }
    <span class="hljs-keyword">return</span> value;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>foo[][0][thing]=bar
=&gt; [{‘0’ : {thing: ‘bar’}}]
foo[]=thing&amp;foo[]=bar
=&gt; {foo: [thing, bar]}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">applyValue</span><span class="hljs-params">(key, value, params)</span> </span>{
    <span class="hljs-keyword">var</span> pieces = key.split(<span class="hljs-string">'['</span>),
    segmentRegex = <span class="hljs-regexp">/^\[(.+)?\]$/</span>,
    match, piece, target;

    key = pieces.shift();
    pieces = pieces.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">'['</span> + p; });

    target = params;

    <span class="hljs-keyword">while</span>(piece = pieces.shift()) {
      match = piece.match(segmentRegex);</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>obj</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(match[<span class="hljs-number">1</span>]) {
        target[key] = target[key] || {};
        target = target[key];
        key = match[<span class="hljs-number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {
        target[key] = target[key] || [];
        target = target[key];
        key = target.length;
      }
    }

    target[key] = value;

    <span class="hljs-keyword">return</span> params;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, parse)</span> </span>{
    <span class="hljs-keyword">var</span> params = {}, idx, pieces, segments, key, value;

    <span class="hljs-keyword">if</span>(!str) <span class="hljs-keyword">return</span> params;

    idx = str.indexOf(<span class="hljs-string">'?'</span>);
    <span class="hljs-keyword">if</span>(~idx) str = str.slice(idx+<span class="hljs-number">1</span>);

    pieces = str.split(<span class="hljs-string">'&amp;'</span>);
    pieces.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(piece)</span></span>{
      segments = piece.split(<span class="hljs-string">'='</span>);
      key = <span class="hljs-built_in">decodeURIComponent</span>(segments[<span class="hljs-number">0</span>] || <span class="hljs-string">''</span>);
      value = <span class="hljs-built_in">decodeURIComponent</span>(segments[<span class="hljs-number">1</span>] || <span class="hljs-string">''</span>);

      <span class="hljs-keyword">if</span>(parse) value = parseQueryValue(value);

      applyValue(key, value, params);
    });

    <span class="hljs-keyword">return</span> params;
  };
})();

pie.string.downcase = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.toLowerCase();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Escapes a string for HTML interpolation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.escape = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> encReg = <span class="hljs-regexp">/[&lt;&gt;&amp;"'\x00]/g</span>;
  <span class="hljs-keyword">var</span> encMap = {
    <span class="hljs-string">"&lt;"</span>   : <span class="hljs-string">"&amp;lt;"</span>,
    <span class="hljs-string">"&gt;"</span>   : <span class="hljs-string">"&amp;gt;"</span>,
    <span class="hljs-string">"&amp;"</span>   : <span class="hljs-string">"&amp;amp;"</span>,
    <span class="hljs-string">"\""</span>  : <span class="hljs-string">"&amp;quot;"</span>,
    <span class="hljs-string">"'"</span>   : <span class="hljs-string">"&amp;#39;"</span>
  };

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
    <span class="hljs-comment">/* jslint eqnull: true */</span>
    <span class="hljs-keyword">if</span>(str == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> str;
    <span class="hljs-keyword">return</span> (<span class="hljs-string">""</span> + str).replace(encReg, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span> </span>{ <span class="hljs-keyword">return</span> encMap[c] || <span class="hljs-string">""</span>; });
  };
})();

pie.string.endsWith = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, suffix)</span> </span>{
  <span class="hljs-keyword">return</span> str.indexOf(suffix, str.length - suffix.length) !== -<span class="hljs-number">1</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>designed to be used with the “%{expression}” placeholders</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.expand = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, data)</span> </span>{
  data = data || {};
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/\%\{(.+?)\}/g</span>,
    <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, key)</span> </span>{<span class="hljs-keyword">return</span> data[key];});
};


pie.string.humanize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/_id$/</span>, <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/([a-z][A-Z]|[a-z]_[a-z])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a)</span></span>{ <span class="hljs-keyword">return</span> a[<span class="hljs-number">0</span>] + <span class="hljs-string">' '</span> + a[a.length-<span class="hljs-number">1</span>]; });
};


pie.string.lowerize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.charAt(<span class="hljs-number">0</span>).toLowerCase() + str.slice(<span class="hljs-number">1</span>);
};


pie.string.modularize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/([^_])_([^_])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a, b)</span></span>{ <span class="hljs-keyword">return</span> a + b.toUpperCase(); });
};

pie.string.normalizeUrl =  <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>ensure there’s a leading slash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!pie.string.PROTOCOL_TEST.test(path) &amp;&amp; path.charAt(<span class="hljs-number">0</span>) !== <span class="hljs-string">'/'</span>) {
    path = <span class="hljs-string">'/'</span> + path;
  }

  <span class="hljs-keyword">if</span>(path.indexOf(<span class="hljs-string">'?'</span>) &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">var</span> split = path.split(<span class="hljs-string">'?'</span>);
    path = pie.string.normalizeUrl(split.shift());
    split.unshift(path);
    path = split.join(<span class="hljs-string">'?'</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>remove trailing hashtags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(path.charAt(path.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'#'</span>) {
    path = path.substr(<span class="hljs-number">0</span>, path.length - <span class="hljs-number">1</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>remove trailing slashes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(path.length &gt; <span class="hljs-number">1</span> &amp;&amp; path.charAt(path.length - <span class="hljs-number">1</span>) === <span class="hljs-string">'/'</span>) {
    path = path.substr(<span class="hljs-number">0</span>, path.length - <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> path;
};

pie.string.pluralize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, count)</span> </span>{
  <span class="hljs-keyword">if</span>(count === <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> str;
  <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/ss$/i</span>.test(str)) <span class="hljs-keyword">return</span> str + <span class="hljs-string">'es'</span>;
  <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/s$/i</span>.test(str)) <span class="hljs-keyword">return</span> str;
  <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/[a-z]$/i</span>.test(str)) <span class="hljs-keyword">return</span> str + <span class="hljs-string">'s'</span>;
  <span class="hljs-keyword">return</span> str;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>todo: i18n</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.possessive = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/s$/i</span>.test(str)) <span class="hljs-keyword">return</span> str + <span class="hljs-string">"'"</span>;
  <span class="hljs-keyword">return</span> str + <span class="hljs-string">"'s"</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>string templating via John Resig</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.string.template = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str, varString)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">"data"</span>,
    <span class="hljs-string">"var __p=[];"</span> + (varString || <span class="hljs-string">""</span>) + <span class="hljs-string">";with(data){__p.push('"</span> +
    str.replace(<span class="hljs-regexp">/[\r\t\n]/g</span>, <span class="hljs-string">" "</span>)
       .replace(<span class="hljs-regexp">/'(?=[^%]*%\])/g</span>,<span class="hljs-string">"\t"</span>)
       .split(<span class="hljs-string">"'"</span>).join(<span class="hljs-string">"\\'"</span>)
       .split(<span class="hljs-string">"\t"</span>).join(<span class="hljs-string">"'"</span>)
       .replace(<span class="hljs-regexp">/\[%=(.+?)%\]/g</span>, <span class="hljs-string">"',$1,'"</span>)
       .replace(<span class="hljs-regexp">/\[%-(.+?)%\]/g</span>, <span class="hljs-string">"',pie.string.escape($1),'"</span>)
       .split(<span class="hljs-string">"[%"</span>).join(<span class="hljs-string">"');"</span>)
       .split(<span class="hljs-string">"%]"</span>).join(<span class="hljs-string">"__p.push('"</span>) +
       <span class="hljs-string">"');}return __p.join('');"</span>
  );
};

pie.string.titleize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/(^| )([a-z])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a, b)</span></span>{ <span class="hljs-keyword">return</span> a + b.toUpperCase(); });
};

pie.string.pathSteps = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
  <span class="hljs-keyword">var</span> split = path.split(<span class="hljs-string">'.'</span>),
  steps = [];

  <span class="hljs-keyword">while</span>(split.length) {
    steps.push(split.join(<span class="hljs-string">'.'</span>));
    split.pop();
  }

  <span class="hljs-keyword">return</span> steps;
};

pie.string.underscore = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/([a-z])([A-Z])/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, a, b)</span></span>{ <span class="hljs-keyword">return</span> a + <span class="hljs-string">'_'</span> + b.toLowerCase(); }).toLowerCase();
};

pie.string.upcase = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> </span>{
  <span class="hljs-keyword">return</span> str.toUpperCase();
};


pie.string.urlConcat = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> args = pie.array.compact(pie.array.from(<span class="hljs-built_in">arguments</span>), <span class="hljs-literal">true</span>),
  base = args.shift(),
  query = args.join(<span class="hljs-string">'&amp;'</span>);

  <span class="hljs-keyword">if</span>(!query.length) <span class="hljs-keyword">return</span> base;</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>we always throw a question mark on the end of base</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(base.indexOf(<span class="hljs-string">'?'</span>) &lt; <span class="hljs-number">0</span>) base += <span class="hljs-string">'?'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>we replace all question marks in the query with &amp;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(query.indexOf(<span class="hljs-string">'?'</span>) === <span class="hljs-number">0</span>) query = query.replace(<span class="hljs-string">'?'</span>, <span class="hljs-string">'&amp;'</span>);
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(query.indexOf(<span class="hljs-string">'&amp;'</span>) !== <span class="hljs-number">0</span>) query = <span class="hljs-string">'&amp;'</span> + query;

  base += query;
  base = base.replace(<span class="hljs-string">'?&amp;'</span>, <span class="hljs-string">'?'</span>).replace(<span class="hljs-string">'&amp;&amp;'</span>, <span class="hljs-string">'&amp;'</span>).replace(<span class="hljs-string">'??'</span>, <span class="hljs-string">'?'</span>);
  <span class="hljs-keyword">if</span>(base.indexOf(<span class="hljs-string">'?'</span>) === base.length - <span class="hljs-number">1</span>) base = base.substr(<span class="hljs-number">0</span>, base.length - <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> base;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <h1 id="bindings-mixin">Bindings Mixin</h1>
<p>A mixin to provide two way data binding between a model and dom elements.
This mixin should be used with a pie view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.mixins.bindings = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{


  <span class="hljs-keyword">var</span> integrations = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Bind to an element’s attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  integrations.attribute = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>extract the attribute name from the binding configuration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> attributeName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(binding)</span></span>{
      <span class="hljs-keyword">return</span> binding.options.attribute || (<span class="hljs-string">'data-'</span> + binding.attr);
    };

    <span class="hljs-keyword">return</span> {

      getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
        <span class="hljs-keyword">return</span> el.getAttribute(attributeName(binding));
      },

      setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
        <span class="hljs-keyword">var</span> value = binding.model.get(binding.attr);
        <span class="hljs-keyword">return</span> el.setAttribute(attributeName(binding), value);
      }

    };
  })();

  integrations[<span class="hljs-string">'class'</span>] = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

    <span class="hljs-comment">/* will handle strings and arrays of strings */</span>
    <span class="hljs-keyword">var</span> getClassNames = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(string)</span> </span>{
      <span class="hljs-keyword">if</span>(!string) <span class="hljs-keyword">return</span> [];
      string = <span class="hljs-built_in">String</span>(string);
      <span class="hljs-keyword">return</span> pie.array.compact(pie.array.map(string.split(<span class="hljs-regexp">/[\,\s]/</span>), <span class="hljs-string">'trim'</span>, <span class="hljs-literal">true</span>), <span class="hljs-literal">true</span>);
    };

    <span class="hljs-keyword">return</span> {
      getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* el, binding */</span>)</span> </span>{
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"class bindings can only be from the model to the view. Please declare toModel: false"</span>);
      },

      setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
        <span class="hljs-keyword">var</span> className = binding.options.className;

        <span class="hljs-keyword">if</span>(className === <span class="hljs-string">'_value_'</span>) {
          <span class="hljs-keyword">var</span> change = binding.lastChange;
          <span class="hljs-keyword">if</span>(change) {
            <span class="hljs-keyword">if</span>(change.oldValue) {
              getClassNames(change.oldValue).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span> </span>{
                el.classList.remove(c);
              });
            }

            <span class="hljs-keyword">if</span>(change.value) {
              getClassNames(change.value).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span> </span>{
                el.classList.add(c);
              });
              <span class="hljs-keyword">return</span> change.value;
            }
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> value = binding.model.get(binding.attr);
          className = className || binding.attr;

          getClassNames(className).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span>{
            el.classList[!!value ? <span class="hljs-string">'add'</span> : <span class="hljs-string">'remove'</span>](c);
          });

          <span class="hljs-keyword">return</span> className;
        }
      }
    };
  })();

  integrations.value = {</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Simple value extraction</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el <span class="hljs-comment">/*, binding */</span>)</span> </span>{
      <span class="hljs-keyword">return</span> el.value;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Apply the model’s value to the element’s value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
      <span class="hljs-keyword">var</span> value = binding.model.get(binding.attr);
      <span class="hljs-comment">/* jslint eqnull:true */</span>
      <span class="hljs-keyword">if</span>(value == <span class="hljs-literal">null</span>) value = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">return</span> el.value = value;
    }

  };

  integrations.check = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>String based index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> index = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, value)</span> </span>{
      <span class="hljs-keyword">if</span>(!arr) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
      value = <span class="hljs-built_in">String</span>(value);
      <span class="hljs-keyword">return</span> pie.array.indexOf(arr, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>(e) === value; });
    };

    <span class="hljs-keyword">return</span> {

      getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>If we have an array, manage the values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(binding.dataType === <span class="hljs-string">'array'</span>) {

          <span class="hljs-keyword">var</span> existing = pie.array.from(binding.model.get(binding.attr)), i;

          i = index(existing, el.value);</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>If we are checked and we don’t already have it, add it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span>(el.checked &amp;&amp; i &lt; <span class="hljs-number">0</span>) {
            existing = pie.array.dup(existing);
            existing.push(el.value);</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>If we are not checked but we do have it, then we add it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!el.checked &amp;&amp; i &gt;= <span class="hljs-number">0</span>) {
            existing = pie.array.dup(existing);
            existing.splice(i, <span class="hljs-number">1</span>);
          }

          <span class="hljs-keyword">return</span> existing;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(binding.dataType === <span class="hljs-string">'boolean'</span>){
          <span class="hljs-keyword">return</span> el.checked;
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Otherwise, we return the el’s value if it’s checked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> el.checked ? el.value : <span class="hljs-literal">null</span>;
        }
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>If the model’s value contains the checkbox, check it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
        <span class="hljs-keyword">var</span> value = binding.model.get(binding.attr),
        elValue = el.value;</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>In the case of an array, we check for inclusion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(binding.dataType === <span class="hljs-string">'array'</span>) {
          <span class="hljs-keyword">var</span> i = index(value, elValue);
          <span class="hljs-keyword">return</span> el.checked = !!~i;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> caster = typeCaster(binding.dataType);</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Otherwise we check for equality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> el.checked = caster(elValue) === caster(value);
        }
      }
    };

  })();


  integrations.radio = {</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>If a radio input is checked, return it’s value.
Otherwise, return the existing value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
      <span class="hljs-keyword">var</span> existing = binding.model.get(binding.attr);
      <span class="hljs-keyword">if</span>(el.checked) <span class="hljs-keyword">return</span> el.value;
      <span class="hljs-keyword">return</span> existing;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Check a radio button if the value matches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
      <span class="hljs-keyword">var</span> value = binding.model.get(binding.attr),
      elValue = el.value,
      caster = typeCaster(binding.dataType);

      <span class="hljs-comment">/* jslint eqeq:true */</span>
      <span class="hljs-keyword">return</span> el.checked = caster(elValue) === caster(value);
    }

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Set the innerTEXT of an element based on the model’s value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  integrations.text = {

    getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el <span class="hljs-comment">/*, binding */</span>)</span> </span>{
      <span class="hljs-keyword">return</span> el.textContent;
    },

    setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
      <span class="hljs-keyword">var</span> value = binding.model.get(binding.attr);

      <span class="hljs-comment">/* jslint eqnull:true */</span>
      <span class="hljs-keyword">if</span>(value == <span class="hljs-literal">null</span>) value = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">return</span> el.textContent = value;
    }

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Set the innerHTML of an element based on the model’s value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  integrations.html = {

    getValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el <span class="hljs-comment">/*, binding */</span>)</span> </span>{
      <span class="hljs-keyword">return</span> el.innerHTML;
    },

    setValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
      <span class="hljs-keyword">var</span> value = binding.model.get(binding.attr);
      <span class="hljs-comment">/* jslint eqnull:true */</span>
      <span class="hljs-keyword">if</span>(value == <span class="hljs-literal">null</span>) value = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">return</span> el.innerHTML = value;
    }

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>If type=auto, this does it’s best to determine the appropriate integration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> determineIntegrationForBinding = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
      <span class="hljs-keyword">var</span> mod;
      <span class="hljs-keyword">if</span>(el.hasAttribute &amp;&amp; el.hasAttribute(<span class="hljs-string">'data-'</span> + binding.attr)) mod = <span class="hljs-string">'attribute'</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(el.nodeName === <span class="hljs-string">'INPUT'</span> &amp;&amp; el.getAttribute(<span class="hljs-string">'type'</span>) === <span class="hljs-string">'checkbox'</span>) mod = <span class="hljs-string">'check'</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(el.nodeName === <span class="hljs-string">'INPUT'</span> &amp;&amp; el.getAttribute(<span class="hljs-string">'type'</span>) === <span class="hljs-string">'radio'</span>) mod = <span class="hljs-string">'radio'</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(el.nodeName === <span class="hljs-string">'INPUT'</span> || el.nodeName === <span class="hljs-string">'SELECT'</span> || el.nodeName === <span class="hljs-string">'TEXTAREA'</span>) mod = <span class="hljs-string">'value'</span>;
      <span class="hljs-keyword">else</span> mod = <span class="hljs-string">'text'</span>;

      <span class="hljs-keyword">return</span> integrations[mod];
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>Provide a way to retrieve values out of the dom &amp; apply values to the dom.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> integration = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{
    <span class="hljs-keyword">if</span>(binding.type === <span class="hljs-string">'auto'</span>) <span class="hljs-keyword">return</span> determineIntegrationForBinding(el, binding);
    <span class="hljs-keyword">return</span> integrations[binding.type] || integrations.value;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>A set of methods to cast raw values into a specific type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> typeCasters = {</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Note that <code>undefined</code> and <code>null</code> will result in <code>[]</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    array: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
      <span class="hljs-keyword">return</span> pie.array.from(raw);
    },

    boolean: (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Match different strings representing truthy values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> reg = <span class="hljs-regexp">/^(1|true|yes|t|ok|on)$/</span>;

      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
        <span class="hljs-keyword">if</span>(raw == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> raw;
        <span class="hljs-keyword">return</span> !!(raw &amp;&amp; reg.test(<span class="hljs-built_in">String</span>(raw)));
      };

    })(),</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Attempt to parse as a float, if <code>NaN</code> return <code>null</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    number: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
      <span class="hljs-keyword">var</span> val = <span class="hljs-built_in">parseFloat</span>(raw, <span class="hljs-number">10</span>);
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(val)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> val;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Attempt to parse as an integer, if <code>NaN</code> return <code>null</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    integer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
      <span class="hljs-keyword">var</span> val = <span class="hljs-built_in">parseInt</span>(raw, <span class="hljs-number">10</span>);
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(val)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> val;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p><code>null</code> or <code>undefined</code> are passed through, otherwise cast as a String.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    string: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
      <span class="hljs-keyword">return</span> raw == <span class="hljs-literal">null</span> ? raw : <span class="hljs-built_in">String</span>(raw);
    },

    <span class="hljs-string">"default"</span> : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(raw)</span> </span>{
      <span class="hljs-keyword">return</span> raw;
    }

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>The type caster based on the <code>dataType</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> typeCaster = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dataType)</span> </span>{
    <span class="hljs-keyword">return</span> typeCasters[dataType] || typeCasters[<span class="hljs-string">'default'</span>];
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Take horrible user provided options and turn it into magical pie options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> normalizeBindingOptions = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(given)</span> </span>{

    <span class="hljs-keyword">if</span>(!given.attr) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"An attr must be provided for data binding. "</span> + <span class="hljs-built_in">JSON</span>.stringify(given));

    <span class="hljs-keyword">var</span> out         = {};
    <span class="hljs-comment">/* the model attribute to be observed / updated. */</span>
    out.attr        = given.attr;
    <span class="hljs-comment">/* the model to apply changes to. */</span>
    out.model       = given.model       || <span class="hljs-keyword">this</span>.model;
    <span class="hljs-comment">/* the selector to observe */</span>
    out.sel         = given.sel         || <span class="hljs-string">'[name="'</span> + given.attr + <span class="hljs-string">'"]'</span>;
    <span class="hljs-comment">/* the way in which the binding should extract the value from the dom. */</span>
    out.type        = given.type        || <span class="hljs-string">'auto'</span>;
    <span class="hljs-comment">/* the desired type the dom value's should be cast to. */</span>
    out.dataType    = given.dataType    || <span class="hljs-string">'default'</span>;
    <span class="hljs-comment">/* if `dataType` is "array", they type which should be applied to each. */</span>
    out.eachType    = given.eachType    || <span class="hljs-literal">undefined</span>;
    <span class="hljs-comment">/* when an input changes or has a keyup event, the model will update. */</span>
    out.trigger     = given.trigger     || <span class="hljs-string">'change keyup'</span>;
    <span class="hljs-comment">/* just in case the dom events should be based on a different field than that provided by `sel` */</span>
    out.triggerSel  = given.triggerSel  || out.sel;
    <span class="hljs-comment">/* if toModel is not provided, it's presumed to be desired. */</span>
    out.toModel     = given.toModel     || (given.toModel === <span class="hljs-literal">undefined</span> &amp;&amp; out.type !== <span class="hljs-string">'class'</span>);
    <span class="hljs-comment">/* if toView is not provided, it's presumed to be desired. */</span>
    out.toView      = given.toView      || given.toView === <span class="hljs-literal">undefined</span>;
    <span class="hljs-comment">/* no debounce by default. */</span>
    out.debounce    = given.debounce    || <span class="hljs-literal">false</span>;
    <span class="hljs-comment">/* secondary options. */</span>
    out.options     = given.options     || {};

    <span class="hljs-comment">/* A `true` value will results in a default debounce duration of 250ms. */</span>
    <span class="hljs-keyword">if</span>(out.debounce === <span class="hljs-literal">true</span>) out.debounce = <span class="hljs-number">250</span>;

    <span class="hljs-keyword">return</span> out;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Apply a value to the model, ensuring the model-to-view triggers do not take place.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> applyValueToModel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, binding, opts)</span> </span>{
    <span class="hljs-keyword">try</span>{
      binding.ignore = <span class="hljs-literal">true</span>;
      binding.model.set(binding.attr, value, opts);</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Even if we error, we should reset the ignore.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">finally</span> {
      binding.ignore = <span class="hljs-literal">false</span>;
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Take a model’s value, and apply it to all relevant elements within <code>parentEl</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> applyValueToElements = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parentEl, binding)</span> </span>{
    <span class="hljs-keyword">if</span>(binding.ignore) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> els = parentEl.querySelectorAll(binding.sel);</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>For each matching element, set the value based on the binding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; els.length; i++) {
      integration(els[i], binding).setValue(els[i], binding);
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Extract a value out of an element based on a binding configuration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> getValueFromElement = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, binding)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Get the basic value out of the element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> val = integration(el, binding).getValue(el, binding),</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Get the type casting function it based on the configuration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fn = typeCaster(binding.dataType);</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>Type cast the value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    val = fn(val);</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>If we’re configured to have an array and have defined an <code>eachType</code>
use it to typecast each value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(binding.dataType === <span class="hljs-string">'array'</span> &amp;&amp; binding.eachType) {
      <span class="hljs-keyword">var</span> eachFn = typeCaster(binding.eachType);
      val = val.map(eachFn);
    }

    <span class="hljs-keyword">return</span> val;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <h3 id="binding-initializations">Binding Initializations</h3>
<p>With a binding configuration ready, let’s wire up the callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> initCallbacks = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(binding)</span> </span>{
    initModelCallbacks.call(<span class="hljs-keyword">this</span>, binding);
    initViewCallbacks.call(<span class="hljs-keyword">this</span>, binding);

    <span class="hljs-keyword">return</span> binding;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Wiring of the view-to-model callbacks. These will observe dom events
and translate them to model values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> initViewCallbacks = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(binding)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>If no view-to-model binding is desired, escape.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!binding.toModel) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>If a function is provided, use that as the base implementation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(pie.object.isFunction(binding.toModel)) {
      binding._toModel = binding.toModel;
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>Otherwise, we provide a default implementation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      binding._toModel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, opts)</span> </span>{
        <span class="hljs-keyword">var</span> value = getValueFromElement(el, binding);
        applyValueToModel(value, binding, opts);
      };
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>We wrap our base implementation with a function that handles event arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    binding.toModel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
      <span class="hljs-keyword">var</span> el = e.delegateTarget;
      binding._toModel(el);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>If a debounce is requested, we apply the debounce to the wrapped function,
Leaving the base function untouched.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(binding.debounce) binding.toModel = pie.fn.debounce(binding.toModel, binding.debounce);</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Multiple events could be supplied, separated by a space.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> events = binding.trigger.split(<span class="hljs-string">' '</span>);
    events.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Use the view’s event management to register the callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.on(event, binding.triggerSel, binding.toModel);
    }.bind(<span class="hljs-keyword">this</span>));
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>Initialization of model-to-view callbacks. These will observe relevant model
changes and update the dom.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> initModelCallbacks = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(binding)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>If no model-to-view binding is desired, escape.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!binding.toView) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>If a toView function is not provided, apply the default implementation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!pie.object.isFunction(binding.toView)) {
      binding.toView = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span> </span>{
        binding.lastChange = changes &amp;&amp; changes.get(binding.attr);
        applyValueToElements(<span class="hljs-keyword">this</span>.el, binding);
      }.bind(<span class="hljs-keyword">this</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Register a change observer with the new.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.onChange(binding.model, binding.toView, binding.attr);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <h2 id="bindings-mixin">Bindings Mixin</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>The registration &amp; configuration of bindings is kept in this._bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>._bindings = [];
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._super) <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>If we have an emitter, tap into the afterRender event and initialize the dom
with our model values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.emitter) <span class="hljs-keyword">this</span>.emitter.on(<span class="hljs-string">'afterRender'</span>, <span class="hljs-keyword">this</span>.initBoundFields.bind(<span class="hljs-keyword">this</span>));
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._super) <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>Register 1+ bindings within the view.</p>
<p><code>this.bind({ attr: &#39;first_name&#39; }, { attr: &#39;last_name&#39; })</code>;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    bind: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> wanted = pie.array.from(<span class="hljs-built_in">arguments</span>);
      wanted = wanted.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(opts)</span> </span>{
        opts = normalizeBindingOptions.call(<span class="hljs-keyword">this</span>, opts);
        <span class="hljs-keyword">return</span> initCallbacks.call(<span class="hljs-keyword">this</span>, opts);
      }.bind(<span class="hljs-keyword">this</span>));

      <span class="hljs-keyword">this</span>._bindings = <span class="hljs-keyword">this</span>._bindings.concat(wanted);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Iterate each binding and propagate the model value to the dom.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initBoundFields: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>._bindings.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b)</span></span>{
        <span class="hljs-keyword">if</span>(b.toView) b.toView();
      });
    },


    <span class="hljs-comment">/* Iterate each binding and propagate the dom value to the model. */</span>
    <span class="hljs-comment">/* A single set of change records will be produced (`_version` will only increment by 1). */</span>
    readBoundFields: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> models = {}, skip = {skipObservers: <span class="hljs-literal">true</span>}, els, i;

      <span class="hljs-keyword">this</span>._bindings.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b)</span> </span>{
        <span class="hljs-keyword">if</span>(!b.toModel) <span class="hljs-keyword">return</span>;

        models[b.model.pieId] = b.model;
        els = <span class="hljs-keyword">this</span>.qsa(b.sel);

        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; els.length; i++) {
          b._toModel(els[i], skip);
        }
      }.bind(<span class="hljs-keyword">this</span>));

      pie.object.forEach(models, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id, m)</span> </span>{
        m.deliverChangeRecords();
      });

    }
  };

})();
pie.mixins.changeSet = {

  has: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">return</span> pie.array.areAny(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(change)</span> </span>{
      <span class="hljs-keyword">return</span> change.name === name;
    });
  },

  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">return</span> pie.array.detectLast(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(change)</span> </span>{
      <span class="hljs-keyword">return</span> change.name === name;
    });
  },

  hasAny: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++) {
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-built_in">arguments</span>[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },

  hasAll: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++) {
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.has(<span class="hljs-built_in">arguments</span>[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

};
pie.mixins.container = {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.children = [];
    <span class="hljs-keyword">this</span>.childNames = {};
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._super) <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  addChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, child)</span> </span>{
    <span class="hljs-keyword">var</span> idx;

    <span class="hljs-keyword">this</span>.children.push(child);
    idx = <span class="hljs-keyword">this</span>.children.length - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">this</span>.childNames[name] = idx;
    child._indexWithinParent = idx;
    child._nameWithinParent = name;
    child.parent = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span>(pie.object.has(child, <span class="hljs-string">'addedToParent'</span>, <span class="hljs-literal">true</span>)) child.addedToParent.call(child);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  addChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    pie.object.forEach(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, child)</span> </span>{
      <span class="hljs-keyword">this</span>.addChild(name, child);
    }.bind(<span class="hljs-keyword">this</span>));
  },

  getChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-comment">/* jslint eqeq:true */</span>
    <span class="hljs-keyword">if</span>(obj == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(obj._nameWithinParent) <span class="hljs-keyword">return</span> obj;

    <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>.childNames[obj];
    <span class="hljs-keyword">if</span>(idx == <span class="hljs-literal">null</span>) idx = obj;</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>It’s a path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">String</span>(idx).match(<span class="hljs-regexp">/\./</span>)) {
      <span class="hljs-keyword">var</span> steps = idx.split(<span class="hljs-string">'.'</span>),
      step, child = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">while</span>(step = steps.shift()) {
        child = child.getChild(step);
        <span class="hljs-keyword">if</span>(!child) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
      }

      <span class="hljs-keyword">return</span> child;
    }

    <span class="hljs-keyword">return</span> ~idx &amp;&amp; <span class="hljs-keyword">this</span>.children[idx] || <span class="hljs-literal">undefined</span>;
  },

  bubble: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
    fname = args.shift(),
    obj = <span class="hljs-keyword">this</span>.parent;

    <span class="hljs-keyword">while</span>(obj &amp;&amp; !(fname <span class="hljs-keyword">in</span> obj)) {
      obj = obj.parent;
    }

    <span class="hljs-keyword">if</span>(obj) <span class="hljs-keyword">return</span> obj[fname].apply(obj, args);
  },

  removeChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">var</span> child = <span class="hljs-keyword">this</span>.getChild(obj), i;

    <span class="hljs-keyword">if</span>(child) {
      i = child._indexWithinParent;
      <span class="hljs-keyword">this</span>.children.splice(i, <span class="hljs-number">1</span>);

      <span class="hljs-keyword">for</span>(;i &lt; <span class="hljs-keyword">this</span>.children.length;i++) {
        <span class="hljs-keyword">this</span>.children[i]._indexWithinParent = i;
        <span class="hljs-keyword">this</span>.childNames[<span class="hljs-keyword">this</span>.children[i]._nameWithinParent] = i;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>clean up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.childNames[child._nameWithinParent];
      <span class="hljs-keyword">delete</span> child._indexWithinParent;
      <span class="hljs-keyword">delete</span> child._nameWithinParent;
      <span class="hljs-keyword">delete</span> child.parent;

      <span class="hljs-keyword">if</span>(pie.object.has(child, <span class="hljs-string">'removedFromParent'</span>, <span class="hljs-literal">true</span>)) child.removedFromParent.call(child, <span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  removeChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> child;

    <span class="hljs-keyword">while</span>(child = <span class="hljs-keyword">this</span>.children[<span class="hljs-keyword">this</span>.children.length-<span class="hljs-number">1</span>]) {
      <span class="hljs-keyword">this</span>.removeChild(child);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  __tree: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(indent)</span> </span>{
    indent = indent || <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> pad = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(s, i)</span></span>{
      <span class="hljs-keyword">if</span>(!i) <span class="hljs-keyword">return</span> s;
      <span class="hljs-keyword">while</span>(i-- &gt; <span class="hljs-number">0</span>) s = <span class="hljs-string">" "</span> + s;
      <span class="hljs-keyword">return</span> s;
    };
    <span class="hljs-keyword">var</span> str = <span class="hljs-string">"\n"</span>, nextIndent = indent + (indent ? <span class="hljs-number">4</span> : <span class="hljs-number">1</span>);
    str += pad((indent ? <span class="hljs-string">'|- '</span> : <span class="hljs-string">''</span>) + (<span class="hljs-keyword">this</span>._nameWithinParent || <span class="hljs-keyword">this</span>._indexWithinParent || <span class="hljs-keyword">this</span>.className) + <span class="hljs-string">' ('</span> + (<span class="hljs-keyword">this</span>.className || <span class="hljs-keyword">this</span>.pieId) + <span class="hljs-string">')'</span>, indent);

    <span class="hljs-keyword">this</span>.children.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> </span>{
      str += <span class="hljs-string">"\n"</span> + pad(<span class="hljs-string">'|'</span>, nextIndent);
      str += child.__tree(nextIndent);
    });

    <span class="hljs-keyword">if</span>(!indent) str += <span class="hljs-string">"\n"</span>;

    <span class="hljs-keyword">return</span> str;
  }
};
pie.mixins.validatable = {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.validations = [];
    <span class="hljs-keyword">this</span>.validationStrategy = <span class="hljs-string">'dirty'</span>;

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._super) <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.data.validationErrors) <span class="hljs-keyword">this</span>.data.validationErrors = {};

    <span class="hljs-keyword">this</span>.compute(<span class="hljs-string">'isValid'</span>, <span class="hljs-string">'validationErrors'</span>);
  },

  isValid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'validationErrors'</span>)).length === <span class="hljs-number">0</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>default to a model implementation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reportValidationError: (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> opts = {noDeleteRecursive: <span class="hljs-literal">true</span>};

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, errors)</span> </span>{
      errors = errors &amp;&amp; errors.length ? errors : <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'validationErrors.'</span> + key, errors, opts);
    };
  })(),</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>validates({name: ‘presence’});
validates({name: {presence: true}});
validates({name: [‘presence’, {format: /[a]/}]})</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validates: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, validationStrategy)</span> </span>{
    <span class="hljs-keyword">var</span> configs, resultConfigs;

    <span class="hljs-keyword">this</span>.validations = <span class="hljs-keyword">this</span>.validations || {};

    <span class="hljs-built_in">Object</span>.keys(obj).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>always convert to an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      configs = pie.array.from(obj[k]);
      resultConfigs = [];

      configs.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(conf)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>if it’s a string or a function, throw it in directly, with no options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(pie.object.isString(conf)) {
          resultConfigs.push({type: conf, options: {}});</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>if it’s a function, make it a type function, then provide the function as an option</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.isFunction(conf)){
          resultConfigs.push({type: <span class="hljs-string">'fn'</span>, options: {fn: conf}});</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>otherwise, we have an object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>iterate the keys, adding a validation for each</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-built_in">Object</span>.keys(conf).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(confKey)</span></span>{
            <span class="hljs-keyword">if</span> (pie.object.isObject(conf[confKey])) {
              resultConfigs.push({type: confKey, options: conf[confKey]});</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>in this case, we convert the value to an option
{presence: true} -&gt; {type: ‘presence’, {presence: true}}
{format: /.+/} -&gt; {type: ‘format’, {format: /.+/}}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="hljs-keyword">else</span> {
              resultConfigs.push({
                type: confKey,
                options: pie.object.merge({}, conf)
              });
            }
          });
        }

      });</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>append the validations to the existing ones</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.validations[k] = <span class="hljs-keyword">this</span>.validations[k] || [];
      <span class="hljs-keyword">this</span>.validations[k] = <span class="hljs-keyword">this</span>.validations[k].concat(resultConfigs);

      <span class="hljs-keyword">this</span>.observe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span></span>{
        <span class="hljs-keyword">var</span> change = changes.get(k);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.validationChangeObserver(change);
      }.bind(<span class="hljs-keyword">this</span>), k);

    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">if</span>(validationStrategy !== <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">this</span>.validationStrategy = validationStrategy;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>Invoke validateAll with a set of optional callbacks for the success case and the failure case.
this.validateAll(function(){ alert(‘Success!’); }, function(){ alert(‘Errors!’); });
validateAll will perform all registered validations, asynchronously. When all validations have completed, the callbacks
will be invoked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validateAll: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
    <span class="hljs-keyword">var</span> ok = <span class="hljs-literal">true</span>,
    keys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.validations),
    fns,
    whenComplete = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span>(cb) cb(ok);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
    },
    counterObserver = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bool)</span> </span>{
      ok = !!(ok &amp;&amp; bool);
    };

    <span class="hljs-keyword">if</span>(!keys.length) {
      <span class="hljs-keyword">return</span> whenComplete();
    } <span class="hljs-keyword">else</span> {

      fns = keys.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.validate(k, cb);
        }.bind(<span class="hljs-keyword">this</span>);
      }.bind(<span class="hljs-keyword">this</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>start all the validations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      pie.fn.async(fns, whenComplete, counterObserver);

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// return undefined to ensure we make our point about asynchronous validation.</span>
    }
  },


  validationChangeObserver: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(change)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.validationStrategy === <span class="hljs-string">'validate'</span>) {
      <span class="hljs-keyword">this</span>.validate(change.name);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.validationStrategy === <span class="hljs-string">'dirty'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>for speed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.data.validationErrors[change.name] &amp;&amp; <span class="hljs-keyword">this</span>.data.validationErrors[change.name].length) {
        <span class="hljs-keyword">this</span>.reportValidationError(change.name, <span class="hljs-literal">undefined</span>);
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>validate a specific key and optionally invoke a callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k, cb)</span> </span>{
    <span class="hljs-keyword">var</span> validators = <span class="hljs-keyword">this</span>.app.validator,
    validations = pie.array.from(<span class="hljs-keyword">this</span>.validations[k]),
    value = <span class="hljs-keyword">this</span>.get(k),
    valid = <span class="hljs-literal">true</span>,
    fns,
    messages,</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>The callback invoked after each individual validation is run.
It updates our validity boolean</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    counterObserver = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(validation, bool)</span> </span>{
      valid = !!(valid &amp;&amp; bool);
      <span class="hljs-keyword">if</span>(!bool) {
        messages = messages || [],
        messages.push(validators.errorMessage(validation.type, validation.options));
      }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>When all validations for the key have run, we report any errors and let the callback know
of the result;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    whenComplete = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>.reportValidationError(k, messages);
      <span class="hljs-keyword">if</span>(cb) cb(valid);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
    }.bind(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">if</span>(!validations.length) {
      <span class="hljs-keyword">return</span> whenComplete();
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>grab the validator for each validation then invoke it.
if true or false is returned immediately, we invoke the callback otherwise we assume
the validation is running asynchronously and it will invoke the callback with the result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      fns = validations.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(validation)</span> </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> </span>{
          <span class="hljs-keyword">var</span> validator = validators[validation.type],
          innerCB = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span> </span>{ callback(validation, result); },
          result = validator.call(validators, value, validation.options, innerCB);

          <span class="hljs-keyword">if</span>(result === <span class="hljs-literal">true</span> || result === <span class="hljs-literal">false</span>) {
            callback(validation, result);
          } <span class="hljs-comment">// if anything else, then the validation assumes responsibility for invoking the callback.</span>
        };
      });

      pie.fn.async(fns, whenComplete, counterObserver);

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
    }
  }
};
pie.base = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  pie.setUid(<span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">this</span>.init.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.app) {
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options &amp;&amp; <span class="hljs-keyword">this</span>.options.app) <span class="hljs-keyword">this</span>.app = <span class="hljs-keyword">this</span>.options.app;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.app = pie.appInstance;
  }
};
pie.base.prototype.init = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{};

pie.base.prototype.reopen = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> extensions = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>),
  extender = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,fn)</span> </span>{
    <span class="hljs-keyword">this</span>[k] = pie.base._wrap(fn, <span class="hljs-keyword">this</span>[k]);
  }.bind(<span class="hljs-keyword">this</span>);

  extensions.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
    pie.object.forEach(e, extender);
    <span class="hljs-keyword">if</span>(e.init) e.init.call(<span class="hljs-keyword">this</span>);
  }.bind(<span class="hljs-keyword">this</span>));

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

pie.base.subClasses = [];

pie.base.extend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> pie.base._extend(pie.base, <span class="hljs-built_in">arguments</span>);
};

pie.base.reopen = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">return</span> pie.base._reopen(pie.base, <span class="hljs-built_in">arguments</span>);
};

pie.base._extend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parentClass, extensions)</span> </span>{
  extensions = pie.array.change(extensions, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>);

  <span class="hljs-keyword">var</span> oldLength = extensions.length;
  extensions = pie.array.compact(extensions);

  <span class="hljs-keyword">if</span>(extensions.length !== oldLength) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Null values not allowed"</span>);

  <span class="hljs-keyword">var</span> name = <span class="hljs-string">""</span>, child;

  <span class="hljs-keyword">if</span>(pie.object.isString(extensions[<span class="hljs-number">0</span>])) {
    name = extensions.shift();
  }

  <span class="hljs-keyword">if</span>(pie.object.isFunction(extensions[<span class="hljs-number">0</span>])) {
    extensions.unshift({init: extensions.shift()});
  }

  <span class="hljs-keyword">if</span>(!name) {
    name = pie.object.getPath(extensions[<span class="hljs-number">0</span>], <span class="hljs-string">'init.name'</span>) || <span class="hljs-string">''</span>;
  }

  child = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(
    <span class="hljs-string">"var f = function "</span> + name + <span class="hljs-string">"(){\n"</span> +
    <span class="hljs-string">"  var myProto = Object.getPrototypeOf(this);\n"</span> +
    <span class="hljs-string">"  var parentProto = Object.getPrototypeOf(myProto);\n"</span> +
    <span class="hljs-string">"  parentProto.constructor.apply(this, arguments);\n"</span> +
    <span class="hljs-string">"};\n"</span> +</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>ensures the function name is released. Certain browsers (take a guess)
have an issue with conflicting function names.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (name ? <span class="hljs-string">"var "</span> + name + <span class="hljs-string">" = null;\n"</span> : <span class="hljs-string">""</span>) +
    <span class="hljs-string">"return f;"</span>
  )();



  child.className  = name;</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>We don’t set the constructor of the prototype since it would cause
an infinite loop upon instantiation of our object. (due to the constructor.apply(this) &amp; multiple levels of inheritance.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  child.prototype = <span class="hljs-built_in">Object</span>.create(parentClass.prototype);
  child.prototype.className = name;

  child.extend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> pie.base._extend(child, <span class="hljs-built_in">arguments</span>);
  };

  child.reopen = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> pie.base._reopen(child, <span class="hljs-built_in">arguments</span>);
  };

  <span class="hljs-keyword">if</span>(extensions.length) child.reopen(extensions);

  <span class="hljs-keyword">return</span> child;
};

pie.base._reopen = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(klass, extensions)</span> </span>{
  extensions = pie.array.change(extensions, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>, <span class="hljs-string">'compact'</span>);
  extensions.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ext)</span> </span>{
    pie.object.forEach(ext, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
      klass.prototype[k] = pie.base._wrap(v, klass.prototype[k]);
    });
  });
};

pie.base._wrap = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

  <span class="hljs-keyword">var</span> fnTest = <span class="hljs-regexp">/xyz/</span>.test(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-string">"xyz"</span>; });
  fnTest = fnTest ? <span class="hljs-regexp">/\b_super\b/</span> : <span class="hljs-regexp">/.*/</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(newF, oldF)</span> </span>{
    <span class="hljs-comment">/* jslint eqnull:true */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>if we’re not defining anything new, return the old definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(newF == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> oldF;</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>if there is no old definition</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(oldF == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> newF;</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>if we’re not overriding with a function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!pie.object.isFunction(newF)) <span class="hljs-keyword">return</span> newF;</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>if we’re not overriding a function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!pie.object.isFunction(oldF)) <span class="hljs-keyword">return</span> newF;</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>if it doesn’t call _super, don’t bother wrapping.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!fnTest.test(newF)) <span class="hljs-keyword">return</span> newF;

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">superWrapper</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> ret, sup = <span class="hljs-keyword">this</span>._super;
      <span class="hljs-keyword">this</span>._super = oldF;
      ret = newF.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
      <span class="hljs-keyword">if</span>(!sup) <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._super;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>._super = sup;
      <span class="hljs-keyword">return</span> ret;
    };
  };
})();</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <h1 id="pie-app">Pie App</h1>
<p>The app class is the entry point of your application. It acts as container in charge of managing the page’s context.
It provides access to application utilities, routing, templates, i18n, etc.
It observes navigation and changes the page’s context automatically.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.app = pie.base.extend(<span class="hljs-string">'app'</span>, {
  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p><code>pie.base.prototype.constructor</code> handles the setting of an app,
but we don’t want a reference to another app within this app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.app;</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>Set a global instance which can be used as a backup within the pie library.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pie.appInstance = pie.appInstance || <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>Register with pie to allow for nifty global lookups.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pie.apps[<span class="hljs-keyword">this</span>.pieId] = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>Default application options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.options = pie.object.deepMerge({
      uiTarget: <span class="hljs-string">'body'</span>,
      viewNamespace: <span class="hljs-string">'lib.views'</span>,
      unsupportedPath: <span class="hljs-string">'/browser/unsupported'</span>,
      verifySupport: <span class="hljs-literal">true</span>
    }, options);

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.verifySupport &amp;&amp; !<span class="hljs-keyword">this</span>.verifySupport()) {
      <span class="hljs-built_in">window</span>.location.href = <span class="hljs-keyword">this</span>.options.unsupportedPath;
      <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p><code>classOption</code> Allows class configurations to be provided in the following formats:</p>
<pre><code><span class="hljs-keyword">new</span> pie.app({
  i18n: myCustomI18nClass,
  i18nOptions: {foo: <span class="hljs-string">'bar'</span>}
});
<span class="hljs-comment">// which will result in `this.i18n = new myCustomI18nClass(this, {foo: 'bar'});`</span>
</code></pre><pre><code><span class="hljs-keyword">var</span> instance = <span class="hljs-keyword">new</span> myCustomI18nClass();
<span class="hljs-keyword">new</span> pie.app({
  i18n: instance,
});
<span class="hljs-comment">// which will result in `this.i18n = instance; this.i18n.app = this;`</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> classOption = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, _default)</span></span>{
      <span class="hljs-keyword">var</span> k = <span class="hljs-keyword">this</span>.options[key] || _default,
      opt = <span class="hljs-keyword">this</span>.options[key + <span class="hljs-string">'Options'</span>] || {};

      <span class="hljs-keyword">if</span>(pie.object.isFunction(k)) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> k(<span class="hljs-keyword">this</span>, opt);
      } <span class="hljs-keyword">else</span> {
        k.app = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> k;
      }
    }.bind(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p><code>app.cache</code> is a centralized cache store to be used by anyone.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.cache = <span class="hljs-keyword">new</span> pie.cache();</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p><code>app.emitter</code> is an interface for subscribing and observing app events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.emitter = classOption(<span class="hljs-string">'emitter'</span>, pie.emitter);</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p><code>app.i18n</code> is the translation functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.i18n = classOption(<span class="hljs-string">'i18n'</span>, pie.i18n);</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p><code>app.ajax</code> is ajax interface + app specific functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.ajax = classOption(<span class="hljs-string">'ajax'</span>, pie.ajax);</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p><code>app.notifier</code> is the object responsible for showing page-level notifications, alerts, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.notifier = classOption(<span class="hljs-string">'notifier'</span>, pie.notifier);</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p><code>app.errorHandler</code> is the object responsible for</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.errorHandler = classOption(<span class="hljs-string">'errorHandler'</span>, pie.errorHandler);</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p><code>app.router</code> is used to determine which view should be rendered based on the url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.router = classOption(<span class="hljs-string">'router'</span>, pie.router);</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p><code>app.resources</code> is used for managing the loading of external resources.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.resources = classOption(<span class="hljs-string">'resources'</span>, pie.resources);</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>Template helper methods are evaluated to the local variable <code>h</code> in templates.
Any methods registered with this helpers module will be available in templates
rendered by this app’s <code>templates</code> object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.helpers = classOption(<span class="hljs-string">'helpers'</span>, pie.helpers);</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p><code>app.templates</code> is used to manage application templates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.templates = classOption(<span class="hljs-string">'templates'</span>, pie.templates);</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p><code>app.navigator</code> is the only navigator which should exist and be used within this app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.navigator = classOption(<span class="hljs-string">'navigator'</span>, pie.navigator);</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p><code>app.validator</code> a validator intance to be used in conjunction with this app’s model activity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.validator = classOption(<span class="hljs-string">'validator'</span>, pie.validator);</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>The view transition class to be used when transitioning between pages.
Since a new instance of this is needed on every page change, just provide the class.
You can also provide viewTransitionOptions which will be merged into the constructor of this class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.viewTransitionClass = <span class="hljs-keyword">this</span>.options.viewTransitionClass || pie.simpleViewTransition;</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>After a navigation change, app.parsedUrl is the new parsed route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.parsedUrl = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>We observe the navigator and handle changing the context of the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.navigator.observe(<span class="hljs-keyword">this</span>.navigationChanged.bind(<span class="hljs-keyword">this</span>), <span class="hljs-string">'url'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>Before we get going, observe link navigation &amp; show any notifications stored
in localStorage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.emitter.once(<span class="hljs-string">'beforeStart'</span>, <span class="hljs-keyword">this</span>.setupSinglePageLinks.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.emitter.once(<span class="hljs-string">'afterStart'</span>, <span class="hljs-keyword">this</span>.showStoredNotifications.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.options.noAutoStart) {</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>Once the dom is loaded, start the app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-keyword">this</span>.start.bind(<span class="hljs-keyword">this</span>));
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>Just in case the client wants to override the standard confirmation dialog.
Eventually this could create a confirmation view and provide options to it.
The view could have more options but would always end up invoking onConfirm or onDeny.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  confirm: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.confirm(options.text)) {
      <span class="hljs-keyword">if</span>(options.onConfirm) options.onConfirm();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span>(options.onDeny) options.onDeny();
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>Print stuff if we’re not in prod.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  debug: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.env === <span class="hljs-string">'production'</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">console</span> &amp;&amp; <span class="hljs-built_in">console</span>.log) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'[PIE] '</span> + msg);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>Use this to navigate. This allows us to apply app-specific navigation logic
without altering the underling navigator.
This can be called with just a path, a path with a query object, or with notification arguments.
app.go(‘/test-url’)
app.go(‘/test-url’, true) // replaces state rather than adding
app.go([‘/test-url’, {foo: ‘bar’}]) // navigates to /test-url?foo=bar
app.go(‘/test-url’, true, ‘Thanks for your interest’) // replaces state with /test-url and shows the provided notification
app.go(‘/test-url’, ‘Thanks for your interest’) // navigates to /test-url and shows the provided notification</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  go: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>), path, notificationArgs, replaceState;

    path = args.shift();</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <pre><code><span class="hljs-built_in">arguments</span> =&gt; <span class="hljs-string">'/test-url'</span>, {query: <span class="hljs-string">'object'</span>}
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] === <span class="hljs-string">'object'</span>) {
      path = <span class="hljs-keyword">this</span>.router.path(path, args.shift());</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <pre><code>arguments =&gt; '/test-url
arguments =&gt; ['/test-url', {query: 'object'}]
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {
      path = <span class="hljs-keyword">this</span>.router.path.apply(<span class="hljs-keyword">this</span>.router, pie.array.from(path));
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>If the next argument is a boolean, we care about replaceState</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(pie.object.isBoolean(args[<span class="hljs-number">0</span>])) {
      replaceState = args.shift();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>Anything left is considered arguments for the notifier.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    notificationArgs = args;

    <span class="hljs-keyword">if</span>(pie.object.has(<span class="hljs-keyword">this</span>.router.parseUrl(path), <span class="hljs-string">'view'</span>)) {
      <span class="hljs-keyword">this</span>.navigator.go(path, {}, replaceState);
      <span class="hljs-keyword">if</span>(notificationArgs &amp;&amp; notificationArgs.length) {
        <span class="hljs-keyword">this</span>.notifier.notify.apply(<span class="hljs-keyword">this</span>.notifier, notificationArgs);
      }
    } <span class="hljs-keyword">else</span> {

      <span class="hljs-keyword">if</span>(notificationArgs &amp;&amp; notificationArgs.length) {
        <span class="hljs-keyword">this</span>.store(<span class="hljs-keyword">this</span>.notifier.storageKey, notificationArgs);
      }

      <span class="hljs-built_in">window</span>.location.href = path;
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p>Go back one page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  goBack: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">window</span>.history.back();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>Callback for when a link is clicked in our app</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  handleSinglePageLinkClick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>If the link is targeting something else, let the browser take over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(e.delegateTarget.getAttribute(<span class="hljs-string">'target'</span>)) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p>If the user is trying to do something beyond simple navigation, let the browser take over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(e.ctrlKey || e.metaKey) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p>Extract the location from the link.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> href = e.delegateTarget.getAttribute(<span class="hljs-string">'href'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p>If we’re going nowhere, somewhere else, or to an anchor on the page, let the browser take over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!href || <span class="hljs-regexp">/^(#|[a-z]+:\/\/)/</span>.test(href)) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>Ensure that relative links are evaluated as relative</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(href.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'?'</span>) href = <span class="hljs-built_in">window</span>.location.pathname + href;</pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <p>Great, we can handle it. let the app decide whether to use pushstate or not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    e.preventDefault();
    <span class="hljs-keyword">this</span>.go(href);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>When we change urls
We always remove the current before instantiating the next. this ensures are views can prepare
Context’s in removedFromParent before the constructor of the next view is invoked.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  navigationChanged: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> current  = <span class="hljs-keyword">this</span>.getChild(<span class="hljs-string">'currentView'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>Let the router determine our new url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.previousUrl = <span class="hljs-keyword">this</span>.parsedUrl;
    <span class="hljs-keyword">this</span>.parsedUrl = <span class="hljs-keyword">this</span>.router.parseUrl(<span class="hljs-keyword">this</span>.navigator.get(<span class="hljs-string">'fullPath'</span>));

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.previousUrl !== <span class="hljs-keyword">this</span>.parsedUrl) {
      <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'urlChanged'</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <p>Not necessary for a view to exist on each page.
Maybe the entry point is server generated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.parsedUrl.view) {

      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.parsedUrl.redirect) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">var</span> redirectTo = <span class="hljs-keyword">this</span>.parsedUrl.redirect;
      redirectTo = app.router.path(redirectTo, <span class="hljs-keyword">this</span>.parsedUrl.data);

      <span class="hljs-keyword">this</span>.go(redirectTo);
      <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p>if the view that’s in there is already loaded, don’t remove / add again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(current &amp;&amp; current._pieName === <span class="hljs-keyword">this</span>.parsedUrl.view) {
      <span class="hljs-keyword">if</span>(pie.object.has(current, <span class="hljs-string">'navigationUpdated'</span>, <span class="hljs-literal">true</span>)) current.navigationUpdated();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">this</span>.transitionToNewView();

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>The process for transitioning to a new view.
Both the current view and the next view are optional.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  transitionToNewView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> target = pie.qs(<span class="hljs-keyword">this</span>.options.uiTarget),
        current = <span class="hljs-keyword">this</span>.getChild(<span class="hljs-string">'currentView'</span>),
        viewClass, child, transition;</pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>Provide some events that can be observed around the transition process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'beforeViewChanged'</span>);
    <span class="hljs-keyword">this</span>.emitter.fireAround(<span class="hljs-string">'aroundViewChanged'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'viewChanged'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>Use the view key of the parsedUrl to find the viewClass.
At this point we’ve already verified the view option exists, so we don’t have to check it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      viewClass = pie.object.getPath(<span class="hljs-built_in">window</span>, <span class="hljs-keyword">this</span>.options.viewNamespace + <span class="hljs-string">'.'</span> + <span class="hljs-keyword">this</span>.parsedUrl.view);</pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>The instance to be added. If the class is not defined, this could and should blow up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      child = <span class="hljs-keyword">new</span> viewClass({ app: <span class="hljs-keyword">this</span> });</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>Cache an identifier on the view so we can invoke navigationUpdated instead of reloading
if the url changes but the view does not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      child._pieName = <span class="hljs-keyword">this</span>.parsedUrl.view;</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>Instantiate a transition object based on the app configuration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transition = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.viewTransitionClass(<span class="hljs-keyword">this</span>, pie.object.merge({
        oldChild: current,
        newChild: child,
        childName: <span class="hljs-string">'currentView'</span>,
        targetEl: target
      }, <span class="hljs-keyword">this</span>.options.viewTransitionOptions));</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>Provide a couple common events out of the app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transition.emitter.on(<span class="hljs-string">'afterRemoveOldChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'oldViewRemoved'</span>, current);
      }.bind(<span class="hljs-keyword">this</span>));

      transition.emitter.on(<span class="hljs-string">'afterTransition'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'newViewLoaded'</span>, child);
      }.bind(<span class="hljs-keyword">this</span>));

      transition.transition(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>The instance is now our ‘currentView’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'afterViewChanged'</span>);
      }.bind(<span class="hljs-keyword">this</span>));

    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p>Reload the page without reloading the browser.
Alters the current view’s _pieName to appear as invalid for the route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  refresh: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> current = <span class="hljs-keyword">this</span>.getChild(<span class="hljs-string">'currentView'</span>);
    current._pieName = <span class="hljs-string">'__remove__'</span>;
    <span class="hljs-keyword">this</span>.navigationChanged();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p>Safely access localStorage, passing along any errors for reporting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  retrieve: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, clear)</span> </span>{
    <span class="hljs-keyword">var</span> encoded, decoded;

    <span class="hljs-keyword">try</span>{
      encoded = <span class="hljs-built_in">window</span>.localStorage.getItem(key);
      decoded = encoded ? <span class="hljs-built_in">JSON</span>.parse(encoded) : <span class="hljs-literal">undefined</span>;
    }<span class="hljs-keyword">catch</span>(err){
      <span class="hljs-keyword">this</span>.errorHandler.reportError(err, {prefix: <span class="hljs-string">"[caught] app#retrieve/getItem:"</span>});
    }

    <span class="hljs-keyword">try</span>{
      <span class="hljs-keyword">if</span>(clear || clear === <span class="hljs-literal">undefined</span>){
        <span class="hljs-built_in">window</span>.localStorage.removeItem(key);
      }
    }<span class="hljs-keyword">catch</span>(err){
      <span class="hljs-keyword">this</span>.errorHandler.reportError(err, {prefix: <span class="hljs-string">"[caught] app#retrieve/removeItem:"</span>});
    }

    <span class="hljs-keyword">return</span> decoded;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>When a link is clicked, go there without a refresh if we recognize the route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setupSinglePageLinks: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> target = pie.qs(<span class="hljs-keyword">this</span>.options.navigationContainer || <span class="hljs-keyword">this</span>.options.uiTarget);
    pie.dom.on(target, <span class="hljs-string">'click'</span>, <span class="hljs-keyword">this</span>.handleSinglePageLinkClick.bind(<span class="hljs-keyword">this</span>), <span class="hljs-string">'a[href]'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p>Show any notification which have been preserved via local storage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  showStoredNotifications: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> messages = <span class="hljs-keyword">this</span>.retrieve(<span class="hljs-keyword">this</span>.notifier.storageKey);

    <span class="hljs-keyword">if</span>(messages &amp;&amp; messages.length) {
      <span class="hljs-keyword">this</span>.notifier.notify.apply(<span class="hljs-keyword">this</span>.notifier, messages);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p>Start the app by starting the navigator (which we have observed).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  start: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'start'</span>, <span class="hljs-keyword">this</span>.navigator.start.bind(<span class="hljs-keyword">this</span>.navigator));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>Safely access localStorage, passing along any errors for reporting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  store: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, data)</span> </span>{
    <span class="hljs-keyword">try</span>{
      <span class="hljs-built_in">window</span>.localStorage.setItem(key, <span class="hljs-built_in">JSON</span>.stringify(data));
    }<span class="hljs-keyword">catch</span>(err){
      <span class="hljs-keyword">this</span>.errorHandler.reportError(err, {prefix: <span class="hljs-string">"[caught] app#store:"</span>});
    }
  },

  verifySupport: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> el = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'_'</span>);

    <span class="hljs-keyword">return</span> !!(el.classList &amp;&amp;
      <span class="hljs-built_in">window</span>.history.pushState &amp;&amp;
      <span class="hljs-built_in">Date</span>.prototype.toISOString &amp;&amp;
      <span class="hljs-built_in">Array</span>.isArray &amp;&amp;
      <span class="hljs-built_in">Array</span>.prototype.forEach &amp;&amp;
      <span class="hljs-built_in">Object</span>.keys &amp;&amp;
      <span class="hljs-built_in">Number</span>.prototype.toFixed);
  }
}, pie.mixins.container);</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <h1 id="pie-model">Pie Model</h1>
<h3 id="setters-and-getters">Setters and Getters</h3>
<p>pie.model provides a basic interface for object management and observation.</p>
<p><em>example:</em></p>
<pre><code><span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> pie.model();
user.set(<span class="hljs-string">'first_name'</span>, <span class="hljs-string">'Doug'</span>);
user.get(<span class="hljs-string">'first_name'</span>) <span class="hljs-comment">//=&gt; 'Doug'</span>
user.sets({
  first_name: <span class="hljs-string">'Douglas'</span>,
  last_name: <span class="hljs-string">'Wilson'</span>
});
user.get(<span class="hljs-string">'last_name'</span>) <span class="hljs-comment">//= 'Wilson'</span>

user.set(<span class="hljs-string">'location.city'</span>, <span class="hljs-string">'Miami'</span>)
user.get(<span class="hljs-string">'location.city'</span>) <span class="hljs-comment">//=&gt; 'Miami'</span>
user.get(<span class="hljs-string">'location'</span>) <span class="hljs-comment">//=&gt; {city: 'Miami'}</span>
</code></pre><h3 id="observers">Observers</h3>
<p>Observers can be added by invoking the model’s <code>observe()</code> function.
<code>pie.model.observe()</code> optionally accepts 2+ arguments which are used as filters for the observer.</p>
<p><em>example:</em></p>
<pre><code><span class="hljs-keyword">var</span> o = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span></span>{ <span class="hljs-built_in">console</span>.log(changes); };
<span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> pie.model();
user.observe(o, <span class="hljs-string">'first_name'</span>);
user.sets({first_name: <span class="hljs-string">'first'</span>, last_name: <span class="hljs-string">'last'</span>});
<span class="hljs-comment">// =&gt; o is called and the following is logged:</span>
[{...}, {
  name: <span class="hljs-string">'first_name'</span>,
  type: <span class="hljs-string">'new'</span>,
  oldValue:
  <span class="hljs-literal">undefined</span>,
  value: <span class="hljs-string">'first'</span>,
  object: {...}
}]
</code></pre><p>Note that the changes are extended with the <code>pie.mixin.changeSet</code> functionality, so check that out too.</p>
<h3 id="computed-properties">Computed Properties</h3>
<p><code>pie.models</code> can observe themselves and compute properties. The computed properties can be observed
just like any other property.</p>
<p><em>example:</em></p>
<pre><code><span class="hljs-keyword">var</span> fullName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'first_name'</span>) + <span class="hljs-string">' '</span> + <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'last_name'</span>); };
<span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> pie.model({first_name: <span class="hljs-string">'Doug'</span>, last_name: <span class="hljs-string">'Wilson'</span>});
user.compute(<span class="hljs-string">'full_name'</span>, fullName, <span class="hljs-string">'first_name'</span>, <span class="hljs-string">'last_name'</span>);
user.get(<span class="hljs-string">'full_name'</span>) <span class="hljs-comment">//=&gt; 'Doug Wilson'</span>
user.observe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span></span>{ <span class="hljs-built_in">console</span>.log(changes); }, <span class="hljs-string">'full_name'</span>);
user.set(<span class="hljs-string">'first_name'</span>, <span class="hljs-string">'Douglas'</span>);
<span class="hljs-comment">// =&gt; the observer is invoked and console.log provides:</span>
[{..}, {
  name: <span class="hljs-string">'full_name'</span>,
  oldValue: <span class="hljs-string">'Doug Wilson'</span>,
  value: <span class="hljs-string">'Douglas Wilson'</span>,
  type: <span class="hljs-string">'update'</span>,
  object: {...}
}]
</code></pre><p>If a function is not provided as the definition of the computed property, it will look
for a matching function name within the model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

pie.model = pie.base.extend(<span class="hljs-string">'model'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d, options)</span> </span>{
    <span class="hljs-keyword">this</span>.data = pie.object.merge({_version: <span class="hljs-number">1</span>}, d);
    <span class="hljs-keyword">this</span>.options = options || {};
    <span class="hljs-keyword">this</span>.app = <span class="hljs-keyword">this</span>.app || <span class="hljs-keyword">this</span>.options.app || pie.appInstance;
    <span class="hljs-keyword">this</span>.observations = {};
    <span class="hljs-keyword">this</span>.changeRecords = [];
    <span class="hljs-keyword">this</span>.deliveringRecords = <span class="hljs-number">0</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p><strong> pie.model.compute </strong></p>
<p>Register a computed property which is accessible via <code>name</code> and defined by <code>fn</code>.
Provide all properties which invalidate the definition.
If the definition of the property is defined by a function of the same name, the function can be ommitted.</p>
<pre><code>Model.prototype.fullName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-comment">/*...*/</span> }
model.compute(<span class="hljs-string">'fullName'</span>, <span class="hljs-string">'first_name'</span>, <span class="hljs-string">'last_name'</span>);
model.compute(<span class="hljs-string">'displayName'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{}, <span class="hljs-string">'fullName'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  compute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* name, fn?[, prop1, prop2 ] */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> props = pie.array.from(<span class="hljs-built_in">arguments</span>),
    name = props.shift(),
    fn = props.shift(),
    wrap;

    <span class="hljs-keyword">if</span>(!pie.object.isFunction(fn)) {
      props.unshift(fn);
      fn = <span class="hljs-keyword">this</span>[name].bind(<span class="hljs-keyword">this</span>);
    }

    wrap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* changes */</span>)</span></span>{
      <span class="hljs-keyword">this</span>.set(name, fn.call(<span class="hljs-keyword">this</span>), {skipObservers: <span class="hljs-literal">true</span>});
    }.bind(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.observe(wrap, props);
    <span class="hljs-keyword">this</span>.observations[wrap.pieId].computed = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">/* Initialize the computed properties value immediately. */</span>
    <span class="hljs-keyword">this</span>.set(name, fn.call(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p><strong> pie.model.compute </strong></p>
<p>After updates have been made we deliver our change records to our observers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  deliverChangeRecords: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.changeRecords.length) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.deliveringRecords) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

    <span class="hljs-comment">/* This is where the version tracking is incremented. */</span>
    <span class="hljs-keyword">this</span>.trackVersion();


    <span class="hljs-keyword">var</span> changeSet = <span class="hljs-keyword">this</span>.changeRecords,
    observers = pie.object.values(<span class="hljs-keyword">this</span>.observations),
    invoker = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
      <span class="hljs-keyword">if</span>(changeSet.hasAny.apply(changeSet, obj.keys)) {
        obj.fn.call(<span class="hljs-literal">null</span>, changeSet);
      }
    },
    o, idx;

    <span class="hljs-comment">/* We modify the `changeSet` array with the `pie.mixins.changeSet`. */</span>
    pie.object.merge(changeSet, pie.mixins.changeSet);


    <span class="hljs-comment">/* Deliver change records to all computed properties first. */</span>
    <span class="hljs-comment">/* This will ensure that the change records include the computed property changes */</span>
    <span class="hljs-comment">/* along with the original property changes. */</span>
    <span class="hljs-keyword">while</span>(~(idx = pie.array.indexOf(observers, <span class="hljs-string">'computed'</span>))) {
      o = observers[idx];
      observers.splice(idx, <span class="hljs-number">1</span>);
      invoker(o);
    }

    <span class="hljs-comment">/* Now we reset the changeRecords on this model. */</span>
    <span class="hljs-keyword">this</span>.changeRecords = [];

    <span class="hljs-comment">/* We increment our deliveringRecords flag to ensure records are delivered in the correct order */</span>
    <span class="hljs-keyword">this</span>.deliveringRecords++;

    <span class="hljs-comment">/* And deliver the changeSet to each observer. */</span>
    observers.forEach(invoker);

    <span class="hljs-comment">/* Now we can decrement our deliveringRecords flag and attempt to deliver any leftover records */</span>
    <span class="hljs-keyword">this</span>.deliveringRecords--;
    <span class="hljs-keyword">this</span>.deliverChangeRecords();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p><strong> pie.model.get </strong></p>
<p>Access the value stored at data[key]
Key can be multiple levels deep by providing a dot separated key.</p>
<pre><code>model.get(<span class="hljs-string">'foo'</span>)
<span class="hljs-comment">//=&gt; 'bar'</span>
model.get(<span class="hljs-string">'bar.baz'</span>)
<span class="hljs-comment">//=&gt; undefined</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">return</span> pie.object.getPath(<span class="hljs-keyword">this</span>.data, key);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p><strong> pie.model.getOrSet </strong></p>
<p>Retrieve or set a key within the model.
The <code>defaultValue</code> will only be used if the value at <code>key</code> is <code>== null</code>.</p>
<pre><code>model.getOrSet(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'theFirstValue'</span>);
<span class="hljs-comment">//=&gt; 'theFirstValue'</span>
model.getOrSet(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'theSecondValue'</span>);
<span class="hljs-comment">//=&gt; 'theFirstValue'</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  getOrSet: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, defaultValue)</span> </span>{
    <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">this</span>.get(key);
    <span class="hljs-keyword">if</span>(val != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> val;

    <span class="hljs-keyword">this</span>.set(key, defaultValue);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(key);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p><strong> pie.model.gets </strong></p>
<p>Retrieve multiple values at once.
Returns an object of names &amp; values.
Path keys will be transformed into objects.</p>
<pre><code>model.gets(<span class="hljs-string">'foo.baz'</span>, <span class="hljs-string">'bar'</span>);
<span class="hljs-comment">//=&gt; {foo: {baz: 'fooBazValue'}, bar: 'barValue'}</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  gets: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>, <span class="hljs-string">'compact'</span>),
    o = {};

    args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arg)</span></span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(arg)) {
        pie.object.setPath(o, arg, <span class="hljs-keyword">this</span>.get(arg));
      }
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> o;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p><strong> pie.model.has </strong></p>
<p>Determines whether a path exists in our data.</p>
<pre><code>model.has(<span class="hljs-string">'foo.bar'</span>)
<span class="hljs-comment">//=&gt; true | false</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  has: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">return</span> !!pie.object.hasPath(<span class="hljs-keyword">this</span>.data, path);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p><strong> pie.model.observe </strong></p>
<p>Register an observer and optionally filter by key.
If no keys are provided, any change will result in the observer being triggered.</p>
<pre><code>model.observe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changeSet)</span></span>{
  <span class="hljs-built_in">console</span>.log(changeSet);
});
</code></pre><pre><code>model.observe(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changeSet)</span></span>{
  <span class="hljs-built_in">console</span>.log(changeSet);
}, <span class="hljs-string">'fullName'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  observe: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* fn[, key1, key2, key3] */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> keys = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>),
    fn = keys.shift();

    <span class="hljs-comment">/* Setting the uid is needed because we'll want to manage unobservation effectively. */</span>
    pie.setUid(fn);


    <span class="hljs-keyword">if</span>(!keys.length) keys = [<span class="hljs-string">'_version'</span>];

    <span class="hljs-keyword">this</span>.observations[fn.pieId] = {
      fn: fn,
      keys: keys
    };

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p><strong> pie.model.reset </strong></p>
<p>Reset a model to it’s empty state, without affecting the <code>_version</code> attribute.
Optionally, you can pass any options which are valid to <code>sets</code>.</p>
<pre><code>model.reset({skipObservers: <span class="hljs-literal">true</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.data), o = {};

    keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
      <span class="hljs-keyword">if</span>(k === <span class="hljs-string">'_version'</span>) <span class="hljs-keyword">return</span>;
      o[k] = <span class="hljs-literal">undefined</span>;
    });

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sets(o, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p><strong> pie.model.set </strong></p>
<p>Set a <code>value</code> on the model at the specified <code>key</code>.
Valid options are:</p>
<ul>
<li>skipObservers - when true, observers will not be triggered.</li>
<li>noRecursive   - when true, subpath change records will not be sent.</li>
<li>noDeleteRecursive - when true, a subpath will not be deleted if the new value is <code>undefined</code>.</li>
</ul>
<p><em>Note: skipping observation does not stop <code>changeRecords</code> from accruing.</em></p>
<pre><code>model.set(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>);
model.set(<span class="hljs-string">'foo.baz'</span>, <span class="hljs-string">'bar'</span>);
model.set(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, {skipObservers: <span class="hljs-literal">true</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, options)</span> </span>{
    <span class="hljs-keyword">var</span> recursive = (!options || !options.noRecursive),
    deleteRecursive = (!options || !options.noDeleteRecursive),
    steps = ~key.indexOf(<span class="hljs-string">'.'</span>) &amp;&amp; recursive ? pie.string.pathSteps(key) : <span class="hljs-literal">null</span>,
    o, oldKeys, type, change;

    change = { name: key, object: <span class="hljs-keyword">this</span>.data };

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(key)) {
      change.type = <span class="hljs-string">'update'</span>;
      change.oldValue = pie.object.getPath(<span class="hljs-keyword">this</span>.data, key);

      <span class="hljs-comment">/* If we haven't actually changed, don't bother doing anything. */</span>
      <span class="hljs-keyword">if</span>((!options || !options.force) &amp;&amp; value === change.oldValue) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

    <span class="hljs-keyword">if</span>(steps) {
      steps.shift();
      steps = steps.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(step)</span> </span>{
        o = <span class="hljs-keyword">this</span>.get(step);
        <span class="hljs-keyword">return</span> [step, o &amp;&amp; <span class="hljs-built_in">Object</span>.keys(o)];
      }.bind(<span class="hljs-keyword">this</span>));
    }

    change.value = value;

    <span class="hljs-comment">/* If we are "unsetting" the value, delete the path from `this.data`. */</span>
    <span class="hljs-keyword">if</span>(value === <span class="hljs-literal">undefined</span>) {
      pie.object.deletePath(<span class="hljs-keyword">this</span>.data, key, deleteRecursive);
      change.type = <span class="hljs-string">'delete'</span>;

    <span class="hljs-comment">/* Otherwise, we set the value within `this.data`. */</span>
    } <span class="hljs-keyword">else</span> {
      pie.object.setPath(<span class="hljs-keyword">this</span>.data, key, value);
      change.type = change.type || <span class="hljs-string">'add'</span>;
    }

    <span class="hljs-comment">/* Add the change to the `changeRecords`. */</span>
    <span class="hljs-keyword">this</span>.changeRecords.push(change);

    <span class="hljs-comment">/* Compile subpath change records. */</span>
    <span class="hljs-comment">/* Subpath change records have the same structure but for performance reasons the */</span>
    <span class="hljs-comment">/* oldValue &amp; value are the sets of the keys rather than the object itself. */</span>
    <span class="hljs-keyword">if</span>(steps) {
      steps.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(step)</span> </span>{
        oldKeys = step[<span class="hljs-number">1</span>];
        step = step[<span class="hljs-number">0</span>];

        o = <span class="hljs-keyword">this</span>.get(step);

        <span class="hljs-comment">/* If we deleted the end of the branch, */</span>
        <span class="hljs-comment">/* we may have deleted the object itself. */</span>
        <span class="hljs-keyword">if</span>(change.type === <span class="hljs-string">'delete'</span>) {
          type = o ? <span class="hljs-string">'update'</span> : <span class="hljs-string">'delete'</span>;
        <span class="hljs-comment">/* If there are no old keys, we are new. */</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!oldKeys) {
          type = <span class="hljs-string">'add'</span>;
        <span class="hljs-comment">/* Otherwise, we just updated. */</span>
        } <span class="hljs-keyword">else</span> {
          type = <span class="hljs-string">'update'</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>Create the change record with the old &amp; new keys.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.changeRecords.push({
          type: type,
          oldValue: oldKeys,
          value: o ? <span class="hljs-built_in">Object</span>.keys(o) : <span class="hljs-literal">undefined</span>,
          name: step,
          object: <span class="hljs-keyword">this</span>.data
        });
      }.bind(<span class="hljs-keyword">this</span>));
    }

    <span class="hljs-keyword">if</span>(options &amp;&amp; options.skipObservers) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deliverChangeRecords();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p><strong> pie.model.sets </strong></p>
<p>Set a bunch of stuff at once.
Change records will not be delivered until all keys have been set.</p>
<pre><code>model.sets({foo: <span class="hljs-string">'bar'</span>, baz: <span class="hljs-string">'qux'</span>}, {skipObservers: treu});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  sets: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, options)</span> </span>{
    pie.object.forEach(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
      <span class="hljs-keyword">this</span>.set(k, v, {skipObservers: <span class="hljs-literal">true</span>});
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">if</span>(options &amp;&amp; options.skipObservers) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deliverChangeRecords();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p><strong> pie.model.trackVersion </strong></p>
<p>Increment the <code>_version</code> of this model.
Observers are skipped since this is invoked while change records are delivered.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  trackVersion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'_version'</span>, <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'_version'</span>) + <span class="hljs-number">1</span>, {skipObservers: <span class="hljs-literal">true</span>});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p><strong> pie.model.unobserve </strong></p>
<p>Unregister an observer. Optionally for specific keys.
If a subset of the original keys are provided it will only unregister
for those provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unobserve: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* fn[, key1, key2, key3] */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> keys = pie.array.from(<span class="hljs-built_in">arguments</span>),
    fn = keys.shift(),
    observation;

    pie.setUid(fn);

    observation = <span class="hljs-keyword">this</span>.observations[fn.pieId];

    <span class="hljs-keyword">if</span>(!observation) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span>(!keys.length) {
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.observations[fn.pieId];
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

    observation.keys = pie.array.subtract(observation.keys, keys);
    <span class="hljs-keyword">if</span>(!observation.keys.length) {
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.observations[fn.pieId];
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>pie.view manages events delegation, provides some convenience methods, and some <form> standards.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.view = pie.base.extend(<span class="hljs-string">'view'</span>);

pie.view.prototype.constructor = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">view</span><span class="hljs-params">()</span> </span>{
  pie.base.prototype.constructor.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.setup) <span class="hljs-keyword">this</span>.setup();
};

pie.view.reopen({

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">this</span>.options = options || {},
    <span class="hljs-keyword">this</span>.app = <span class="hljs-keyword">this</span>.options.app || pie.appInstance;
    <span class="hljs-keyword">this</span>.el = <span class="hljs-keyword">this</span>.options.el || pie.dom.createElement(<span class="hljs-string">'&lt;div&gt;&lt;/div&gt;'</span>);
    <span class="hljs-keyword">this</span>.eventedEls = [];
    <span class="hljs-keyword">this</span>.changeCallbacks = [];

    <span class="hljs-keyword">this</span>.emitter = <span class="hljs-keyword">new</span> pie.emitter();

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.uiTarget) {
      <span class="hljs-keyword">this</span>.emitter.once(<span class="hljs-string">'afterSetup'</span>, <span class="hljs-keyword">this</span>.appendToDom.bind(<span class="hljs-keyword">this</span>));
    }
  },

  addedToParent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'addedToParent'</span>);
  },

  appendToDom: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(target)</span> </span>{
    target = target || <span class="hljs-keyword">this</span>.options.uiTarget;
    <span class="hljs-keyword">if</span>(target !== <span class="hljs-keyword">this</span>.el.parentNode) {
      <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'attach'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        target.appendChild(<span class="hljs-keyword">this</span>.el);
      }.bind(<span class="hljs-keyword">this</span>));
    }
  },

  consumeEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, immediate)</span> </span>{
    <span class="hljs-keyword">if</span>(e) {
      e.preventDefault();
      e.stopPropagation();
      <span class="hljs-keyword">if</span>(immediate) e.stopImmediatePropagation();
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>all events observed using view.on() will use the unique namespace for this instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  eventNamespace: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">'view'</span>+ <span class="hljs-keyword">this</span>.pieId;
  },


  navigationUpdated: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'navigationUpdated'</span>);
    <span class="hljs-keyword">this</span>.children.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span>{
      <span class="hljs-keyword">if</span>(pie.object.has(c, <span class="hljs-string">'navigationUpdated'</span>, <span class="hljs-literal">true</span>)) c.navigationUpdated();
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p>Events should be observed via this .on() method. Using .on() ensures the events will be
unobserved when the view is removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  on: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, sel, f, el)</span> </span>{
    el = el || <span class="hljs-keyword">this</span>.el;
    <span class="hljs-keyword">if</span>(!~<span class="hljs-keyword">this</span>.eventedEls.indexOf(el)) <span class="hljs-keyword">this</span>.eventedEls.push(el);

    <span class="hljs-keyword">var</span> ns = <span class="hljs-keyword">this</span>.eventNamespace(),
        f2 = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{
          <span class="hljs-keyword">if</span>(e.namespace === ns) {
            <span class="hljs-keyword">return</span> f.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
          }
        };

    e.split(<span class="hljs-string">' '</span>).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ev)</span> </span>{
      ev += <span class="hljs-string">"."</span> + ns;
      pie.dom.on(el, ev, f2, sel);
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <p>Observe changes to an observable, unobserving them when the view is removed.
If the object is not observable, an error will be thrown.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onChange: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> observable = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>], args = pie.array.from(<span class="hljs-built_in">arguments</span>).slice(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span>(!pie.object.has(observable, <span class="hljs-string">'observe'</span>, <span class="hljs-literal">true</span>)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Observable does not respond to observe"</span>);

    <span class="hljs-keyword">this</span>.changeCallbacks.push([observable, args]);
    observable.observe.apply(observable, args);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p>shortcut for this.el.querySelector</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  qs: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(selector)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.el.querySelector(selector);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p>shortcut for this.el.querySelectorAll</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  qsa: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(selector)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.el.querySelectorAll(selector);
  },

  removeFromDom: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.el.parentNode) {
      <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'detach'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.el.parentNode.removeChild(<span class="hljs-keyword">this</span>.el);
      }.bind(<span class="hljs-keyword">this</span>));
    }
  },

  removedFromParent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'removedFromParent'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p>placeholder for default functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'setup'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  teardown: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'teardown'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

      <span class="hljs-keyword">this</span>.removeFromDom();

      <span class="hljs-keyword">this</span>._unobserveEvents();
      <span class="hljs-keyword">this</span>._unobserveChangeCallbacks();

      <span class="hljs-keyword">this</span>.teardownChildren();</pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>views remove their children upon removal to ensure all irrelevant observations are cleaned up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.removeChildren();

    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  teardownChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.children.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span> </span>{
      <span class="hljs-keyword">if</span>(child.teardown) child.teardown();
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <p>release all observed events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _unobserveEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> key = <span class="hljs-string">'*.'</span> + <span class="hljs-keyword">this</span>.eventNamespace();
    <span class="hljs-keyword">this</span>.eventedEls.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
      pie.dom.off(el, key);
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              <p>release all change callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _unobserveChangeCallbacks: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> a;
    <span class="hljs-keyword">while</span>(<span class="hljs-keyword">this</span>.changeCallbacks.length) {
      a = <span class="hljs-keyword">this</span>.changeCallbacks.pop();
      a[<span class="hljs-number">0</span>].unobserve.apply(a[<span class="hljs-number">0</span>], a[<span class="hljs-number">1</span>]);
    }
  }

}, pie.mixins.container);</pre></div></div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <p>a view class which handles some basic functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.activeView = pie.view.extend(<span class="hljs-string">'activeView'</span>, {

  setup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.autoRender &amp;&amp; <span class="hljs-keyword">this</span>.model) {
      <span class="hljs-keyword">var</span> field = pie.object.isString(<span class="hljs-keyword">this</span>.options.autoRender) ? <span class="hljs-keyword">this</span>.options.autoRender : <span class="hljs-string">'_version'</span>;
      <span class="hljs-keyword">this</span>.onChange(<span class="hljs-keyword">this</span>.model, <span class="hljs-keyword">this</span>.render.bind(<span class="hljs-keyword">this</span>), field);
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.renderOnSetup) {
      <span class="hljs-keyword">this</span>.emitter.once(<span class="hljs-string">'setup'</span>, <span class="hljs-keyword">this</span>.render.bind(<span class="hljs-keyword">this</span>));
    }

    <span class="hljs-keyword">this</span>.emitter.on(<span class="hljs-string">'render'</span>, <span class="hljs-keyword">this</span>._renderTemplateToEl.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">this</span>._super();
  },

  _renderTemplateToEl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> templateName = <span class="hljs-keyword">this</span>.templateName();

    <span class="hljs-keyword">if</span>(templateName) {
      <span class="hljs-keyword">var</span> content = <span class="hljs-keyword">this</span>.app.templates.render(templateName, <span class="hljs-keyword">this</span>.renderData());
      <span class="hljs-keyword">this</span>.el.innerHTML = content;
    }
  },

  renderData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.model) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.model.data;
    }

    <span class="hljs-keyword">return</span> {};
  },

  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fireSequence(<span class="hljs-string">'render'</span>);
  },

  templateName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.options.template;
  }

});
pie.ajaxRequest = pie.model.extend(<span class="hljs-string">'ajaxRequest'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, options)</span> </span>{
    <span class="hljs-keyword">this</span>._super(data, options);

    <span class="hljs-keyword">this</span>.getOrSet(<span class="hljs-string">'headers'</span>, {});

    <span class="hljs-keyword">this</span>.xhr = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.emitter = <span class="hljs-keyword">new</span> pie.emitter();

    <span class="hljs-keyword">this</span>.validates({
      url: { presence: <span class="hljs-literal">true</span> },
      verb: { inclusion: { <span class="hljs-keyword">in</span>: pie.object.values(<span class="hljs-keyword">this</span>.VERBS) }}
    }, <span class="hljs-literal">null</span>);
  },

  VERBS: {
    del: <span class="hljs-string">'DELETE'</span>,
    get: <span class="hljs-string">'GET'</span>,
    patch: <span class="hljs-string">'PATCH'</span>,
    post: <span class="hljs-string">'POST'</span>,
    put: <span class="hljs-string">'PUT'</span>
  },

  _append: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, fns, immediate)</span> </span>{
    fns = pie.array.change(fns, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>);
    fns.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn)</span></span>{
      <span class="hljs-keyword">this</span>.emitter.on(name, fn, {immediate: immediate});
    }.bind(<span class="hljs-keyword">this</span>));
  },

  _onDataSuccess: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'dataSuccess'</span>, data);
  },

  _onSetModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'setModel'</span>, data);
  },

  _onSuccess: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, xhr)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'success'</span>, data, xhr);
  },

  _onComplete: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'complete'</span>, xhr);
  },

  _onError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'error'</span>, xhr);
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'extraError'</span>, xhr);
  },

  _onProgress: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'progress'</span>, event);
  },

  _onUploadProgress: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'uploadProgress'</span>, event);
  },

  _parseOptions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">if</span>(!options) <span class="hljs-keyword">return</span>;

    options = pie.object.merge({}, options);

    [<span class="hljs-string">'setup'</span>, <span class="hljs-string">'complete'</span>, <span class="hljs-string">'dataSuccess'</span>, <span class="hljs-string">'error'</span>, <span class="hljs-string">'extraError'</span>, <span class="hljs-string">'progress'</span>, <span class="hljs-string">'success'</span>, <span class="hljs-string">'uploadProgress'</span>, <span class="hljs-string">'setModel'</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span></span>{
      <span class="hljs-keyword">if</span>(options[n]) {

        pie.array.from(options[n]).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn)</span></span>{
          <span class="hljs-keyword">this</span>[n](fn);
        }.bind(<span class="hljs-keyword">this</span>));

        <span class="hljs-keyword">delete</span> options[n];
      }
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">this</span>.sets(options);
  },

  _validateOptions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              <p>upcase before we validate inclusion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'verb'</span>)) <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'verb'</span>, <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'verb'</span>).toUpperCase());

    <span class="hljs-keyword">this</span>.validateAll(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bool)</span></span>{
      <span class="hljs-keyword">if</span>(!bool) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'validationErrors'</span>)));
      cb();
    }.bind(<span class="hljs-keyword">this</span>));
  },

  _applyHeaders: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{

    <span class="hljs-keyword">var</span> accept = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'accept'</span>),
    contentType = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'contentType'</span>),
    headers = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'headers'</span>),
    data = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'data'</span>);

    <span class="hljs-keyword">this</span>._applyCsrfToken(xhr);

    <span class="hljs-keyword">if</span>(accept) {
      headers[<span class="hljs-string">'Accept'</span>] = accept;
    }

    <span class="hljs-keyword">if</span>(contentType !== <span class="hljs-literal">false</span>) {

      <span class="hljs-keyword">if</span>(contentType) {
        headers[<span class="hljs-string">'Content-Type'</span>] = contentType;
      }

      <span class="hljs-keyword">if</span>(!headers[<span class="hljs-string">'Content-Type'</span>]) {
        <span class="hljs-keyword">if</span>(pie.object.isString(data) || <span class="hljs-built_in">window</span>.formData &amp;&amp; data <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">window</span>.FormData) {
          headers[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'application/x-www-form-urlencoded'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              <p>if we aren’t already sending a string, we will encode to json.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {
          headers[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'application/json'</span>;
        }
      }

    }

    pie.object.forEach(headers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
      xhr.setRequestHeader(k, v);
    });

  },

  _applyCsrfToken: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{

    <span class="hljs-keyword">var</span> cache = <span class="hljs-keyword">this</span>.app.cache,
    token = pie.fn.valueFrom(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'csrfToken'</span>));

    <span class="hljs-keyword">if</span>(!token) {
      token = cache.getOrSet(<span class="hljs-string">'csrfToken'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> el = pie.qs(<span class="hljs-string">'meta[name="csrf-token"]'</span>);
        <span class="hljs-keyword">return</span> el ? el.getAttribute(<span class="hljs-string">'content'</span>) : <span class="hljs-literal">null</span>;
      });
    }

    <span class="hljs-keyword">if</span>(token) {
      xhr.setRequestHeader(<span class="hljs-string">'X-CSRF-Token'</span>, token);
    }
  },

  _parseResponse: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
    <span class="hljs-keyword">var</span> accept = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'accept'</span>),
    parser = accept &amp;&amp; <span class="hljs-keyword">this</span>.responseParsers[accept] || <span class="hljs-keyword">this</span>.responseParsers.default;
    xhr.data = <span class="hljs-keyword">this</span>.response = parser.call(<span class="hljs-keyword">this</span>, xhr);
  },

  responseParsers: {

    <span class="hljs-string">"application/json"</span> : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
      <span class="hljs-keyword">try</span>{
        <span class="hljs-keyword">return</span> xhr.responseText.trim().length ? <span class="hljs-built_in">JSON</span>.parse(xhr.responseText) : {};
      } <span class="hljs-keyword">catch</span>(err) {
        <span class="hljs-keyword">this</span>.app.debug(<span class="hljs-string">"could not parse JSON response: "</span> + err);
        <span class="hljs-keyword">return</span> {};
      }
    },

    <span class="hljs-string">"default"</span> : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
      <span class="hljs-keyword">return</span> xhr.responseText;
    }
  },

  _buildXhr: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest(),
    url = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'url'</span>),
    verb = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'verb'</span>),
    data = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'data'</span>),
    tracker = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'tracker'</span>),
    self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span>(verb === <span class="hljs-keyword">this</span>.VERBS.get &amp;&amp; data) {
      url = pie.string.urlConcat(url, pie.object.serialize(data));
    }

    url = pie.string.normalizeUrl(url);

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.hasCallback(<span class="hljs-string">'progress'</span>)) {
      xhr.addEventListener(<span class="hljs-string">'progress'</span>, <span class="hljs-keyword">this</span>._onProgress.bind(<span class="hljs-keyword">this</span>), <span class="hljs-literal">false</span>);
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.hasCallback(<span class="hljs-string">'uploadProgress'</span>)) {
      xhr.upload.addEventListener(<span class="hljs-string">'progress'</span>, <span class="hljs-keyword">this</span>._onUploadProgress.bind(<span class="hljs-keyword">this</span>), <span class="hljs-literal">false</span>);
    }

    xhr.open(verb, url, <span class="hljs-literal">true</span>);

    <span class="hljs-keyword">this</span>._applyHeaders(xhr);
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'setup'</span>, xhr, <span class="hljs-keyword">this</span>);

    xhr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span>(tracker) tracker(xhr, self);

      self._parseResponse(xhr);

      <span class="hljs-keyword">if</span>(xhr.status &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.status &lt; <span class="hljs-number">300</span> || xhr.status === <span class="hljs-number">304</span>) {
        self._onDataSuccess(self.response);
        self._onSetModel(self.response);
        self._onSuccess(self.response, xhr);
      } <span class="hljs-keyword">else</span> {
        self._onError(xhr);
      }

      self._onComplete(xhr);
    };

    <span class="hljs-keyword">this</span>.xhr = xhr;

    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'xhrBuilt'</span>);

    <span class="hljs-keyword">return</span> xhr;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              <p>Validate the options and build the xhr object.
By default, it immediately sends the request.
By passing <code>skipSend = false</code> you can manage the <code>send()</code> invocation manually.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  build: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    <span class="hljs-keyword">this</span>._parseOptions(options);
    <span class="hljs-keyword">this</span>._validateOptions(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">this</span>._buildXhr();
      <span class="hljs-keyword">if</span>(!skipSend) <span class="hljs-keyword">this</span>.send();
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p>Send the xhr. Assumes build() has been called.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  send: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'data'</span>), d;

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'verb'</span>) !== <span class="hljs-keyword">this</span>.VERBS.get) {

      <span class="hljs-keyword">if</span>(data) {
        <span class="hljs-keyword">if</span>(pie.object.isString(data)) {
          d = data;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.FormData &amp;&amp; data <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">window</span>.FormData) {
          d = data;
        } <span class="hljs-keyword">else</span> {
          d = <span class="hljs-built_in">JSON</span>.stringify(pie.object.compact(data));
        }
      } <span class="hljs-keyword">else</span> {
        d = <span class="hljs-literal">undefined</span>;
      }
    }

    <span class="hljs-keyword">this</span>.xhr.send(d);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              <p>Check if a callback is registered for a specific event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasCallback: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emitter.hasCallback(eventName);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              <p>Register callbacks to be invoked as part of the setup process.
Callbacks are provided with the xhr &amp; the request object (this).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'setup'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <p>Utility method for clearing previous / default events out
request.clear(‘error’).error(myErrorHandler);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.clear(eventName);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              <p>Register a callback for when the request is complete.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  complete: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'complete'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              <p>Register a callback which will only receive the parsed data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dataSuccess: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'dataSuccess'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              <p>Register a callback when the request is unsuccessful.
<code>app.ajax</code> will provide a default error callback as long as the <code>error</code> callbacks are empty.
If you would like the default &amp; your error callback, use extraError.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'error'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              <p>Register a callback when the request is unsuccessful.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  extraError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'extraError'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  setModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> fns = pie.array.from(<span class="hljs-built_in">arguments</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span></span>{ <span class="hljs-keyword">return</span> m.sets.bind(m); });
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'setModel'</span>, fns, <span class="hljs-literal">true</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              <p>Register a callback when the request succeeds.
Callbacks are invoked with the parsed response &amp; the xhr object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'success'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              <p>Register a callback to be invoked when progress events are triggered from the request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  progress: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'progress'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              <p>Register a callback to be invoked when upload progress events are triggered from the request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  uploadProgress: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._append(<span class="hljs-string">'uploadProgress'</span>, <span class="hljs-built_in">arguments</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

}, pie.mixins.validatable);
pie.ajax = pie.base.extend(<span class="hljs-string">'ajax'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span></span>{
    <span class="hljs-keyword">this</span>.app = app;
  },

  defaultAjaxOptions: {
    verb: <span class="hljs-string">'GET'</span>,
    accept: <span class="hljs-string">'application/json'</span>,
    headers: {}
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p>Interface for conducting ajax requests.
Returns a pie.ajaxRequest object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ajax: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    <span class="hljs-keyword">if</span>(pie.object.isString(options)) options = {url: options};

    options = pie.object.deepMerge({}, <span class="hljs-keyword">this</span>.defaultAjaxOptions, options);

    <span class="hljs-keyword">var</span> request = <span class="hljs-keyword">new</span> pie.ajaxRequest({}, { app: <span class="hljs-keyword">this</span>.app });
    request.build(options, skipSend);

    <span class="hljs-comment">/* add a default error handler if the user hasn't provided one. */</span>
    <span class="hljs-keyword">if</span>(!request.emitter.hasCallback(<span class="hljs-string">'error'</span>)) {
      request.error(<span class="hljs-keyword">this</span>.app.errorHandler.handleXhrError.bind(<span class="hljs-keyword">this</span>.app.errorHandler));
    }

    <span class="hljs-keyword">return</span> request;
  },


  del: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    options = pie.object.merge({verb: <span class="hljs-string">'DELETE'</span>}, options);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options, skipSend);
  },

  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    options = pie.object.merge({verb: <span class="hljs-string">'GET'</span>}, options);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options, skipSend);
  },

  patch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    options = pie.object.merge({verb: <span class="hljs-string">'PATCH'</span>}, options);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options, skipSend);
  },

  post: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    options = pie.object.merge({verb: <span class="hljs-string">'POST'</span>}, options);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options, skipSend);
  },

  put: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, skipSend)</span> </span>{
    options = pie.object.merge({verb: <span class="hljs-string">'PUT'</span>}, options);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ajax(options, skipSend);
  }

});
pie.cache = pie.model.extend(<span class="hljs-string">'cache'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, options)</span> </span>{
    <span class="hljs-keyword">this</span>._super(data, options);
  },

  clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.reset();
  },

  del: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">this</span>.set(path, <span class="hljs-literal">undefined</span>);
  },

  expire: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, ttl)</span> </span>{
    <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.get(path);

    <span class="hljs-keyword">if</span>(value === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">this</span>.set(path, value, {ttl: ttl});
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">var</span> wrap = pie.model.prototype.get.call(<span class="hljs-keyword">this</span>, path);
    <span class="hljs-keyword">if</span>(!wrap) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">if</span>(wrap.expiresAt &amp;&amp; wrap.expiresAt &lt;= <span class="hljs-keyword">this</span>.currentTime()) {
      <span class="hljs-keyword">this</span>.set(path, <span class="hljs-literal">undefined</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    }

    <span class="hljs-keyword">return</span> wrap.data;
  },

  getOrSet: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, value, options)</span> </span>{
    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">this</span>.get(path);
    <span class="hljs-keyword">if</span>(result !== <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span> result;
    value = pie.fn.valueFrom(value);
    <span class="hljs-keyword">this</span>.set(path, value, options);
    <span class="hljs-keyword">return</span> value;
  },

  set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, value, options)</span> </span>{
    <span class="hljs-keyword">if</span>(value === <span class="hljs-literal">undefined</span>) {
      pie.model.prototype.set.call(<span class="hljs-keyword">this</span>, path, <span class="hljs-literal">undefined</span>, options);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> wrap = <span class="hljs-keyword">this</span>.wrap(value, options);
      pie.model.prototype.set.call(<span class="hljs-keyword">this</span>, path, wrap, options);
    }
  },

  wrap: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, options)</span> </span>{
    options = options || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p>it could come in on a couple different keys.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> expiresAt = options.expiresAt || options.expiresIn || options.ttl;

    <span class="hljs-keyword">if</span>(expiresAt) {</pre></div></div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              <p>make sure we don’t have a date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(expiresAt <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>) expiresAt = expiresAt.getTime();</pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              <p>or a string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(pie.object.isString(expiresAt)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p>check for a numeric</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/^\d+$/</span>.test(expiresAt)) expiresAt = <span class="hljs-built_in">parseInt</span>(expiresAt, <span class="hljs-number">10</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              <p>otherwise assume ISO</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">else</span> expiresAt = pie.date.timeFromISO(expiresAt).getTime();
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              <p>we’re dealing with something smaller than a current milli epoch, assume we’re dealing with a ttl.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">String</span>(expiresAt).length &lt; <span class="hljs-number">13</span>) expiresAt = <span class="hljs-keyword">this</span>.currentTime() + expiresAt;
    }

    <span class="hljs-keyword">return</span> {
      data: obj,
      expiresAt: expiresAt
    };
  },

  currentTime: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> pie.date.now();
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              <h1 id="pie-emitter">Pie Emitter</h1>
<p>An emitter is an event subscriber &amp; notifier. It’s similar to a pubsub implementation but
allows for blocking of an event via <code>around</code> callbacks. It’s similar to a promise implementation,
but doesn’t worry itself with the result of the underlying functions.</p>
<pre><code><span class="hljs-keyword">var</span> emitter = <span class="hljs-keyword">new</span> pie.emitter();

emitter.on(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{} );
emitter.prepend(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{} );

emitter.once(<span class="hljs-string">'afterBar'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{} );
emitter.prependOnce(<span class="hljs-string">'beforeBar'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{} );
emitter.once(<span class="hljs-string">'aroundBar'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span></span>{} );

emitter.fire(<span class="hljs-string">'foo'</span>);
emitter.fireSequence(<span class="hljs-string">'bar'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.emitter = pie.model.extend(<span class="hljs-string">'emitter'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._super({
      triggeredEvents: {},
      eventCallbacks: {}
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <p><strong> pie.emitter.clear </strong></p>
<p>Remove any events registered under <code>eventName</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'eventCallbacks.'</span> + eventName, <span class="hljs-literal">undefined</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <p><strong> pie.emitter.debug </strong></p>
<p>Begin logging events which are triggered by this emitter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  debug: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bool)</span> </span>{
    <span class="hljs-keyword">this</span>.isDebugging = bool || bool === <span class="hljs-literal">undefined</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              <p><strong> pie.emitter.hasEvent </strong></p>
<p>Has the event <code>eventName</code> been triggered by this emitter yet?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">return</span> !!<span class="hljs-keyword">this</span>.firedCount(eventName);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              <p><strong> pie.emitter.hasCallback </strong></p>
<p>Is there a callback for the event <code>eventName</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasCallback: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">var</span> cbs = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eventCallbacks.'</span> + eventName);
    <span class="hljs-keyword">return</span> !!(cbs &amp;&amp; cbs.length);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              <p><strong> pie.emitter.firedCount </strong></p>
<p>Count the number of times an event has been triggered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  firedCount: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'triggeredEvents'</span>)[eventName] || <span class="hljs-number">0</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              <h4 id="event-observation">Event Observation</h4>

            </div>
            
        </li>
        
        
        <li id="section-281">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-281">&#182;</a>
              </div>
              <p><strong> pie.emitter._on </strong></p>
<p>Append or prepend a function <code>fn</code> via <code>meth</code> to the callbacks registered under <code>event</code>.
Options are as follows:</p>
<ul>
<li><strong>immediate</strong> - trigger the <code>fn</code> immediately if the <code>event</code> has been fired in the past.</li>
<li><strong>onceOnly</strong> - trigger the <code>fn</code> a single time then remove the observer.</li>
</ul>
<p><em>Note that if <code>immediate</code> and <code>onceOnly</code> are provided as options and the event has been previously
triggered, the function will be invoked and nothing will be added to the callbacks.</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _on: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options, meth)</span> </span>{
    options = options || {};

    <span class="hljs-keyword">if</span>(options.immediate &amp;&amp; <span class="hljs-keyword">this</span>.hasEvent(event)) {
      fn();
      <span class="hljs-keyword">if</span>(options.onceOnly) <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">this</span>.getOrSet(<span class="hljs-string">'eventCallbacks.'</span> + event, [])[meth](pie.object.merge({fn: fn}, options));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-282">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-282">&#182;</a>
              </div>
              <p>Same method signature of <code>_on</code>, but handles the inclusion of the <code>onceOnly</code> option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _once: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options, meth)</span> </span>{
    options = pie.object.merge({onceOnly: <span class="hljs-literal">true</span>}, options);
    <span class="hljs-keyword">this</span>._on(event, fn, options, meth);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-283">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-283">&#182;</a>
              </div>
              <p><strong> pie.emitter.on </strong></p>
<p>Public interface for invoking <code>_on</code> &amp; pushing an event to the end of the callback chain.</p>
<pre><code>emitter.on(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
emitter.on(<span class="hljs-string">'afterFoo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  on: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options)</span> </span>{
    <span class="hljs-keyword">this</span>._on(event, fn, options, <span class="hljs-string">'push'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-284">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-284">&#182;</a>
              </div>
              <p><strong> pie.emitter.prepend </strong></p>
<p>Public interface for invoking <code>_on</code> &amp; prepending an event to the beginning of the callback chain.</p>
<pre><code>emitter.prepend(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  prepend: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options)</span> </span>{
    <span class="hljs-keyword">this</span>._on(event, fn, options, <span class="hljs-string">'unshift'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-285">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              <p><strong> pie.emitter.once </strong></p>
<p>Public interface for invoking <code>_once</code> &amp; pushing an event to the end of the callback chain.</p>
<pre><code>emitter.once(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{}, {immediate: <span class="hljs-literal">true</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  once: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options)</span> </span>{
    <span class="hljs-keyword">this</span>._once(event, fn, options, <span class="hljs-string">'push'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-286">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-286">&#182;</a>
              </div>
              <p><strong> pie.emitter.prependOnce </strong></p>
<p>Public interface for invoking <code>_once</code> &amp; prepending an event to the beginning of the callback chain.</p>
<pre><code>emitter.prependOnce(<span class="hljs-string">'foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  prependOnce: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn, options)</span> </span>{
    <span class="hljs-keyword">this</span>._once(event, fn, options, <span class="hljs-string">'unshift'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-287">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-287">&#182;</a>
              </div>
              <h4 id="event-triggering">Event Triggering</h4>

            </div>
            
        </li>
        
        
        <li id="section-288">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-288">&#182;</a>
              </div>
              <p><strong> pie.emitter._reportTrigger </strong></p>
<p>Increment our <code>triggeredEvents</code> counter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _reportTrigger: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> </span>{
    <span class="hljs-keyword">var</span> triggered = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'triggeredEvents'</span>);
    triggered[event] = (triggered[event] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-289">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              <p><strong> pie.emitter.fire </strong></p>
<p>Trigger an <code>event</code> causing any registered callbacks to be fired.
Any callbacks associated with that event will be invoked with the arguments supplied by positions 1-N.</p>
<pre><code>emitter.fire(<span class="hljs-string">'userSignedUp'</span>, <span class="hljs-string">'Doug Wilson'</span>);
<span class="hljs-comment">//=&gt; invokes all registered callbacks of the `userSignedUp` event with a single argument, "Doug Wilson".</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  fire: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* event, arg1, arg2, */</span>)</span> </span>{

    <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
    event = args.shift(),
    callbacks = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eventCallbacks.'</span> + event),
    compactNeeded = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">/* show that this event was triggered if we're debugging */</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isDebugging) <span class="hljs-keyword">this</span>.app.debug(event);

    <span class="hljs-comment">/* increment our trigger counters */</span>
    <span class="hljs-keyword">this</span>._reportTrigger(event);

    <span class="hljs-keyword">if</span>(callbacks) {
      callbacks.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb, i)</span> </span>{
        <span class="hljs-comment">/* invoke the function for the callback */</span>
        cb.fn.apply(<span class="hljs-literal">null</span>, args);
        <span class="hljs-comment">/* if the function is `onceOnly`, clear it out */</span>
        <span class="hljs-keyword">if</span>(cb.onceOnly) {
          compactNeeded = <span class="hljs-literal">true</span>;
          callbacks[i] = <span class="hljs-literal">undefined</span>;
        }
      });
    }

    <span class="hljs-comment">/* if we removed callbacks, clean up */</span>
    <span class="hljs-keyword">if</span>(compactNeeded) <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'eventCallbacks.'</span> + event, pie.array.compact(callbacks));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-290">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-290">&#182;</a>
              </div>
              <p><strong> pie.emitter.fireSequence </strong></p>
<p>Fire a sequence of events based on base event name of <code>event</code>.
Optionally, provide a function <code>fn</code> which will be invoked before the base event is fired.</p>
<pre><code>emitter.fireSequence(<span class="hljs-string">'foo'</span>, barFn);
<span class="hljs-comment">//=&gt; invokes the following sequence:</span>
<span class="hljs-comment">// fires "beforeFoo", fires "aroundFoo", invokes barFn, fires "foo", fires "afterFoo"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  fireSequence: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, fn)</span> </span>{
    <span class="hljs-keyword">var</span> before = pie.string.modularize(<span class="hljs-string">"before_"</span> + event),
        after  = pie.string.modularize(<span class="hljs-string">"after_"</span> + event),
        around = pie.string.modularize(<span class="hljs-string">'around_'</span> + event);

    <span class="hljs-keyword">this</span>.fire(before);
    <span class="hljs-keyword">this</span>.fireAround(around, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span>(fn) fn();
      <span class="hljs-keyword">this</span>.fire(event);
      <span class="hljs-keyword">this</span>.fire(after);
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-291">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-291">&#182;</a>
              </div>
              <p><strong> pie.emitter.fireAround </strong></p>
<p>Invokes <code>event</code> callbacks and expects each callback to invoke a provided callback when complete.
After all callbacks have reported that they’re finished, <code>onComplete</code> will be invoked.</p>
<pre><code>cb1 = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span></span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'cb1!'</span>); cb(); };
cb2 = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span></span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'cb2!'</span>); cb(); };
emitter.on(<span class="hljs-string">'aroundFoo'</span>, cb1);
emitter.on(<span class="hljs-string">'aroundFoo'</span>, cb2);
emitter.fireAround(<span class="hljs-string">'aroundFoo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'done!'</span>); });
<span class="hljs-comment">//=&gt; console would log "cb1!", "cb2!", "done!"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  fireAround: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, onComplete)</span> </span>{
    <span class="hljs-keyword">var</span> callbacks = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eventCallbacks.'</span> + event),
    compactNeeded = <span class="hljs-literal">false</span>,
    fns;

    <span class="hljs-keyword">this</span>._reportTrigger(event);

    <span class="hljs-keyword">if</span>(callbacks) {
      fns = callbacks.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb, i)</span> </span>{
        <span class="hljs-keyword">if</span>(cb.onceOnly) {
          compactNeeded = <span class="hljs-literal">true</span>;
          cb[i] = <span class="hljs-literal">undefined</span>;
        }
        <span class="hljs-keyword">return</span> cb.fn;
      });

      <span class="hljs-keyword">if</span>(compactNeeded) <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'eventCallbacks.'</span> + event, pie.array.compact(callbacks));

      pie.fn.async(fns, onComplete);
    } <span class="hljs-keyword">else</span> {
      onComplete();
    }
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-292">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-292">&#182;</a>
              </div>
              <h1 id="pie-error-handler">Pie Error Handler</h1>
<p>A class which knows how to handle errors in the app.
By default, it focuses mostly on xhr issues.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.errorHandler = pie.model.extend(<span class="hljs-string">'errorHandler'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span> </span>{
    <span class="hljs-keyword">this</span>._super({
      responseCodeHandlers: {}
    }, {
      app: app
    });
  },


  <span class="hljs-comment">/* extract the "data" object out of an xhr */</span>
  xhrData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
    <span class="hljs-keyword">return</span> xhr.data = xhr.data || (xhr.status ? <span class="hljs-built_in">JSON</span>.parse(xhr.response) : {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-293">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-293">&#182;</a>
              </div>
              <p><strong> pie.errorHandler.errorMessagesFromRequest </strong></p>
<p>Extract error messages from a response. Try to extract the messages from
the xhr data diretly, or allow overriding by response code.
It will look for an “error”, “errors”, or “errors.message” response format.</p>
<pre><code>{
  errors: [
    {
      key: <span class="hljs-string">'invalid_email'</span>,
      message: <span class="hljs-string">"Email is invalid"</span>
    }
  ]
}
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  errorMessagesFromRequest: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
    <span class="hljs-keyword">var</span> d = <span class="hljs-keyword">this</span>.xhrData(xhr),
    errors = pie.array.from(d.error || d.message || d.errors || []),
    clean;

    errors = errors.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span></span>{ <span class="hljs-keyword">return</span> pie.object.isString(e) ? e : e.message; });

    errors = pie.array.compact(errors, <span class="hljs-literal">true</span>);
    clean   = <span class="hljs-keyword">this</span>.app.i18n.t(<span class="hljs-string">'app.errors.'</span> + xhr.status, {<span class="hljs-keyword">default</span>: errors});

    <span class="hljs-keyword">this</span>.app.debug(errors);

    <span class="hljs-keyword">return</span> pie.array.from(clean);
  },

  getResponseCodeHandler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'responseCodeHandlers.'</span> + status);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-294">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-294">&#182;</a>
              </div>
              <p><strong> pie.errorHandler.handleXhrError </strong></p>
<p>Find a handler for the xhr via response code or the app default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  handleXhrError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{

    <span class="hljs-keyword">var</span> handler = <span class="hljs-keyword">this</span>.getResponseCodeHandler(xhr.status.toString());

    <span class="hljs-keyword">if</span>(handler) {
      handler.call(xhr, xhr);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.notifyErrors(xhr);
    }

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-295">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-295">&#182;</a>
              </div>
              <p><strong> pie.errorHandler.notifyErrors </strong></p>
<p>Build errors and send them to the notifier.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  notifyErrors: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span></span>{
    <span class="hljs-keyword">var</span> n = <span class="hljs-keyword">this</span>.app.notifier, errors = <span class="hljs-keyword">this</span>.errorMessagesFromRequest(xhr);

    <span class="hljs-keyword">if</span>(errors.length) {
      <span class="hljs-comment">/* clear all previous errors when an error occurs. */</span>
      n.clear(<span class="hljs-string">'error'</span>);

      <span class="hljs-comment">/* delay so UI will visibly change when the same content is shown. */</span>
      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        n.notify(errors, <span class="hljs-string">'error'</span>, <span class="hljs-number">10000</span>);
      }, <span class="hljs-number">100</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-296">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-296">&#182;</a>
              </div>
              <p><strong> pie.errorHandler.registerHandler </strong></p>
<p>Register a response code handler</p>
<pre><code>handler.registerHandler(<span class="hljs-string">'401'</span>, myRedirectCallback);
handler.registerHandler(<span class="hljs-string">'404'</span>, myFourOhFourCallback);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  registerHandler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(responseCode, handler)</span> </span>{
    <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'responseCodeHandlers.'</span> + responseCode.toString(), handler);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-297">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-297">&#182;</a>
              </div>
              <p><strong> pie.errorHandler.reportError </strong></p>
<p>Provide an interface for sending errors to a bug reporting service.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reportError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, options)</span> </span>{
    options = options || {};

    <span class="hljs-keyword">if</span>(options.prefix &amp;&amp; pie.object.has(err, <span class="hljs-string">'message'</span>)) {
      err.message = options.prefix + <span class="hljs-string">' '</span> + err.message;
    }

    <span class="hljs-keyword">if</span>(options.prefix &amp;&amp; pie.object.has(err, <span class="hljs-string">'name'</span>)) {
      err.name = options.prefix + <span class="hljs-string">' '</span> + err.name;
    }

    <span class="hljs-keyword">this</span>._reportError(err, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-298">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-298">&#182;</a>
              </div>
              <p><strong> pie.errorHandler._reportError </strong></p>
<p>Hook in your own error reporting service. bugsnag, airbrake, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _reportError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
    <span class="hljs-keyword">this</span>.app.debug(err);
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-299">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-299">&#182;</a>
              </div>
              <h1 id="pie-formview">Pie FormView</h1>
<p>A view designed to ease form modeling &amp; interactions.
FormViews make use of bindings &amp; validations to simplify the input, validation, and submission of forms.</p>
<pre><code>myForm = <span class="hljs-keyword">new</span> pie.formView({
  fields: [
    {
      name: <span class="hljs-string">'full_name'</span>
      validates: {
        presence: <span class="hljs-literal">true</span>
      }
    },
    ...
    {
      name: <span class="hljs-string">'terms_of_service'</span>,
      binding: {
        type: <span class="hljs-string">'check'</span>,
        dataType: <span class="hljs-string">'boolean'</span>
      },
      validates: {
        chosen: <span class="hljs-literal">true</span>
      }
    }
  ]
})
</code></pre><p>Valid options are as follows:</p>
<ul>
<li><strong>fields</strong> - a list of fields to bind to, validate, and submit. Each field can have the following:<ul>
<li><strong>name</strong> - the name of the field to bind to. Should be the same as the name attribute of the field &amp; the attribute you’d like to submit as.</li>
<li><strong>binding</strong> - options for the binding. All options present in <code>pie.mixins.bindings#normalizeBindingOptions</code> are available.</li>
<li><strong>validation</strong> - options for the validation. All options present in <code>pie.mixins.validatable</code> are available.</li>
</ul>
</li>
<li><strong>ajax</strong> - (optional) an object of ajax options to use as part of the submission. By default it will infer the url &amp; verb from the <code>&lt;form&gt;</code> this view contains.</li>
<li><strong>formSel</strong> - (optional) defaulted to “form”, this is the selector which will be observed for submission.</li>
<li><strong>model</strong> - (optional) a model to be bound to. By default it will create a new model automatically. Keep in mind if you supply a model, the model will have validations applied to it.</li>
<li><strong>validationStrategy</strong> - (optional) a validation strategy to be applied to the model. See <code>pie.mixins.validatable</code> for more info on that.</li>
</ul>
<p>Upon submission a few things happen. If the ajax call is a success, the view’s <code>onSuccess</code> function is invoked. The emitter also fires an <code>onSuccess</code> event.
Similarly, upon failure, <code>onFailure</code> is invoked &amp; emitted. If you override <code>ajax.extraError</code> or <code>ajax.success</code> in the options, the associated function &amp; event will not be triggered.
If you’re overriding formView behavior, here’s the general process which is taken:</p>
<ol>
<li>Upon setup, fields are bound &amp; initialized</li>
<li>Upon submission, fields are read one final time</li>
<li>A <code>submit</code> event is triggered on our emitter.</li>
<li>The model is validated.</li>
<li>If invalid, an <code>onInvalid</code> event is fired and the <code>onInvalid</code> function is invoked.</li>
<li>If invalid, an <code>onValid</code> event is fired and the <code>onValid</code> function is invoked.</li>
<li>By default, the <code>onValid</code> function invokes <code>prepareSubmissionData</code> with a callback.</li>
<li><code>prepareSubmissionData</code> reads the fields out of the model. This is the point when ajax could take place if, say, a token needed to be generated by an external service (I’m talking to you, Stripe).</li>
<li>When the data is prepared, the callback is invoked.</li>
<li>The ajax request is made to the form target.</li>
<li>If unsuccessful, an <code>onFailure</code> event &amp; function are triggered.</li>
<li>If successful, an <code>onSuccess</code> event &amp; function are triggered.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.formView = pie.activeView.extend(<span class="hljs-string">'formView'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">this</span>._ensureModel();
    <span class="hljs-keyword">this</span>._normalizeFormOptions();
  },

  setup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._setupFormBindings();

    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'submit'</span>, <span class="hljs-keyword">this</span>.options.formSel, <span class="hljs-keyword">this</span>.validateAndSubmitForm.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  <span class="hljs-comment">/* we build a model if one isn't present already */</span>
  <span class="hljs-comment">/* if the model doesn't know how to perform validations, we extend it with the functionality */</span>
  _ensureModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.model = <span class="hljs-keyword">this</span>.model || <span class="hljs-keyword">this</span>.options.model || <span class="hljs-keyword">new</span> pie.model({});

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.model.validates) <span class="hljs-keyword">this</span>.model.reopen(pie.mixins.validatable);
  },


  _normalizeFormOptions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.options.formSel  = <span class="hljs-keyword">this</span>.options.formSel || <span class="hljs-string">'form'</span>;
    <span class="hljs-keyword">this</span>.options.fields   = <span class="hljs-keyword">this</span>.options.fields || [];
    <span class="hljs-keyword">this</span>.options.fields   = <span class="hljs-keyword">this</span>.options.fields.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(field)</span> </span>{

      <span class="hljs-keyword">if</span>(!field || !field.name) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"A `name` property must be provided for all fields."</span>);

      field.binding = field.binding || {};
      field.binding.attr = field.binding.attr || field.name;

      <span class="hljs-keyword">return</span> field;
    });
  },

  <span class="hljs-comment">/* These `_on*` methods are provided to enable event observation. */</span>
  <span class="hljs-comment">/* Implementers of formView should override `on*` methods. */</span>
  _onInvalid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'onInvalid'</span>);
    <span class="hljs-keyword">this</span>.onInvalid.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  _onFailure: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'onFailure'</span>);
    <span class="hljs-keyword">this</span>.onFailure.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  _onSuccess: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'onSuccess'</span>);
    <span class="hljs-keyword">this</span>.onSuccess.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  _onValid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'onValid'</span>);
    <span class="hljs-keyword">this</span>.onValid.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  _setupFormBindings: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> validation;

    <span class="hljs-keyword">this</span>.options.fields.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(field)</span> </span>{

      <span class="hljs-keyword">this</span>.bind(field.binding);

      validation = field.validation;

      <span class="hljs-keyword">if</span>(validation) {
        validation = {};
        validation[field.name] = field.validation;
        <span class="hljs-keyword">this</span>.model.validates(validation, <span class="hljs-keyword">this</span>.options.validationStrategy);
      }
    }.bind(<span class="hljs-keyword">this</span>));
  },

  <span class="hljs-comment">/* The ajax options to be applied before submission */</span>
  ajaxOptions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.options.ajax;
  },

  <span class="hljs-comment">/* the process of applying form data to the model. */</span>
  applyFieldsToModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* form */</span>)</span> </span>{
    <span class="hljs-keyword">this</span>.readBoundFields();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-300">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-300">&#182;</a>
              </div>
              <p><strong> pie.formView.onInvalid </strong></p>
<p>For the inheriting class to override.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onInvalid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* form */</span>)</span> </span>{},</pre></div></div>
            
        </li>
        
        
        <li id="section-301">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-301">&#182;</a>
              </div>
              <p><strong> pie.formView.onValid </strong></p>
<p>What happens when the model validations pass.
By default, the data is prepared for submission via <code>prepareSubmissionData</code>
and sent to <code>performSubmit</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onValid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(form)</span> </span>{
    <span class="hljs-keyword">this</span>.prepareSubmissionData(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{

      <span class="hljs-keyword">this</span>.performSubmit(form, data, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bool, data)</span> </span>{

        <span class="hljs-keyword">if</span>(bool) {
          <span class="hljs-keyword">this</span>._onSuccess(data);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">this</span>._onFailure(data);
        }
      }.bind(<span class="hljs-keyword">this</span>));

    }.bind(<span class="hljs-keyword">this</span>));

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-302">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-302">&#182;</a>
              </div>
              <p><strong> pie.formView.performSubmit </strong></p>
<p>By default it builds an ajax request based on <code>this.options.ajax</code>
and / or the <form> tag identified by <code>form</code>.
Upon success or failure of the request, the <code>cb</code> is invoked with
a signature of <code>cb(success?, responseData)</code></p>
<pre><code>formView.performSubmit(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">form</span>&gt;</span>, {foo: 'bar'}, function(isSuccess, data){ console.log(isSuccess, data); });</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  performSubmit: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(form, data, cb)</span> </span>{
    <span class="hljs-keyword">var</span> request = app.ajax.ajax(pie.object.merge({
      url: form.getAttribute(<span class="hljs-string">'action'</span>),
      verb: form.getAttribute(<span class="hljs-string">'method'</span>) || <span class="hljs-string">'post'</span>,
      data: data
    }, <span class="hljs-keyword">this</span>.ajaxOptions()));

    request.dataSuccess(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span></span>{
      cb(<span class="hljs-literal">true</span>, d);
    });

    request.extraError(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xhr)</span> </span>{
      cb(<span class="hljs-literal">false</span>, xhr.data);
    });
  },

  <span class="hljs-comment">/* for the inheriting class to override. */</span>
  onFailure: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* response, xhr */</span>)</span> </span>{},

  <span class="hljs-comment">/* for the inheriting class to override. */</span>
  onSuccess: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* response, xhr */</span>)</span> </span>{},</pre></div></div>
            
        </li>
        
        
        <li id="section-303">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-303">&#182;</a>
              </div>
              <p><strong> pie.formView.prepareSubmissionData </strong></p>
<p>The data to be sent to the server.
By default these are the defined fields extracted out of the model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  prepareSubmissionData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
    <span class="hljs-keyword">var</span> fieldNames = pie.array.map(<span class="hljs-keyword">this</span>.options.fields, <span class="hljs-string">'name'</span>),
    data = <span class="hljs-keyword">this</span>.model.gets(fieldNames);

    <span class="hljs-keyword">if</span>(cb) cb(data);
    <span class="hljs-keyword">return</span> data;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-304">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-304">&#182;</a>
              </div>
              <p><strong> pie.formView.validateModel </strong></p>
<p>Perform validations on the model &amp; invoke <code>cb</code> when complete.
By default, <code>model.validateAll</code> will be invoked but this can be overridden
to talk to external services, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validateModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
    <span class="hljs-keyword">this</span>.model.validateAll(cb);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-305">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-305">&#182;</a>
              </div>
              <p><strong> pie.formView.validateAndSubmitForm </strong></p>
<p>Start the submission process. We apply our form fields to the model
via <code>applyFieldsToModel</code>, fire a submit event via our emitter, then
begin the validation process via <code>validateModel</code>. If the model validates,
we invoke our <code>onValid</code> function, otherwise the <code>onInvalid</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  validateAndSubmitForm: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
    <span class="hljs-keyword">this</span>.consumeEvent(e);

    <span class="hljs-keyword">var</span> form = e.delegateTarget;

    <span class="hljs-keyword">this</span>.applyFieldsToModel(form);

    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'submit'</span>);

    <span class="hljs-keyword">this</span>.validateModel(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bool)</span> </span>{
      <span class="hljs-keyword">if</span>(bool) {
        <span class="hljs-keyword">this</span>._onValid(form);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>._onInvalid(form);
      }
    }.bind(<span class="hljs-keyword">this</span>));
  }

}, pie.mixins.bindings);</pre></div></div>
            
        </li>
        
        
        <li id="section-306">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-306">&#182;</a>
              </div>
              <h1 id="pie-helpers">Pie Helpers</h1>
<p>A registry for template helpers.
Any helper function register here will be available in the
templates rendered by the associated app’s <code>templates</code> object.</p>
<pre><code>helpers.register(<span class="hljs-string">'upcase'</span>, pie.string.upcase);
helpers.register(<span class="hljs-string">'reverse'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span></span>{
  <span class="hljs-keyword">return</span> str.split(<span class="hljs-string">''</span>).reverse().join(<span class="hljs-string">''</span>);
});
</code></pre><p>Now, in your templates you’ll be able to use these helpers:</p>
<pre><code>&lt;h1&gt;[%= h.upcase(data.fullName) %]&lt;/h1&gt;
&lt;p&gt;[%= h.reverse(data.jibberish) %]&lt;/p&gt;
</code></pre><p>Note: these do not become global functions but rather are local to each template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.helpers = pie.model.extend(<span class="hljs-string">'helpers'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>._super({
      fns: {}
    }, {
      app: app,
      variableName: <span class="hljs-string">'h'</span>
    });

    <span class="hljs-keyword">var</span> i18n = <span class="hljs-keyword">this</span>.app.i18n;

    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'t'</span>, i18n.t.bind(i18n));
    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'l'</span>, i18n.l.bind(i18n));
    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'timeago'</span>, i18n.timeago.bind(i18n));
    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'path'</span>, <span class="hljs-keyword">this</span>.app.router.path.bind(<span class="hljs-keyword">this</span>.app.router));
    <span class="hljs-keyword">this</span>.register(<span class="hljs-string">'get'</span>, pie.object.getPath);
  },

  <span class="hljs-comment">/* Register a function to be available in templates. */</span>
  register: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, fn)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'fns.'</span> + name, fn);
  },

  <span class="hljs-comment">/* Fetch a helper function */</span>
  fetch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'fns.'</span> + name);
  },

  <span class="hljs-comment">/* Call a helper function */</span>
  call: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* name, ..args */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> args = pie.array.from(<span class="hljs-built_in">arguments</span>),
    name = args.shift();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fetch(name).apply(<span class="hljs-literal">null</span>, args);
  },

  <span class="hljs-comment">/* Provide the functions which should be available in templates. */</span>
  functions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'fns'</span>);
  },

  provideVariables: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">"var "</span> + <span class="hljs-keyword">this</span>.options.variableName + <span class="hljs-string">" = pie.apps["</span> + <span class="hljs-keyword">this</span>.app.pieId + <span class="hljs-string">"].helpers.functions();"</span>;

  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-307">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-307">&#182;</a>
              </div>
              <h1 id="pie-i18n">Pie i18n</h1>
<p>The i18n class is in charge of the defining and lookup of translations, the
defining and lookup of date formats, and the standardization of “word” things.
The standard i18n lookup usage is as follows:</p>
<pre><code>i18n.load({
  hi: "Hi %{firstName}",
  followers: {
    zero: "${hi}, you don't have any followers :(",
    one: "${hi}, you have a follower!",
    other: ${hi}, you have %{count} followers!"
});

i18n.t("hi");
//=&gt; "Hi undefined"
i18n.t("hi", {firstName: 'Doug'});
//=&gt; "Hi Doug"
i18n.t("hi", {firstName: 'Doug'}, 'upcase');
//=&gt; "HI DOUG"
i18n.t("followers", {firstName: 'Doug', count: 5});
//=&gt; "Hi Doug, you have 5 followers!"
i18n.t("followers", {firstName: 'Doug', count: 0});
//=&gt; "Hi Doug, you don't have any followers :("
</code></pre><p>Note that recursive interpolation is allowed via the <code>${}</code> identifier. Direct interpolation is
handled by <code>%{}</code>. There is no loop detection so use this wisely.</p>
<p>And date/time usage is as follows:</p>
<pre><code>i18n.l(date, <span class="hljs-string">'%Y-%m'</span>);
<span class="hljs-comment">//=&gt; "2015-01"</span>
i18n.l(date, <span class="hljs-string">'isoTime'</span>);
<span class="hljs-comment">//=&gt; "2015-01-14T09:42:26.069-05:00"</span>
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-308">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-308">&#182;</a>
              </div>
              <p><em><strong>Todo:</strong> allow a default scope (eg, en, en-GB, etc). Currently the assumption is that only the relevant translations are loaded.</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.i18n = pie.model.extend(<span class="hljs-string">'i18n'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">var</span> data = pie.object.merge({}, pie.i18n.defaultTranslations);
    options = pie.object.merge(options || {}, {app: app});

    <span class="hljs-keyword">this</span>._super(data, options);
  },

  _ampm: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(num)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.meridiems.'</span> + (num &gt;= <span class="hljs-number">12</span> ? <span class="hljs-string">'pm'</span> : <span class="hljs-string">'am'</span>));
  },


  _countAlias: {
    <span class="hljs-string">'0'</span> : <span class="hljs-string">'zero'</span>,
    <span class="hljs-string">'1'</span> : <span class="hljs-string">'one'</span>,
    <span class="hljs-string">'-1'</span> : <span class="hljs-string">'negone'</span>
  },


  _dayName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.day_names.'</span> + d);
  },


  _hour: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(h)</span> </span>{
    <span class="hljs-keyword">if</span>(h &gt; <span class="hljs-number">12</span>) h -= <span class="hljs-number">12</span>;
    <span class="hljs-keyword">if</span>(!h) h += <span class="hljs-number">12</span>;
    <span class="hljs-keyword">return</span> h;
  },


  _monthName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.month_names.'</span> + m);
  },


  _nestedTranslate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t, data)</span> </span>{
    <span class="hljs-keyword">return</span> t.replace(<span class="hljs-regexp">/\$\{([^\}]+)\}/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, path)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.translate(path, data);
    }.bind(<span class="hljs-keyword">this</span>));
  },


  <span class="hljs-comment">/* assumes that dates either come in as dates, iso strings, or epoch timestamps */</span>
  _normalizedDate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">String</span>(d).match(<span class="hljs-regexp">/^\d+$/</span>)) {
      d = <span class="hljs-built_in">parseInt</span>(d, <span class="hljs-number">10</span>);
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">String</span>(d).length &lt; <span class="hljs-number">13</span>) d *= <span class="hljs-number">1000</span>;
      d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(d);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.isString(d)) {
      d = pie.date.timeFromISO(d);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">/* let the system parse */</span>
      d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(d);
    }
    <span class="hljs-keyword">return</span> d;
  },


  _shortDayName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.short_day_names.'</span> + d) || <span class="hljs-keyword">this</span>._dayName(d).slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);
  },


  _shortMonthName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.short_month_names.'</span> + m) || <span class="hljs-keyword">this</span>._monthName(m).slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);
  },


  _pad: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(num, cnt, pad, prefix)</span> </span>{
    <span class="hljs-keyword">var</span> s = <span class="hljs-string">''</span>,
        p = cnt - num.toString().length;
    <span class="hljs-keyword">if</span>(pad === <span class="hljs-literal">undefined</span>) pad = <span class="hljs-string">' '</span>;
    <span class="hljs-keyword">while</span>(p&gt;<span class="hljs-number">0</span>){
      s += prefix ? pad + s : s + pad;
      p -= <span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">return</span> s + num.toString();
  },

  _ordinal: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(number)</span> </span>{
    <span class="hljs-keyword">var</span> unit = number % <span class="hljs-number">100</span>;

    <span class="hljs-keyword">if</span>(unit &gt;= <span class="hljs-number">11</span> &amp;&amp; unit &lt;= <span class="hljs-number">13</span>) unit = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">else</span> unit = number % <span class="hljs-number">10</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.ordinals.o'</span> + unit);
  },

  _timezoneAbbr: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(date)</span> </span>{
    <span class="hljs-keyword">var</span> str = date &amp;&amp; date.toString();
    <span class="hljs-keyword">return</span> str &amp;&amp; str.split(<span class="hljs-regexp">/\((.*)\)/</span>)[<span class="hljs-number">1</span>];
  },


  _utc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span> </span>{
    <span class="hljs-keyword">var</span> t2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(t.getTime());
    t2.setMinutes(t2.getMinutes() + t2.getTimezoneOffset());
    <span class="hljs-keyword">return</span> t2;
  },

  keyCheck: <span class="hljs-regexp">/^\.(.+)$/</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-309">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-309">&#182;</a>
              </div>
              <p><strong> pie.i18n.attempt </strong></p>
<p>If the provided <code>key</code> looks like a translation key, prepended with a “.”,
try to look it up. If it does not or the provided key does not exist, return
the provided key.</p>
<pre><code>i18n.attempt(<span class="hljs-string">'.foo.bar.baz'</span>)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  attempt: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">var</span> m = key &amp;&amp; key.match(<span class="hljs-keyword">this</span>.keyCheck);
    <span class="hljs-keyword">if</span>(!m) <span class="hljs-keyword">return</span> key;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(m[<span class="hljs-number">1</span>], {<span class="hljs-keyword">default</span>: key});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-310">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-310">&#182;</a>
              </div>
              <p><strong> pie.i18n.load </strong></p>
<p>Load translations into this instance.
By default, a deep merge will occur, provide <code>false</code> for <code>shallow</code>
if you would like a shallow merge to occur.</p>
<pre><code>i18n.load({foo: <span class="hljs-string">'Bar %{baz}'</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  load: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, shallow)</span> </span>{
    <span class="hljs-keyword">var</span> f = shallow ? pie.object.merge : pie.object.deepMerge;
    f.call(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>.data, data);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-311">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-311">&#182;</a>
              </div>
              <p><strong> pie.i18n.translate (pie.i18n.t) </strong></p>
<p>Given a <code>path</code>, look up a translation.
If the second argument <code>data</code> is provided, the <code>data</code> will be
interpolated into the translation before returning.
Arguments 3+ are string modification methods as defined by <code>pie.string</code>.
<code>translate</code> is aliased as <code>t</code>.</p>
<pre><code><span class="hljs-comment">//=&gt; Assuming 'foo.path' is defined as "This is %{name}"</span>
i18n.t(<span class="hljs-string">'foo.path'</span>, {name: <span class="hljs-string">'Bar'</span>}, <span class="hljs-string">'pluralize'</span>, <span class="hljs-string">'upcase'</span>)
<span class="hljs-comment">//=&gt; "THIS IS BAR'S"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  translate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* path, data, stringChange1, stringChange2 */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> changes = pie.array.from(<span class="hljs-built_in">arguments</span>),
    path = changes.shift(),
    data = pie.object.isObject(changes[<span class="hljs-number">0</span>]) ? changes.shift() : <span class="hljs-literal">undefined</span>,
    translation = <span class="hljs-keyword">this</span>.get(path),
    count;

    <span class="hljs-keyword">if</span> (pie.object.has(data, <span class="hljs-string">'count'</span>) &amp;&amp; pie.object.isObject(translation)) {
      count = (data.count || <span class="hljs-number">0</span>).toString();
      count = <span class="hljs-keyword">this</span>._countAlias[count] || (count &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'other'</span> : <span class="hljs-string">'negother'</span>);
      translation = translation[count] === <span class="hljs-literal">undefined</span> ? translation.other : translation[count];
    }

    <span class="hljs-keyword">if</span>(!translation) {

      <span class="hljs-keyword">if</span>(data &amp;&amp; data.hasOwnProperty(<span class="hljs-string">'default'</span>)) {
        translation = pie.fn.valueFrom(data.default);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.app.debug(<span class="hljs-string">"Translation not found: "</span> + path);
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
      }
    }


    <span class="hljs-keyword">if</span>(pie.object.isString(translation)) {
      translation = translation.indexOf(<span class="hljs-string">'${'</span>) === -<span class="hljs-number">1</span> ? translation : <span class="hljs-keyword">this</span>._nestedTranslate(translation, data);
      translation = translation.indexOf(<span class="hljs-string">'%{'</span>) === -<span class="hljs-number">1</span> ? translation : pie.string.expand(translation, data);
    }

    <span class="hljs-keyword">if</span>(changes.length) {
      changes.unshift(translation);
      translation = pie.string.change.apply(<span class="hljs-literal">null</span>, changes);
    }

    <span class="hljs-keyword">return</span> translation;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-312">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-312">&#182;</a>
              </div>
              <p><strong> pie.i18n.timeago </strong></p>
<p>Return a human representation of the time since the provided time <code>t</code>.
You can also pass an alternate “relative to” time as the second argument.</p>
<pre><code>d.setDate(d.getDate() - <span class="hljs-number">4</span>);
i18n.timeago(d)
<span class="hljs-comment">//=&gt; "4 days ago"</span>

d.setDate(d.getDate() - <span class="hljs-number">7</span>);
i18n.timeago(d)
<span class="hljs-comment">//=&gt; "1 week ago"</span>

d.setDate(d.getDate() - <span class="hljs-number">90</span>);
d2.setDate(d.getDate() + <span class="hljs-number">2</span>);
i18n.timeago(d, d2)
<span class="hljs-comment">//=&gt; "2 days ago"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  timeago: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t, now, scope)</span> </span>{
    t = <span class="hljs-keyword">this</span>._normalizedDate(t).getTime()  / <span class="hljs-number">1000</span>;
    now = <span class="hljs-keyword">this</span>._normalizedDate(now || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime() / <span class="hljs-number">1000</span>;

    <span class="hljs-keyword">var</span> diff = now - t, c;

    scope = scope || <span class="hljs-string">'app'</span>;

    <span class="hljs-keyword">if</span>(diff &lt; <span class="hljs-number">60</span>) { <span class="hljs-comment">// less than a minute</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.now'</span>, {count: diff});
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">3600</span>) { <span class="hljs-comment">// less than an hour</span>
      c = <span class="hljs-built_in">Math</span>.floor(diff / <span class="hljs-number">60</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.minutes'</span>, {count: c});
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86400</span>) { <span class="hljs-comment">// less than a day</span>
      c = <span class="hljs-built_in">Math</span>.floor(diff / <span class="hljs-number">3600</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.hours'</span>, {count: c});
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86400</span> * <span class="hljs-number">7</span>) { <span class="hljs-comment">// less than a week (</span>
      c = <span class="hljs-built_in">Math</span>.floor(diff / <span class="hljs-number">86400</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.days'</span>, {count: c});
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86400</span> * <span class="hljs-number">30</span>) { <span class="hljs-comment">// less than a month</span>
      c = <span class="hljs-built_in">Math</span>.floor(diff / (<span class="hljs-number">86400</span> * <span class="hljs-number">7</span>));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.weeks'</span>, {count: c});
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">86500</span> * <span class="hljs-number">365.25</span>) { <span class="hljs-comment">// less than a year</span>
      c = <span class="hljs-built_in">Math</span>.floor(diff / (<span class="hljs-number">86400</span> * <span class="hljs-number">365.25</span> / <span class="hljs-number">12</span>));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.months'</span>, {count: c});
    } <span class="hljs-keyword">else</span> {
      c = <span class="hljs-built_in">Math</span>.floor(diff / (<span class="hljs-number">86400</span> * <span class="hljs-number">365.25</span>));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(scope + <span class="hljs-string">'.timeago.years'</span>, {count: c});
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-313">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-313">&#182;</a>
              </div>
              <p><strong> pie.i18n.strftime (pie.i18n.l) </strong></p>
<p>Given a <code>date</code>, format it based on the format <code>f</code>.
The format can be:</p>
<ul>
<li>A named format, existing at app.time.formats.X</li>
<li>A custom format following the guidelines of ruby’s strftime</li>
</ul>
<p><em>Ruby’s strftime: <a href="http://ruby-doc.org/core-2.2.0/Time.html#method-i-strftime">http://ruby-doc.org/core-2.2.0/Time.html#method-i-strftime</a></em></p>
<pre><code>i18n.l(date, <span class="hljs-string">'shortDate'</span>);
i18n.l(date, <span class="hljs-string">'%Y-%m'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  strftime: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(date, f)</span> </span>{
    date = <span class="hljs-keyword">this</span>._normalizedDate(date);

    <span class="hljs-comment">/* named format from translations.time. */</span>
    <span class="hljs-keyword">if</span>(!~f.indexOf(<span class="hljs-string">'%'</span>)) f = <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'app.time.formats.'</span> + f, {<span class="hljs-string">"default"</span> : f});

    <span class="hljs-keyword">var</span> weekDay           = date.getDay(),
        day               = date.getDate(),
        year              = date.getFullYear(),
        month             = date.getMonth() + <span class="hljs-number">1</span>,
        hour              = date.getHours(),
        hour12            = <span class="hljs-keyword">this</span>._hour(hour),
        meridiem          = <span class="hljs-keyword">this</span>._ampm(hour),
        secs              = date.getSeconds(),
        mins              = date.getMinutes(),
        mills             = date.getMilliseconds(),
        offset            = date.getTimezoneOffset(),
        absOffsetHours    = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.abs(offset / <span class="hljs-number">60</span>)),
        absOffsetMinutes  = <span class="hljs-built_in">Math</span>.abs(offset) - (absOffsetHours * <span class="hljs-number">60</span>),
        timezoneoffset    = (offset &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"-"</span> : <span class="hljs-string">"+"</span>) + <span class="hljs-keyword">this</span>._pad(absOffsetHours, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>) + <span class="hljs-keyword">this</span>._pad(absOffsetMinutes, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);

    f = f.replace(<span class="hljs-string">"%a"</span>, <span class="hljs-keyword">this</span>._shortDayName(weekDay))
        .replace(<span class="hljs-string">"%A"</span>,  <span class="hljs-keyword">this</span>._dayName(weekDay))
        .replace(<span class="hljs-string">"%B"</span>,  <span class="hljs-keyword">this</span>._monthName(month - <span class="hljs-number">1</span>))
        .replace(<span class="hljs-string">"%b"</span>,  <span class="hljs-keyword">this</span>._shortMonthName(month - <span class="hljs-number">1</span>))
        .replace(<span class="hljs-string">"%d"</span>,  <span class="hljs-keyword">this</span>._pad(day, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
        .replace(<span class="hljs-string">"%e"</span>,  <span class="hljs-keyword">this</span>._pad(day, <span class="hljs-number">2</span>, <span class="hljs-string">' '</span>))
        .replace(<span class="hljs-string">"%-do"</span>, day + <span class="hljs-keyword">this</span>._ordinal(day))
        .replace(<span class="hljs-string">"%-d"</span>, day)
        .replace(<span class="hljs-string">"%H"</span>,  <span class="hljs-keyword">this</span>._pad(hour, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
        .replace(<span class="hljs-string">"%k"</span>,  <span class="hljs-keyword">this</span>._pad(hour, <span class="hljs-number">2</span>, <span class="hljs-string">' '</span>))
        .replace(<span class="hljs-string">'%-H'</span>, hour)
        .replace(<span class="hljs-string">'%-k'</span>, hour)
        .replace(<span class="hljs-string">"%I"</span>,  <span class="hljs-keyword">this</span>._pad(hour12, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
        .replace(<span class="hljs-string">"%l"</span>,  hour12)
        .replace(<span class="hljs-string">"%m"</span>,  <span class="hljs-keyword">this</span>._pad(month, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
        .replace(<span class="hljs-string">"%-m"</span>, month)
        .replace(<span class="hljs-string">"%M"</span>,  <span class="hljs-keyword">this</span>._pad(mins, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
        .replace(<span class="hljs-string">"%p"</span>,  meridiem.toUpperCase())
        .replace(<span class="hljs-string">"%P"</span>,  meridiem)
        .replace(<span class="hljs-string">"%S"</span>,  <span class="hljs-keyword">this</span>._pad(secs, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
        .replace(<span class="hljs-string">"%-S"</span>, secs)
        .replace(<span class="hljs-string">'%L'</span>,  <span class="hljs-keyword">this</span>._pad(mills, <span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>))
        .replace(<span class="hljs-string">'%-L'</span>, mills)
        .replace(<span class="hljs-string">"%w"</span>,  weekDay)
        .replace(<span class="hljs-string">"%y"</span>,  <span class="hljs-keyword">this</span>._pad(year % <span class="hljs-number">100</span>))
        .replace(<span class="hljs-string">"%Y"</span>,  year)
        .replace(<span class="hljs-string">"%z"</span>,  timezoneoffset)
        .replace(<span class="hljs-string">"%:z"</span>, timezoneoffset.slice(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>) + <span class="hljs-string">':'</span> + timezoneoffset.slice(<span class="hljs-number">3</span>))
        .replace(<span class="hljs-string">"%Z"</span>,  <span class="hljs-keyword">this</span>._timezoneAbbr(date));

    <span class="hljs-keyword">return</span> f;
  },
});

<span class="hljs-comment">/* Aliases */</span>
pie.i18n.prototype.t = pie.i18n.prototype.translate;
pie.i18n.prototype.l = pie.i18n.prototype.strftime;

pie.i18n.defaultTranslations = {
  app: {
    sentence: {
      conjunction: <span class="hljs-string">' and '</span>,
      delimeter: <span class="hljs-string">', '</span>
    },

    timeago: {
      now: <span class="hljs-string">"just now"</span>,
      minutes: {
        one:    <span class="hljs-string">"%{count} minute ago"</span>,
        other:  <span class="hljs-string">"%{count} minutes ago"</span>
      },
      hours: {
        one:    <span class="hljs-string">"%{count} hour ago"</span>,
        other:  <span class="hljs-string">"%{count} hours ago"</span>
      },
      days: {
        one:    <span class="hljs-string">"%{count} day ago"</span>,
        other:  <span class="hljs-string">"%{count} days ago"</span>
      },
      weeks: {
        one:    <span class="hljs-string">"%{count} week ago"</span>,
        other:  <span class="hljs-string">"%{count} weeks ago"</span>
      },
      months: {
        one:    <span class="hljs-string">"%{count} month ago"</span>,
        other:  <span class="hljs-string">"%{count} months ago"</span>
      },
      years: {
        one:    <span class="hljs-string">"%{count} year ago"</span>,
        other:  <span class="hljs-string">"%{count} years ago"</span>
      }
    },
    time: {
      formats: {
        isoDate:    <span class="hljs-string">'%Y-%m-%d'</span>,
        isoTime:    <span class="hljs-string">'%Y-%m-%dT%H:%M:%S.%L%:z'</span>,
        shortDate:  <span class="hljs-string">'%m/%d/%Y'</span>,
        longDate:   <span class="hljs-string">'%B %-do, %Y'</span>
      },
      meridiems: {
        am: <span class="hljs-string">'am'</span>,
        pm: <span class="hljs-string">'pm'</span>
      },
      ordinals: {
        o0: <span class="hljs-string">"th"</span>,
        o1: <span class="hljs-string">"st"</span>,
        o2: <span class="hljs-string">"nd"</span>,
        o3: <span class="hljs-string">"rd"</span>,
        o4: <span class="hljs-string">"th"</span>,
        o5: <span class="hljs-string">"th"</span>,
        o6: <span class="hljs-string">"th"</span>,
        o7: <span class="hljs-string">"th"</span>,
        o8: <span class="hljs-string">"th"</span>,
        o9: <span class="hljs-string">"th"</span>
      },
      day_names: [
        <span class="hljs-string">'Sunday'</span>,
        <span class="hljs-string">'Monday'</span>,
        <span class="hljs-string">'Tuesday'</span>,
        <span class="hljs-string">'Wednesday'</span>,
        <span class="hljs-string">'Thursday'</span>,
        <span class="hljs-string">'Friday'</span>,
        <span class="hljs-string">'Saturday'</span>
      ],
      short_day_names: [
        <span class="hljs-string">'Sun'</span>,
        <span class="hljs-string">'Mon'</span>,
        <span class="hljs-string">'Tue'</span>,
        <span class="hljs-string">'Wed'</span>,
        <span class="hljs-string">'Thu'</span>,
        <span class="hljs-string">'Fri'</span>,
        <span class="hljs-string">'Sat'</span>
      ],
      month_names: [
        <span class="hljs-string">'January'</span>,
        <span class="hljs-string">'February'</span>,
        <span class="hljs-string">'March'</span>,
        <span class="hljs-string">'April'</span>,
        <span class="hljs-string">'May'</span>,
        <span class="hljs-string">'June'</span>,
        <span class="hljs-string">'July'</span>,
        <span class="hljs-string">'August'</span>,
        <span class="hljs-string">'September'</span>,
        <span class="hljs-string">'October'</span>,
        <span class="hljs-string">'November'</span>,
        <span class="hljs-string">'December'</span>
      ],
      short_month_names: [
        <span class="hljs-string">'Jan'</span>,
        <span class="hljs-string">'Feb'</span>,
        <span class="hljs-string">'Mar'</span>,
        <span class="hljs-string">'Apr'</span>,
        <span class="hljs-string">'May'</span>,
        <span class="hljs-string">'June'</span>,
        <span class="hljs-string">'July'</span>,
        <span class="hljs-string">'Aug'</span>,
        <span class="hljs-string">'Sept'</span>,
        <span class="hljs-string">'Oct'</span>,
        <span class="hljs-string">'Nov'</span>,
        <span class="hljs-string">'Dec'</span>
      ]
    },

    validations: {

      ccNumber:           <span class="hljs-string">"does not look like a credit card number"</span>,
      ccSecurity:         <span class="hljs-string">"is not a valid security code"</span>,
      ccExpirationMonth:  <span class="hljs-string">"is not a valid expiration month"</span>,
      ccExpirationYear:   <span class="hljs-string">"is not a valid expiration year"</span>,
      chosen:             <span class="hljs-string">"must be chosen"</span>,
      date:               <span class="hljs-string">"is not a valid date"</span>,
      email:              <span class="hljs-string">"must be a valid email"</span>,
      format:             <span class="hljs-string">"is invalid"</span>,
      inclusion:          <span class="hljs-string">"is not a valid value"</span>,
      integer:            <span class="hljs-string">"must be an integer"</span>,
      length:             <span class="hljs-string">"length must be"</span>,
      number:             <span class="hljs-string">"must be a number"</span>,
      phone:              <span class="hljs-string">"is not a valid phone number"</span>,
      presence:           <span class="hljs-string">"can't be blank"</span>,
      url:                <span class="hljs-string">"must be a valid url"</span>,

      range_messages: {
        eq:  <span class="hljs-string">"equal to %{count}"</span>,
        lt:  <span class="hljs-string">"less than %{count}"</span>,
        gt:  <span class="hljs-string">"greater than %{count}"</span>,
        lte: <span class="hljs-string">"less than or equal to %{count}"</span>,
        gte: <span class="hljs-string">"greater than or equal to %{count}"</span>
      }
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-314">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-314">&#182;</a>
              </div>
              <h1 id="pie-list">Pie List</h1>
<p>A model representing a list. Essentially an array wrapper.
List models provide observation for:</p>
<ul>
<li>The entire list</li>
<li>Specific indexes</li>
<li>Length of the list</li>
<li>Any other key not related to the list.
Optionally, a list can provide a <code>cast</code> option which it will use
to cast plain object index values into. <code>castOptions</code> can also be supplied
which will be provided as the second argument to the cast’ constructor.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.list = pie.model.extend(<span class="hljs-string">'list'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(array, options)</span> </span>{
    array = array || [];
    <span class="hljs-keyword">this</span>._super({}, options);
    <span class="hljs-keyword">this</span>.data.items = array.map(<span class="hljs-keyword">this</span>._cast.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-315">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-315">&#182;</a>
              </div>
              <p><strong> pie.list._cast </strong></p>
<p>Casts a <code>value</code> to the option-provided <code>cast</code>.
The first argument provided to the cast is the object itself, the
second is the options-provided castOptions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _cast: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">var</span> klass = <span class="hljs-keyword">this</span>.options.cast;
    <span class="hljs-keyword">if</span>(klass === <span class="hljs-literal">true</span>) klass = pie.model;

    <span class="hljs-keyword">if</span>(klass &amp;&amp; pie.object.isPlainObject(value)) {
      value = <span class="hljs-keyword">new</span> klass(value, <span class="hljs-keyword">this</span>.options.castOptions);
    }

    <span class="hljs-keyword">return</span> value;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-316">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-316">&#182;</a>
              </div>
              <p><strong> pie.list._normalizeIndex </strong></p>
<p>Converts a potential index into the numeric form.
If the index is negative, it should represent the index from the end of the current list.</p>
<pre><code><span class="hljs-comment">// assuming a list length of 3</span>
list._normalizeIndex(<span class="hljs-string">'foo'</span>) <span class="hljs-comment">//=&gt; 'foo'</span>
list._normalizeIndex(<span class="hljs-string">'4'</span>) <span class="hljs-comment">//=&gt; 4</span>
list._normalizeIndex(-<span class="hljs-number">1</span>) <span class="hljs-comment">//=&gt; 2</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  _normalizedIndex: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(wanted)</span> </span>{
    wanted = <span class="hljs-built_in">parseInt</span>(wanted, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isNaN</span>(wanted) &amp;&amp; wanted &lt; <span class="hljs-number">0</span>) wanted += <span class="hljs-keyword">this</span>.data.items.length;
    <span class="hljs-keyword">return</span> wanted;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-317">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-317">&#182;</a>
              </div>
              <p><strong> pie.list._trackMutations </strong></p>
<p>Track changes to the array which occur during <code>fn</code>‘s execution.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _trackMutations: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, fn)</span> </span>{
    <span class="hljs-keyword">var</span> oldLength = <span class="hljs-keyword">this</span>.data.items.length,
    changes = [fn.call()],
    newLength = <span class="hljs-keyword">this</span>.data.items.length;

    <span class="hljs-keyword">if</span>(oldLength !== newLength) {
      changes.push({
        name: <span class="hljs-string">'length'</span>,
        type: <span class="hljs-string">'update'</span>,
        object: <span class="hljs-keyword">this</span>.data.items,
        oldValue: oldLength,
        value: newLength
      });
    }

    <span class="hljs-keyword">this</span>.changeRecords = <span class="hljs-keyword">this</span>.changeRecords.concat(changes);

    <span class="hljs-keyword">if</span>(options &amp;&amp; options.skipObservers) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deliverChangeRecords();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-318">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-318">&#182;</a>
              </div>
              <p><strong> pie.list.forEach </strong></p>
<p>Iterate the list, calling <code>f</code> with each item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  forEach: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items'</span>).forEach(f);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-319">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-319">&#182;</a>
              </div>
              <p><strong> pie.list.get </strong></p>
<p>Get an item at a specific index.
<code>key</code> can be any valid input to <code>_normalizeIndex</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key), path;

    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(idx)) path = key;
    <span class="hljs-keyword">else</span> path = <span class="hljs-string">'items.'</span> + idx;

    <span class="hljs-keyword">return</span> pie.model.prototype.get.call(<span class="hljs-keyword">this</span>, path);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-320">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-320">&#182;</a>
              </div>
              <p><strong> pie.list.indexOf </strong></p>
<p>Find the index of a specific value.
Uses the standard array equality check for indexOf.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  indexOf: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items'</span>).indexOf(value);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-321">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-321">&#182;</a>
              </div>
              <p><strong> pie.list.insert </strong></p>
<p>Insert <code>value</code> at the index specified by <code>key</code>.
Returns the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  insert: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

      value = <span class="hljs-keyword">this</span>._cast(value);

      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key),
      change = {
        name: <span class="hljs-built_in">String</span>(idx),
        object: <span class="hljs-keyword">this</span>.data.items,
        type: <span class="hljs-string">'add'</span>,
        oldValue: <span class="hljs-keyword">this</span>.data.items[idx],
        value: value
      };

      <span class="hljs-keyword">this</span>.data.items.splice(idx, <span class="hljs-number">0</span>, value);

      <span class="hljs-keyword">return</span> change;
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-322">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-322">&#182;</a>
              </div>
              <p><strong> pie.list.length </strong></p>
<p>The length of the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  length: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'items.length'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-323">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-323">&#182;</a>
              </div>
              <p><strong> pie.list.pop </strong></p>
<p>Pop an item off the end of the list.
Returns the item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pop: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">var</span> l = <span class="hljs-keyword">this</span>.length(), value;

    <span class="hljs-keyword">if</span>(!l) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> change = {
        name: l,
        object: <span class="hljs-keyword">this</span>.data.items,
        type: <span class="hljs-string">'delete'</span>,
        value: <span class="hljs-literal">undefined</span>,
      };

      change.oldValue = value = <span class="hljs-keyword">this</span>.data.items.pop();

      <span class="hljs-keyword">return</span> change;
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> value;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-324">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-324">&#182;</a>
              </div>
              <p><strong> pie.list.push </strong></p>
<p>Add an item to the end of the list.
Returns the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  push: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

      value = <span class="hljs-keyword">this</span>._cast(value);

      <span class="hljs-keyword">var</span> change = {
        name: <span class="hljs-built_in">String</span>(<span class="hljs-keyword">this</span>.data.items.length),
        object: <span class="hljs-keyword">this</span>.data.items,
        type: <span class="hljs-string">'add'</span>,
        value: value,
        oldValue: <span class="hljs-literal">undefined</span>
      };

      <span class="hljs-keyword">this</span>.data.items.push(value);

      <span class="hljs-keyword">return</span> change;
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-325">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-325">&#182;</a>
              </div>
              <p><strong> pie.list.remove </strong></p>
<p>Remove a specific index from the list.
Returns the removed item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, options)</span> </span>{

    <span class="hljs-keyword">var</span> value;

    <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key),
      change = {
        name: <span class="hljs-built_in">String</span>(idx),
        object: <span class="hljs-keyword">this</span>.data.items,
        type: <span class="hljs-string">'delete'</span>
      };

      change.oldValue = value = <span class="hljs-keyword">this</span>.data.items[idx];
      <span class="hljs-keyword">this</span>.data.items.splice(idx, <span class="hljs-number">1</span>);
      change.value = <span class="hljs-keyword">this</span>.data.items[idx];

      <span class="hljs-keyword">return</span> change;
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> value;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-326">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-326">&#182;</a>
              </div>
              <p><strong> pie.list.set </strong></p>
<p>Set an attribute or an index based on <code>key</code> to <code>value</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, options)</span> </span>{
    <span class="hljs-keyword">var</span> idx = <span class="hljs-keyword">this</span>._normalizedIndex(key);

    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(idx)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._super(key, value, options);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._trackMutations(options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">var</span> change = {
        name: <span class="hljs-built_in">String</span>(idx),
        object: <span class="hljs-keyword">this</span>.data.items,
        type: <span class="hljs-string">'update'</span>,
        oldValue: <span class="hljs-keyword">this</span>.data.items[idx]
      };

      value = <span class="hljs-keyword">this</span>._cast(value);

      <span class="hljs-keyword">this</span>.data.items[idx] = change.value = value;

      <span class="hljs-keyword">return</span> change;
    }.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-327">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-327">&#182;</a>
              </div>
              <p><strong> pie.list.shift </strong></p>
<p>Shift an item off the front of the list.
Returns the removed item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  shift: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.remove(<span class="hljs-number">0</span>, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-328">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-328">&#182;</a>
              </div>
              <p><strong> pie.list.unshift </strong></p>
<p>Insert an item at the beginning of the list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unshift: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.insert(<span class="hljs-number">0</span>, value, options);
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-329">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-329">&#182;</a>
              </div>
              <h1 id="pie-navigator">Pie Navigator</h1>
<p>The navigator is in charge of observing browser navigation and updating it’s data.
It’s also the place to conduct push/replaceState history changes.
The navigator is simply a model, enabling observation, computed values, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.navigator = pie.model.extend(<span class="hljs-string">'navigator'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span> </span>{
    <span class="hljs-keyword">this</span>.app = app;
    <span class="hljs-keyword">this</span>._super({});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-330">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-330">&#182;</a>
              </div>
              <p><strong> pie.navigator.go </strong></p>
<p>Go to <code>path</code>, appending <code>params</code>.
If <code>replace</code> is true replaceState will be used in favor of pushState.
If no changes are made, nothing will happen.</p>
<pre><code>navigator.go(<span class="hljs-string">'/foo/bar'</span>, {page: <span class="hljs-number">2</span>});
<span class="hljs-comment">//=&gt; pushState: '/foo/bar?page=2'</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  go: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, params, replace)</span> </span>{
    <span class="hljs-keyword">var</span> url = path;

    params = params || {};

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'path'</span>) === path &amp;&amp; <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'query'</span>) === params) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.keys(params).length) {
      url = pie.string.urlConcat(url, pie.object.serialize(params));
    }

    <span class="hljs-built_in">window</span>.history[replace ? <span class="hljs-string">'replaceState'</span> : <span class="hljs-string">'pushState'</span>]({}, <span class="hljs-built_in">document</span>.title, url);
    <span class="hljs-built_in">window</span>.historyObserver();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-331">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-331">&#182;</a>
              </div>
              <p><strong> pie.navigator.start </strong></p>
<p>Setup the navigator and initialize the data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  start: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">/* we can only have one per browser. Multiple apps should observe pieHistoryChang on the body */</span>
    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">window</span>.historyObserver) {
      <span class="hljs-built_in">window</span>.historyObserver = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        pie.dom.trigger(<span class="hljs-built_in">document</span>.body, <span class="hljs-string">'pieHistoryChange'</span>);
      };
    }
    <span class="hljs-comment">/* observe popstate and invoke our single history observer */</span>
    pie.dom.on(<span class="hljs-built_in">window</span>, <span class="hljs-string">'popstate'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-built_in">window</span>.historyObserver();
    });

    <span class="hljs-comment">/* subscribe this navigator to the global history event */</span>
    pie.dom.on(<span class="hljs-built_in">document</span>.body, <span class="hljs-string">'pieHistoryChange.nav-'</span> + <span class="hljs-keyword">this</span>.pieId, <span class="hljs-keyword">this</span>.setDataFromLocation.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.setDataFromLocation();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-332">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-332">&#182;</a>
              </div>
              <p><strong> pie.navigator.setDataFromLocation </strong></p>
<p>Look at <code>window.location</code> and transform it into stuff we care about.
Set the data on this navigator object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setDataFromLocation: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> stringQuery = <span class="hljs-built_in">window</span>.location.search.slice(<span class="hljs-number">1</span>),
    query = pie.string.deserialize(stringQuery);

    <span class="hljs-keyword">this</span>.sets({
      url: <span class="hljs-built_in">window</span>.location.href,
      path: <span class="hljs-built_in">window</span>.location.pathname,
      fullPath: pie.array.compact([<span class="hljs-built_in">window</span>.location.pathname, stringQuery], <span class="hljs-literal">true</span>).join(<span class="hljs-string">'?'</span>),
      query: query
    });
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-333">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-333">&#182;</a>
              </div>
              <h1 id="pie-notifier">Pie Notifier</h1>
<p>A class which provides an interface for rendering page-level notifications.
This does only structures and manages the data to be used by a view. This does not impelement
UI notifications.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.notifier = pie.base.extend(<span class="hljs-string">'notifier'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>.options = options || {};
    <span class="hljs-keyword">this</span>.app = app || <span class="hljs-keyword">this</span>.options.app || pie.appInstance;
    <span class="hljs-keyword">this</span>.notifications = <span class="hljs-keyword">new</span> pie.list([]);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-334">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-334">&#182;</a>
              </div>
              <p>remove all alerts, potentially filtering by the type of alert.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type)</span> </span>{
    <span class="hljs-keyword">if</span>(type) {
      <span class="hljs-keyword">this</span>.notifications.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span> </span>{
        <span class="hljs-keyword">this</span>.remove(n.id);
      }.bind(<span class="hljs-keyword">this</span>));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">while</span>(<span class="hljs-keyword">this</span>.notifications.length()) {
        <span class="hljs-keyword">this</span>.remove(<span class="hljs-keyword">this</span>.notifications.get(<span class="hljs-number">0</span>).id);
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-335">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-335">&#182;</a>
              </div>
              <p><strong> pie.notifier.notify </strong></p>
<p>Show a notification or notifications.
Messages can be a string or an array of messages.
You can choose to close a notification automatically by providing <code>true</code> as the third arg.
You can provide a number in milliseconds as the autoClose value as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  notify: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(messages, type, autoRemove)</span> </span>{
    type = type || <span class="hljs-string">'message'</span>;
    autoRemove = <span class="hljs-keyword">this</span>.getAutoRemoveTimeout(autoRemove);

    messages = pie.array.from(messages);
    messages = messages.map(<span class="hljs-keyword">this</span>.app.i18n.attempt.bind(<span class="hljs-keyword">this</span>.app.i18n));

    <span class="hljs-keyword">var</span> msg = {
      id: pie.unique(),
      messages: messages,
      type: type
    };

    <span class="hljs-keyword">this</span>.notifications.push(msg);

    <span class="hljs-keyword">if</span>(autoRemove) {
      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">this</span>.remove(msg.id);
      }.bind(<span class="hljs-keyword">this</span>), autoRemove);
    }

  },

  getAutoRemoveTimeout: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(timeout)</span> </span>{
    <span class="hljs-keyword">if</span>(timeout === <span class="hljs-literal">undefined</span>) timeout = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(timeout &amp;&amp; !pie.object.isNumber(timeout)) timeout = <span class="hljs-number">7000</span>;
    <span class="hljs-keyword">return</span> timeout;
  },

  remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msgId)</span> </span>{
    <span class="hljs-keyword">var</span> msgIdx = pie.array.indexOf(<span class="hljs-keyword">this</span>.notifications.get(<span class="hljs-string">'items'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span> </span>{
      <span class="hljs-keyword">return</span> m.id === msgId;
    });

    <span class="hljs-keyword">if</span>(~msgIdx) {
      <span class="hljs-keyword">this</span>.notifications.remove(msgIdx);
    }
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-336">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-336">&#182;</a>
              </div>
              <h1 id="pie-resources">Pie Resources</h1>
<p>An external resource loader. It specializes in retrieving scripts, stylesheets, and generic ajax content.
Upon load of the external resource a callback can be fired. Resources can be registered beforehand to make
development a bit easier and more standardized.</p>
<pre><code>resources.define(<span class="hljs-string">'googleMaps'</span>, <span class="hljs-string">'//maps.google.com/.../js'</span>);
resources.define(<span class="hljs-string">'templates'</span>, {src: <span class="hljs-string">'/my-templates.html'</span>, dataSuccess: parseTemplates});

resources.load(<span class="hljs-string">'googleMaps'</span>, <span class="hljs-string">'templates'</span>, <span class="hljs-string">'customI18n'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  google.Maps.doStuff();
});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.resources = pie.model.extend(<span class="hljs-string">'resources'</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-337">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-337">&#182;</a>
              </div>
              <p><strong> pie.resources.init </strong></p>
<p>Provide an app and a source map (shortcut all the <code>resources.define()</code> calls).</p>
<pre><code><span class="hljs-keyword">new</span> pie.resources(app, {googleMaps: <span class="hljs-string">'//maps.google.com/.../js'</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, srcMap)</span> </span>{
    <span class="hljs-keyword">this</span>._super({
      srcMap: srcMap || {},
      loaded: {}
    }, {
      app: app
    });

    pie.object.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,v)</span> </span>{
      <span class="hljs-keyword">this</span>.define(k, v);
    }.bind(<span class="hljs-keyword">this</span>));
  },

  _appendNode: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(node)</span> </span>{
    <span class="hljs-keyword">var</span> target = pie.qs(<span class="hljs-string">'head'</span>);
    target = target || <span class="hljs-built_in">document</span>.body;
    target.appendChild(node);
  },

  _inferredResourceType: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(src)</span> </span>{
    <span class="hljs-keyword">if</span>((<span class="hljs-regexp">/(\.|\/)js(\?|$)/</span>).test(src)) <span class="hljs-keyword">return</span> <span class="hljs-string">'script'</span>;
    <span class="hljs-keyword">if</span>((<span class="hljs-regexp">/(\.|\/)css(\?|$)/</span>).test(src)) <span class="hljs-keyword">return</span> <span class="hljs-string">'link'</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'ajax'</span>;
  },

  _normalizeSrc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(srcOrOptions)</span> </span>{
    <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">typeof</span> srcOrOptions === <span class="hljs-string">'string'</span> ? {src: srcOrOptions} : pie.object.merge({}, srcOrOptions);
    <span class="hljs-keyword">return</span> options;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-338">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-338">&#182;</a>
              </div>
              <p><strong>pie.resources._loadajax</strong></p>
<p>Conduct an ajax request and invoke the <code>resourceOnload</code> function when complete</p>
<p>Options:</p>
<ul>
<li><strong>src</strong> - the url of the request</li>
<li><strong> * </strong> - any valid ajax options</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _loadajax: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, resourceOnload)</span> </span>{
    <span class="hljs-keyword">var</span> ajaxOptions = pie.object.merge({
      verb: <span class="hljs-string">'GET'</span>,
      url: options.src
    }, options);

    <span class="hljs-keyword">var</span> request = <span class="hljs-keyword">this</span>.app.ajax.ajax(ajaxOptions);
    request.success(resourceOnload);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-339">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-339">&#182;</a>
              </div>
              <p><strong>pie.resources._loadscript</strong></p>
<p>Adds a <code>&lt;script&gt;</code> tag to the dom if the “type” is “script”</p>
<p>Options:</p>
<ul>
<li><strong>src</strong> - the url of the script.</li>
<li><strong>callbackName</strong> - <em>(optional)</em> the global callback name the loading library will invoke</li>
<li><strong>noAsync</strong> - <em>(optional)</em> if true, the script will be loaded synchronously.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _loadscript: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, resourceOnload)</span> </span>{

    <span class="hljs-keyword">var</span> script = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'script'</span>);

    <span class="hljs-keyword">if</span>(options.noAsync) script.async = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">/* If options.callbackName is present, the invoking method self-references itself so it can clean itself up. */</span>
    <span class="hljs-comment">/* Because of this, we don't need to invoke the onload */</span>
    <span class="hljs-keyword">if</span>(!options.callbackName) {
      script.onload = resourceOnload;
    }

    <span class="hljs-keyword">this</span>._appendNode(script);
    script.src = options.src;

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-340">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-340">&#182;</a>
              </div>
              <p><strong>pie.resources._loadlink</strong></p>
<p>Adds a <code>&lt;link&gt;</code> tag to the dom if the “type” of the resource is “link”.</p>
<p>Options:</p>
<ul>
<li><strong>src</strong> - the url of the resource</li>
<li><strong>media</strong> - <em>(optional)</em> defaulting to <code>screen</code>, it’s the media attribute of the <code>&lt;link&gt;</code></li>
<li><strong>rel</strong> - <em>(optional)</em> defaulting to <code>stylesheet</code>, it’s the rel attribute of the <code>&lt;link&gt;</code></li>
<li><strong>contentType</strong> - <em>(optional)</em> defaulting to <code>text/css</code>, it’s the type attribute of the <code>&lt;link&gt;</code></li>
</ul>
<p><em>Note that since <code>&lt;link&gt;</code> tags don’t provide a callback, the onload happens immediately.</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _loadlink: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, resourceOnload)</span> </span>{
    <span class="hljs-keyword">var</span> link = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'link'</span>);

    link.href = options.src;
    link.media = options.media || <span class="hljs-string">'screen'</span>;
    link.rel = options.rel || <span class="hljs-string">'stylesheet'</span>;
    link.type = options.contentType || <span class="hljs-string">'text/css'</span>;

    <span class="hljs-keyword">this</span>._appendNode(link);

    <span class="hljs-comment">/* Need to record that we added this thing. */</span>
    <span class="hljs-comment">/* The resource may not actually be present yet. */</span>
    resourceOnload();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-341">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-341">&#182;</a>
              </div>
              <p><strong> pie.resources.define </strong></p>
<p>Define a resource by human readable <code>name</code>. <code>srcOrOptions</code> is a url or
an options hash as described by the relevant <code>_load</code> function.</p>
<pre><code>resources.define(<span class="hljs-string">'googleMaps'</span>, <span class="hljs-string">'//maps.google.com/.../js'</span>);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  define: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, srcOrOptions)</span> </span>{
    <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">this</span>._normalizeSrc(srcOrOptions);
    <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'srcMap.'</span> + name, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-342">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-342">&#182;</a>
              </div>
              <p><strong> pie.resources.load </strong></p>
<p>Load resources defined by each argument.
If the last argument is a function it will be invoked after all resources have loaded.</p>
<pre><code>resources.load(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callback</span><span class="hljs-params">()</span></span>{});
resources.load([<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
resources.load(<span class="hljs-string">'//maps.google.com/.../js'</span>);
resources.load({src: <span class="hljs-string">'/templates.html'</span>, dataSuccess: parseTemplates}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callback</span><span class="hljs-params">()</span></span>{});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  load: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(<span class="hljs-comment">/* src1, src2, src3, onload */</span>)</span> </span>{
    <span class="hljs-keyword">var</span> sources = pie.array.change(<span class="hljs-built_in">arguments</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'flatten'</span>, <span class="hljs-string">'compact'</span>),
    onload = pie.object.isFunction(pie.array.last(sources)) ? sources.pop() : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{},
    fns;

    sources = sources.map(<span class="hljs-keyword">this</span>._normalizeSrc.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-comment">/* we generate a series of functions to be invoked by pie.fn.async */</span>
    <span class="hljs-comment">/* each function's responsibility is to invoke the provided callback when the resource is loaded */</span>
    fns = sources.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span></span>{

      <span class="hljs-comment">/* we could be dealing with an alias, so make sure to grab the real source */</span>
      options = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'srcMap.'</span> + options.src) || options;

      <span class="hljs-comment">/* we cache the status of the resource in our `loaded` object. */</span>
      <span class="hljs-keyword">var</span> src = options.src,
      loadedKey = <span class="hljs-string">'loaded.'</span> + src;

      <span class="hljs-comment">/* the pie.fn.async function */</span>
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
        <span class="hljs-keyword">var</span> loadedVal = <span class="hljs-keyword">this</span>.get(loadedKey);

        <span class="hljs-comment">/* if the loadedKey's value is true, we've already loaded this resource */</span>
        <span class="hljs-keyword">if</span>(loadedVal === <span class="hljs-literal">true</span>) {
          cb();
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-comment">/* otherwise, if it's present, it's an array of callbacks to be invoked when the resource is loaded (fifo) */</span>
        <span class="hljs-keyword">if</span>(loadedVal) {
          loadedVal.push(cb);
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-comment">/* holy balls, this is the first time. set the array up */</span>
        <span class="hljs-keyword">this</span>.set(loadedKey, [cb]);

        <span class="hljs-comment">/* determine the type of resource to be loaded */</span>
        <span class="hljs-keyword">var</span> type = options.type || <span class="hljs-keyword">this</span>._inferredResourceType(options.src),

        <span class="hljs-comment">/* upon load, we invoke all the registered callbacks for the resource */</span>
        resourceOnload = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{

          <span class="hljs-keyword">this</span>.get(loadedKey).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn)</span> </span>{ <span class="hljs-keyword">if</span>(fn) fn(); });

          <span class="hljs-comment">/* make sure we set the loadedKey to true so we know we don't have to do this again */</span>
          <span class="hljs-keyword">this</span>.set(loadedKey, <span class="hljs-literal">true</span>);

          <span class="hljs-comment">/* if we set up a global callbackName we make sure it's removed */</span>
          <span class="hljs-keyword">if</span>(options.callbackName) <span class="hljs-keyword">delete</span> <span class="hljs-built_in">window</span>[options.callbackName];
        }.bind(<span class="hljs-keyword">this</span>);

        <span class="hljs-comment">/* if a global callback name is desired, set it to our onload handler */</span>
        <span class="hljs-keyword">if</span>(options.callbackName) {
          <span class="hljs-built_in">window</span>[options.callbackName] = resourceOnload;
        }

        <span class="hljs-comment">/* start the resource */</span>
        <span class="hljs-keyword">this</span>[<span class="hljs-string">'_load'</span> + type](options, resourceOnload);

        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }.bind(<span class="hljs-keyword">this</span>);
    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-comment">/* now start loading all the resources */</span>
    pie.fn.async(fns, onload);
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-343">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-343">&#182;</a>
              </div>
              <h1 id="pie-route">Pie Route</h1>
<p>Represents a route used by the router.
Routes understand if they match string paths, they know how to extract interpolations from a path,
and know how to generate a path given some data.</p>
<pre><code>r = <span class="hljs-keyword">new</span> pie.route(<span class="hljs-string">'/foo/:id'</span>);

r.isDirectMatch(<span class="hljs-string">'/foo/bar'</span>)
<span class="hljs-comment">//=&gt; false</span>
r.isMatch(<span class="hljs-string">'/foo/bar'</span>)
<span class="hljs-comment">//=&gt; true</span>

r.interpolations(<span class="hljs-string">'/foo/bar'</span>)
<span class="hljs-comment">//=&gt; {id: 'bar'}</span>

r.path({id: <span class="hljs-string">'baz'</span>, page: <span class="hljs-number">2</span>})
<span class="hljs-comment">//=&gt; '/foo/baz?page=2'</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>pie.route = pie.model.extend(<span class="hljs-string">'route'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, options)</span> </span>{
    <span class="hljs-keyword">this</span>._super({
      pathTemplate: pie.string.normalizeUrl(path)
    }, options);

    <span class="hljs-keyword">this</span>.name = <span class="hljs-keyword">this</span>.options.name;

    <span class="hljs-keyword">this</span>.compute(<span class="hljs-string">'splitPathTemplate'</span>, <span class="hljs-string">'pathTemplate'</span>);
    <span class="hljs-keyword">this</span>.compute(<span class="hljs-string">'interpolationsCount'</span>, <span class="hljs-string">'pathTemplate'</span>);
    <span class="hljs-keyword">this</span>.compute(<span class="hljs-string">'pathRegex'</span>, <span class="hljs-string">'pathTemplate'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-344">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-344">&#182;</a>
              </div>
              <p><strong>pie.route.splitPathTemplate</strong></p>
<p>The pathTemplate split into segments.
Since this is a computed property, we only ever have to do this once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  splitPathTemplate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathTemplate'</span>).split(<span class="hljs-string">'/'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-345">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-345">&#182;</a>
              </div>
              <p><strong>pie.route.interpolationsCount</strong></p>
<p>The number of interpolations this route has.
Since this is a computed property, we only ever have to do this once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  interpolationsCount: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> m = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathTemplate'</span>).match(<span class="hljs-regexp">/:/g</span>);
    <span class="hljs-keyword">return</span> m &amp;&amp; m.length || <span class="hljs-number">0</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-346">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-346">&#182;</a>
              </div>
              <p><strong>pie.route.pathRegex</strong></p>
<p>A RegExp representing the path.
Since this is a computed property, we only ever have to do this once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pathRegex: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span> + <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathTemplate'</span>).replace(<span class="hljs-regexp">/(:[^\/]+)/g</span>,<span class="hljs-string">'([^\\/]+)'</span>) + <span class="hljs-string">'$'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-347">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-347">&#182;</a>
              </div>
              <p><strong>pie.route.interpolations</strong></p>
<p>Under the assumption that the path is already normalized and we’ve “matched” it,
extract the interpolations from <code>path</code>. If <code>parseValues</code> is true, the values will
be parsed based on <code>pie.string.deserialize</code>‘s implementation.</p>
<pre><code>r = <span class="hljs-keyword">new</span> pie.route(<span class="hljs-string">'/foo/:id'</span>);
r.interolations(<span class="hljs-string">'/foo/bar'</span>);
<span class="hljs-comment">//=&gt; {id: 'bar'}</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  interpolations: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, parseValues)</span> </span>{
    <span class="hljs-keyword">var</span> splitPaths = path.split(<span class="hljs-string">'/'</span>),
    tmpls = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'splitPathTemplate'</span>),
    interpolations = {},
    splitPath, tmpl;

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; splitPaths.length; i++){
      tmpl = tmpls[i];
      splitPath = splitPaths[i];
      <span class="hljs-keyword">if</span>(splitPath !== tmpl) {
        <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/^:/</span>.test(tmpl)) {
          interpolations[tmpl.replace(<span class="hljs-regexp">/^:/</span>, <span class="hljs-string">''</span>)] = splitPath;
        }
      }
    }

    <span class="hljs-keyword">if</span>(parseValues) interpolations = pie.string.deserialize(pie.object.serialize(interpolations), <span class="hljs-literal">true</span>);

    <span class="hljs-keyword">return</span> interpolations;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-348">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-348">&#182;</a>
              </div>
              <p><strong>pie.route.isDirectMatch</strong></p>
<p>Is the provided <code>path</code> a direct match to our definition?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isDirectMatch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">return</span> path === <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathTemplate'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-349">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-349">&#182;</a>
              </div>
              <p><strong>pie.route.isMatch</strong></p>
<p>is the provided <code>path</code> a match based on our <code>pathRegex</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isMatch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathRegex'</span>).test(path);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-350">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-350">&#182;</a>
              </div>
              <p><strong>pie.route.path</strong></p>
<p>Generate a path based on our template &amp; the provided <code>data</code>. If <code>interpolateOnly</code> is true,
a query string will not be appended, even if there are extra items provided by <code>data</code>.</p>
<pre><code>r = <span class="hljs-keyword">new</span> pie.route(<span class="hljs-string">'/foo/:id'</span>);
r.path({id: <span class="hljs-string">'bar'</span>})
<span class="hljs-comment">//=&gt; '/foo/bar'</span>
r.path({id: <span class="hljs-string">'baz'</span>, page: <span class="hljs-number">2</span>});
<span class="hljs-comment">//=&gt; '/foo/baz?page=2'</span>
r.path({id: <span class="hljs-string">'qux'</span>, page: <span class="hljs-number">2</span>}, <span class="hljs-literal">true</span>);
<span class="hljs-comment">//=&gt; '/foo/qux'</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  path: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, interpolateOnly)</span> </span>{
    <span class="hljs-keyword">var</span> usedKeys = [],
    s = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'pathTemplate'</span>),
    params,
    unusedData;

    data = data || {};

    s = s.replace(<span class="hljs-regexp">/\:([a-zA-Z0-9_]+)/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match, key)</span></span>{
      usedKeys.push(key);
      <span class="hljs-keyword">if</span>(data[key] === <span class="hljs-literal">undefined</span> || data[key] === <span class="hljs-literal">null</span> || data[key].toString().length === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"[PIE] missing route interpolation: "</span> + match);
      }
      <span class="hljs-keyword">return</span> data[key];
    });

    s = pie.string.normalizeUrl(s);

    unusedData = pie.object.except(data, usedKeys);
    params = pie.object.serialize(pie.object.compact(unusedData, <span class="hljs-literal">true</span>));

    <span class="hljs-keyword">if</span>(!interpolateOnly &amp;&amp; params.length) {
      s = pie.string.urlConcat(s, params);
    }

    <span class="hljs-keyword">return</span> s;
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-351">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-351">&#182;</a>
              </div>
              <h1 id="pie-router">Pie Router</h1>
<p>An interface for declaring, processing, and determing a collection of routes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.router = pie.model.extend(<span class="hljs-string">'router'</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-352">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-352">&#182;</a>
              </div>
              <p><strong>pie.router.init</strong></p>
<p>Initialize a new router given an <code>app</code> and a set of options.
Options:</p>
<ul>
<li><strong>root</strong> - the root to be prepended to all constructed routes. Defaults to <code>&#39;/&#39;</code>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>._super({
      routes: [],
      routeNames: {},
      root: options &amp;&amp; options.root || <span class="hljs-string">'/'</span>
    }, pie.object.merge({
      app: app
    }, options));

    <span class="hljs-keyword">this</span>.cache = <span class="hljs-keyword">new</span> pie.cache();
    <span class="hljs-keyword">this</span>.compute(<span class="hljs-string">'rootRegex'</span>, <span class="hljs-string">'root'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-353">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-353">&#182;</a>
              </div>
              <p><strong>pie.router.rootRegex</strong></p>
<p>A regex for testing whether a path starts with the declared root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rootRegex: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span> + <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'root'</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-354">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-354">&#182;</a>
              </div>
              <p><strong>pie.router.changedUrl</strong></p>
<p>Get a url based on the app’s current one but with the changes provided.
This will even catch interpolated values.</p>
<pre><code><span class="hljs-comment">// Given a route of `/things/page/:page.json`</span>
<span class="hljs-comment">// and the current path == `/things/page/1.json?q=test`</span>
app.router.changedUrl({page: <span class="hljs-number">3</span>, q: <span class="hljs-string">'newQuery'</span>});
<span class="hljs-comment">//=&gt; /things/page/3.json?q=newQuery</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  changedUrl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(changes)</span> </span>{
    <span class="hljs-keyword">var</span> current = <span class="hljs-keyword">this</span>.app.parsedUrl;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.path(current.route &amp;&amp; current.route.name || current.path, pie.object.merge({}, current.data, changes));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-355">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-355">&#182;</a>
              </div>
              <p><strong>pie.router.findRoute</strong></p>
<p>Find the most relevant route based on <code>nameOrPath</code>.
Direct matches match first, then the most relevant pattern match comes next.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  findRoute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(nameOrPath)</span> </span>{
    <span class="hljs-keyword">var</span> route = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'routeNames.'</span> + nameOrPath);
    <span class="hljs-comment">/* if a direct match is present, we return that */</span>
    route = route || pie.array.detect(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'routes'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span></span>{ <span class="hljs-keyword">return</span> r.isDirectMatch(nameOrPath); });
    <span class="hljs-comment">/* otherwise, we look for a pattern match */</span>
    route = route || pie.array.detect(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'routes'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span></span>{ <span class="hljs-keyword">return</span> r.isMatch(nameOrPath); });
    <span class="hljs-keyword">return</span> route;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-356">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-356">&#182;</a>
              </div>
              <p><strong>pie.router.map</strong></p>
<p>Add routes to this router.
Routes objects which contain a “name” key will be added as a name lookup.
You can pass a set of defaults which will be extended into each route object.</p>
<pre><code>router.map({

  <span class="hljs-string">'/foo/:id'</span> : {subView: <span class="hljs-string">'foo'</span>,  name: <span class="hljs-string">'foo'</span>},
  <span class="hljs-string">'/bars'</span>    : {subView: <span class="hljs-string">'bars'</span>, name: <span class="hljs-string">'bars'</span>},

  <span class="hljs-string">'api.whatever'</span> : <span class="hljs-string">'/api/whatever.json'</span>
}, {
  view: <span class="hljs-string">'sublayout'</span>
});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  map: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(routes, defaults)</span></span>{
    defaults = defaults || {};

    <span class="hljs-keyword">var</span> path, config, route;

    pie.object.forEach(routes, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,r)</span> </span>{

      <span class="hljs-keyword">if</span>(pie.object.isObject(r)) {
        path = k;
        config = r;
        <span class="hljs-keyword">if</span>(defaults) config = pie.object.merge({}, defaults, config);
      } <span class="hljs-keyword">else</span> {
        path = r;
        config = {name: k};
      }

      route = <span class="hljs-keyword">new</span> pie.route(path, config);

      <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'routes'</span>).push(route);
      <span class="hljs-keyword">if</span>(route.name) <span class="hljs-keyword">this</span>.set(<span class="hljs-string">'routeNames.'</span> + route.name, route);

    }.bind(<span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">this</span>.sortRoutes();
    <span class="hljs-keyword">this</span>.cache.clear();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-357">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-357">&#182;</a>
              </div>
              <p><strong>pie.router.path</strong></p>
<p>Will return the named path. If there is no path with that name it will return itself.
You can optionally pass a data hash and it will build the path with query params or
with path interpolation.</p>
<pre><code>router.path(<span class="hljs-string">"/foo/bar/:id"</span>, {id: <span class="hljs-string">'44'</span>, q: <span class="hljs-string">'search'</span>})
<span class="hljs-comment">//=&gt; "/foo/bar/44?q=search"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  path: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(nameOrPath, data, interpolateOnly)</span> </span>{
    <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">this</span>.findRoute(nameOrPath) || <span class="hljs-keyword">new</span> pie.route(nameOrPath),
    path;

    data = pie.object.merge(r.interpolations(nameOrPath), data);
    path = r.path(data, interpolateOnly);</pre></div></div>
            
        </li>
        
        
        <li id="section-358">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-358">&#182;</a>
              </div>
              <p>apply the root.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!pie.string.PROTOCOL_TEST.test(path) &amp;&amp; !<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'rootRegex'</span>).test(path)) {
      path = <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'root'</span>) + path;
      path = pie.string.normalizeUrl(path);
    }

    <span class="hljs-keyword">return</span> path;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-359">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-359">&#182;</a>
              </div>
              <p><strong>pie.router.sortRoutes</strong></p>
<p>Sorts the routes to be the most exact to the most generic.</p>
<ul>
<li>prefers fewer interpolations to more</li>
<li>prefers more segments to less</li>
<li>prefers more characters to less</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sortRoutes: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> ac, bc, c;

    <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'routes'</span>).sort(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span> </span>{
      ac = a.get(<span class="hljs-string">'interpolationsCount'</span>);
      bc = b.get(<span class="hljs-string">'interpolationsCount'</span>);
      c = ac - bc;
      c = c || (b.get(<span class="hljs-string">'splitPathTemplate'</span>).length - a.get(<span class="hljs-string">'splitPathTemplate'</span>).length);
      c = c || (b.get(<span class="hljs-string">'pathTemplate'</span>).length - a.get(<span class="hljs-string">'pathTemplate'</span>).length);
      <span class="hljs-keyword">return</span> c;
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-360">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-360">&#182;</a>
              </div>
              <p><strong>pie.router.parseUrl</strong></p>
<p>Given a <code>path</code>, generate an object representing the matching route.
The result will  have the following attributes:</p>
<ul>
<li><strong>path</strong> - a normalized version of the matching path.</li>
<li><strong>fullPath</strong> - the normalized path including the query string.</li>
<li><strong>interpolations</strong> - an object representing the interpolations within the path.</li>
<li><strong>query</strong> - an object representing the query string.</li>
<li><strong>data</strong> - an object combining the interpolations and the query</li>
<li><strong>route</strong> - the matching route object.</li>
<li><strong> * </strong> - all the information passed into the router for the matching route.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parseUrl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, parseQuery)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache.getOrSet(path, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

      <span class="hljs-keyword">var</span> result, pieces, query, match, fullPath, pathWithRoot, interpolations;

      pieces = path.split(<span class="hljs-string">'?'</span>);

      path = pieces.shift();
      path = path.replace(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'rootRegex'</span>), <span class="hljs-string">''</span>);
      path = pie.string.normalizeUrl(path);

      query = pieces.join(<span class="hljs-string">'&amp;'</span>) || <span class="hljs-string">''</span>;

      match = <span class="hljs-keyword">this</span>.findRoute(path);

      query = pie.string.deserialize(query, parseQuery);
      fullPath = pie.array.compact([path, pie.object.serialize(query)], <span class="hljs-literal">true</span>).join(<span class="hljs-string">'?'</span>);
      pathWithRoot = pie.string.normalizeUrl(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'root'</span>) + path);
      interpolations = match &amp;&amp; match.interpolations(path, parseQuery);

      result = pie.object.merge({
        path: path,
        fullPath: fullPath,
        pathWithRoot: pathWithRoot,
        interpolations: interpolations || {},
        query: query,
        data: pie.object.merge({}, interpolations, query),
        route: match
      }, match &amp;&amp; match.options);

      <span class="hljs-keyword">return</span> result;
    }.bind(<span class="hljs-keyword">this</span>));
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-361">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-361">&#182;</a>
              </div>
              <h1 id="pie-templates">Pie Templates</h1>
<p>A container for a collection of templates. It knows how to read, compile, and invoke template functions.</p>
<pre><code>templates.registerTemplate(<span class="hljs-string">'plainOld'</span>, <span class="hljs-string">"Just plain old string content: [%= data.id %]"</span>);
templates.render(<span class="hljs-string">'plainOld'</span>, {id: <span class="hljs-string">'fooBar'</span>});
<span class="hljs-comment">//=&gt; "Just plain old string content: fooBar"</span>
</code></pre><p>Templates can be declared in two ways:</p>
<ol>
<li><strong>script tag content</strong> - tags matching the <code>templateSelector</code> class option can be given an id attribute which maps to the templates name.
If a template by that name is requested and has not yet been compiled, the tag’s content will be parsed and a template function will be generated.</li>
<li><strong>script tag data-src</strong> - The same process as <code>1.</code> is followed but if a <code>data-src</code> attribute is present a <code>text/html</code> ajax request will take place to fetch the template content.
After fetch, the content will be parsed and a template will be generated. This method is inherently async and is only checked if <code>templates#renderAsync</code> is used.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.templates = pie.model.extend(<span class="hljs-string">'templates'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, options)</span> </span>{
    <span class="hljs-keyword">this</span>._super({}, pie.object.merge({
      app: app,
      templateSelector: <span class="hljs-string">'script[type="text/pie-template"]'</span>
    }, options));
  },

  _node: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> </span>{
    <span class="hljs-keyword">return</span> pie.qs(<span class="hljs-keyword">this</span>.options.templateSelector + <span class="hljs-string">'[id="'</span> + name + <span class="hljs-string">'"]'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-362">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-362">&#182;</a>
              </div>
              <p><strong>pie.templates.registerTemplate</strong></p>
<p>Register a template containing the <code>content</code> by the <code>name</code>.
The resulting function will be one produced by <code>pie.string.template</code> but will
have any registered helpers available via the <code>pie.helpers</code> <code>variableName</code> option.</p>
<p>So the following template would function fine, given the default helper methods as defined by <code>pie.helpers</code></p>
<pre><code>&lt;h1&gt;[%= h.t(<span class="hljs-string">"account.hello"</span>) %], [%= h.get(data, <span class="hljs-string">"firstName"</span>) %]&lt;<span class="hljs-regexp">/h1&gt;</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  registerTemplate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, content)</span> </span>{
    <span class="hljs-keyword">this</span>.app.debug(<span class="hljs-string">'Compiling and storing template: '</span> + name);

    <span class="hljs-keyword">this</span>.set(name, pie.string.template(content, <span class="hljs-keyword">this</span>.app.helpers.provideVariables()));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-363">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-363">&#182;</a>
              </div>
              <p><strong>pie.templates.load</strong></p>
<p>Load a template from an external source, register it, then invoke the callback.</p>
<pre><code>templates.load(<span class="hljs-string">'fooBar'</span>, {url: <span class="hljs-string">'/foo-bar.html'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  template.render(<span class="hljs-string">'fooBar'</span>, {});
});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  load: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, ajaxOptions, cb)</span> </span>{
    ajaxOptions = pie.object.merge({
      verb: <span class="hljs-string">'get'</span>,
      accept: <span class="hljs-string">'text/html'</span>
    }, ajaxOptions);

    <span class="hljs-keyword">var</span> req = <span class="hljs-keyword">this</span>.app.ajax.ajax(ajaxOptions);

    req.dataSuccess(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(content)</span> </span>{
      <span class="hljs-keyword">this</span>.registerTemplate(name, content);
    }.bind(<span class="hljs-keyword">this</span>)).error(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"[PIE] Template fetch error: "</span> + name);
    }).complete(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      cb();
    });

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-364">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-364">&#182;</a>
              </div>
              <p><strong>pie.templates.render</strong></p>
<p>Synchronously render a template named <code>name</code> with <code>data</code>.
This will compile and register a template if it’s never been seen before.</p>
<pre><code>&lt;script id="fooBar" type="text/pie-template"&gt;
  Hi, [%= data.name %]
&lt;/script&gt;
&lt;script&gt;
  templates.render('fooBar', {name: 'Doug'});
  //=&gt; "Hi, Doug"
&lt;/script&gt;
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, data)</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.get(name)) {

      <span class="hljs-keyword">var</span> node = <span class="hljs-keyword">this</span>._node(name);

      <span class="hljs-keyword">if</span>(node) {
        <span class="hljs-keyword">this</span>.registerTemplate(name, node.content || node.textContent);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"[PIE] Unknown template error: "</span> + name);
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(name)(data || {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-365">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-365">&#182;</a>
              </div>
              <p><strong>pie.templates.renderAsync</strong></p>
<p>Render a template asynchronously. That is, attempt to extract the content from the associated <code>&lt;script&gt;</code> but
if it declares a <code>data-src</code> attribute, fetch the content from there instead. When the template is available
and rendered, invoke the callback <code>cb</code> with the content.</p>
<pre><code>&lt;script id=<span class="hljs-string">"fooBar"</span> type=<span class="hljs-string">"text/pie-template"</span> data-src=<span class="hljs-string">"/foo-bar.html"</span>&gt;<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">
  templates.renderAsync(<span class="hljs-string">'fooBar'</span>, {name: <span class="hljs-string">'Doug'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(content)</span></span>{
    <span class="hljs-comment">//=&gt; "Hi, Doug"</span>
  });
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span></span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  renderAsync: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, data, cb)</span> </span>{

    <span class="hljs-keyword">var</span> content, node, src;

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.get(name)) {
      content = <span class="hljs-keyword">this</span>.render(name, data);
      cb(content);
      <span class="hljs-keyword">return</span>;
    }

    node = <span class="hljs-keyword">this</span>._node(name);
    src = node &amp;&amp; node.getAttribute(<span class="hljs-string">'data-src'</span>);

    <span class="hljs-keyword">if</span>(src) {
      <span class="hljs-keyword">this</span>.load(name, {url: src}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">this</span>.renderAsync(name, data, cb);
      });
    } <span class="hljs-keyword">else</span> {
      content = <span class="hljs-keyword">this</span>.render(name, data);
      cb(content);
      <span class="hljs-keyword">return</span>;
    }
  },
});
pie.validator = pie.base.extend(<span class="hljs-string">'validator'</span>, (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-366">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-366">&#182;</a>
              </div>
              <p><a href="http://rosettacode.org/wiki/Luhn_test_of_credit_card_numbers#JavaScript">http://rosettacode.org/wiki/Luhn_test_of_credit_card_numbers#JavaScript</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> luhnCheck = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b,c,d,e)</span> </span>{
    <span class="hljs-keyword">for</span>(d = +a[b = a.length-<span class="hljs-number">1</span>], e=<span class="hljs-number">0</span>; b--;)
      c = +a[b], d += ++e % <span class="hljs-number">2</span> ? <span class="hljs-number">2</span> * c % <span class="hljs-number">10</span> + (c &gt; <span class="hljs-number">4</span>) : c;
    <span class="hljs-keyword">return</span> !(d%<span class="hljs-number">10</span>);
  };

  <span class="hljs-keyword">return</span> {

    init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span> </span>{
      <span class="hljs-keyword">this</span>.app = app || pie.appInstance;
      <span class="hljs-keyword">this</span>.i18n = app.i18n;
    },


    errorMessage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(validationType, validationOptions)</span> </span>{
      <span class="hljs-keyword">if</span>(validationOptions.message) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.app.i18n.attempt(validationOptions.message);
      <span class="hljs-keyword">var</span> key = validationOptions.messageKey || validationType,
      base = <span class="hljs-keyword">this</span>.i18n.t(<span class="hljs-string">'app.validations.'</span> + key),
      rangeOptions = <span class="hljs-keyword">new</span> pie.validator.rangeOptions(<span class="hljs-keyword">this</span>.app, validationOptions),
      range = rangeOptions.message();

      <span class="hljs-keyword">if</span>(!range &amp;&amp; key === <span class="hljs-string">'length'</span>) {
        rangeOptions = <span class="hljs-keyword">new</span> pie.validator.rangeOptions(<span class="hljs-keyword">this</span>.app, {gt: <span class="hljs-number">0</span>});
        range = rangeOptions.message();
      }

      <span class="hljs-keyword">return</span> (base + <span class="hljs-string">' '</span> + range).trim();
    },


    withStandardChecks: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options, f)</span></span>{
      options = options || {};

      <span class="hljs-keyword">if</span>(options.allowBlank &amp;&amp; !<span class="hljs-keyword">this</span>.presence(value))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(options.unless &amp;&amp; options.unless.call())
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(options[<span class="hljs-string">'if'</span>] &amp;&amp; !options[<span class="hljs-string">'if'</span>].call())
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> f.call();
    },


    ccNumber: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-367">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-367">&#182;</a>
              </div>
              <p>don’t get rid of letters because we don’t want a mix of letters and numbers passing through</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> sanitized = <span class="hljs-built_in">String</span>(value).replace(<span class="hljs-regexp">/[^a-zA-Z0-9]/g</span>, <span class="hljs-string">''</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.number(sanitized) &amp;&amp;
               <span class="hljs-keyword">this</span>.length(sanitized, {gte: <span class="hljs-number">10</span>, lte: <span class="hljs-number">16</span>}) &amp;&amp;
               luhnCheck(sanitized);
      }.bind(<span class="hljs-keyword">this</span>));
    },


    ccExpirationMonth: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.integer(value, {gte: <span class="hljs-number">1</span>, lte: <span class="hljs-number">12</span>});
      }.bind(<span class="hljs-keyword">this</span>));
    },


    ccExpirationYear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.integer(value, {gte: now.getFullYear(), lte: now.getFullYear() + <span class="hljs-number">20</span>});
      }.bind(<span class="hljs-keyword">this</span>));
    },


    ccSecurity: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.number(value) &amp;&amp;
                <span class="hljs-keyword">this</span>.length(value, {gte: <span class="hljs-number">3</span>, lte: <span class="hljs-number">4</span>});
      }.bind(<span class="hljs-keyword">this</span>));
    },


    chosen: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value <span class="hljs-comment">/* , options */</span>)</span></span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(value)) {
        <span class="hljs-keyword">return</span> !!value.length;
      }
      <span class="hljs-keyword">return</span> value != <span class="hljs-literal">null</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-368">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-368">&#182;</a>
              </div>
              <p>a date should be in the ISO format yyyy-mm-dd</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    date: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
      options = options || {};
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> split = value.split(<span class="hljs-string">'-'</span>), y = split[<span class="hljs-number">0</span>], m = split[<span class="hljs-number">1</span>], d = split[<span class="hljs-number">2</span>], iso;

        <span class="hljs-keyword">if</span>(!y || !m || !d) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.length(y, {eq: <span class="hljs-number">4</span>}) &amp;&amp; <span class="hljs-keyword">this</span>.length(m, {eq: <span class="hljs-number">2</span>}) &amp;&amp; <span class="hljs-keyword">this</span>.length(d, {eq: <span class="hljs-number">2</span>})) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span>(!options.sanitized) {
          <span class="hljs-built_in">Object</span>.keys(options).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span></span>{
            iso = options[k];
            iso = <span class="hljs-keyword">this</span>.app.i18n.l(iso, <span class="hljs-string">'isoDate'</span>);
            options[k] = iso;
          });
          options.sanitized = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">var</span> ro = <span class="hljs-keyword">new</span> pie.validator.rangeOptions(<span class="hljs-keyword">this</span>.app, options);
        <span class="hljs-keyword">return</span> ro.matches(value);

      }.bind(<span class="hljs-keyword">this</span>));
    },


    email: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
      options = pie.object.merge({allowBlank: <span class="hljs-literal">false</span>}, options || {});
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^.+@.+\..+$/</span>).test(value);
      });
    },


    fn: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options, cb)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">return</span> options.fn.call(<span class="hljs-literal">null</span>, value, options, cb);
      });
    },


    format: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
      options = options || {};
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> fmt = options.format || options[<span class="hljs-string">'with'</span>];

        <span class="hljs-keyword">if</span>(fmt === <span class="hljs-string">'isoDate'</span>){
          fmt = <span class="hljs-regexp">/^\d{4}\-\d{2}\-\d{2}$/</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(fmt === <span class="hljs-string">'epochs'</span>){
          fmt = <span class="hljs-regexp">/^\d{10}$/</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(fmt === <span class="hljs-string">'epochms'</span>){
          fmt = <span class="hljs-regexp">/^\d{13}$/</span>;
        }

        <span class="hljs-keyword">return</span> !!fmt.test(<span class="hljs-built_in">String</span>(value));
      });
    },

    inclusion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
      options = options || {};
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> inVal = pie.fn.valueFrom(options[<span class="hljs-string">'in'</span>]);
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(inVal)) <span class="hljs-keyword">return</span> !inVal.length || !!~inVal.indexOf(value);
        <span class="hljs-keyword">return</span> inVal == <span class="hljs-literal">null</span> || inVal === value;
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-369">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-369">&#182;</a>
              </div>
              <p>must be an integer (2.0 is ok) (good for quantities)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    integer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
      <span class="hljs-keyword">return</span>  <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">return</span>  <span class="hljs-keyword">this</span>.number(value, options) &amp;&amp;
                <span class="hljs-built_in">parseInt</span>(value, <span class="hljs-number">10</span>) === <span class="hljs-built_in">parseFloat</span>(value, <span class="hljs-number">10</span>);
      }.bind(<span class="hljs-keyword">this</span>));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-370">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-370">&#182;</a>
              </div>
              <p>min/max length of the field</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    length: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
      options = pie.object.merge({allowBlank: <span class="hljs-literal">false</span>}, options);

      <span class="hljs-keyword">if</span>(!pie.object.has(options, <span class="hljs-string">'gt'</span>)  &amp;&amp;
         !pie.object.has(options, <span class="hljs-string">'gte'</span>)  &amp;&amp;
         !pie.object.has(options, <span class="hljs-string">'lt'</span>)  &amp;&amp;
         !pie.object.has(options, <span class="hljs-string">'lte'</span>)  &amp;&amp;
         !pie.object.has(options, <span class="hljs-string">'eq'</span>) ){
        options.gt = <span class="hljs-number">0</span>;
      }

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">var</span> length = <span class="hljs-built_in">String</span>(value).trim().length;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.number(length, options);
      }.bind(<span class="hljs-keyword">this</span>));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-371">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-371">&#182;</a>
              </div>
              <p>must be some kind of number (good for money input)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    number: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
      options = options || {};

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-372">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-372">&#182;</a>
              </div>
              <p>not using parseFloat because it accepts multiple decimals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(!<span class="hljs-regexp">/^([\-])?([\d]+)?\.?[\d]+$/</span>.test(<span class="hljs-built_in">String</span>(value))) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">var</span> number = <span class="hljs-built_in">parseFloat</span>(value),
        ro = <span class="hljs-keyword">new</span> pie.validator.rangeOptions(<span class="hljs-keyword">this</span>.app, options);

        <span class="hljs-keyword">return</span> ro.matches(number);
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-373">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-373">&#182;</a>
              </div>
              <p>clean out all things that are not numbers and + and get a minimum of 10 digits.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    phone: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
      options = pie.object.merge({allowBlank: <span class="hljs-literal">false</span>}, options || {});

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">var</span> clean = <span class="hljs-built_in">String</span>(value).replace(<span class="hljs-regexp">/[^\+\d]+/g</span>, <span class="hljs-string">''</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.length(clean, {gte: <span class="hljs-number">10</span>});
      }.bind(<span class="hljs-keyword">this</span>));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-374">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-374">&#182;</a>
              </div>
              <p>does the value have any non-whitespace characters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    presence: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span></span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, pie.object.merge({}, options, {allowBlank: <span class="hljs-literal">false</span>}), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">return</span> !!(value &amp;&amp; (<span class="hljs-regexp">/[^ ]/</span>).test(<span class="hljs-built_in">String</span>(value)));
      });
    },


    url: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, options)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.withStandardChecks(value, options, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^.+\..+$/</span>).test(value);
      });
    }
  };
})());</pre></div></div>
            
        </li>
        
        
        <li id="section-375">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-375">&#182;</a>
              </div>
              <p>small utility class to handle range options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.validator.rangeOptions = pie.base.extend(<span class="hljs-string">'rangeOptions'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, hash)</span> </span>{
    <span class="hljs-keyword">this</span>.i18n = app.i18n;
    <span class="hljs-keyword">this</span>.rangedata = hash || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-376">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-376">&#182;</a>
              </div>
              <p>for double casting new RangeOptions(new RangeOptions({}));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.rangedata.rangedata) <span class="hljs-keyword">this</span>.rangedata = <span class="hljs-keyword">this</span>.rangedata.rangedata ;
  },

  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">return</span> pie.fn.valueFrom(<span class="hljs-keyword">this</span>.rangedata[key]);
  },

  has: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">return</span> !!(key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.rangedata);
  },

  t: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, options)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.i18n.t(<span class="hljs-string">'app.validations.range_messages.'</span> + key, options);
  },

  matches: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">var</span> valid = <span class="hljs-literal">true</span>;
    valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gt'</span>) || value &gt; <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gt'</span>));
    valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lt'</span>) || value &lt; <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lt'</span>));
    valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gte'</span>) || value &gt;= <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gte'</span>));
    valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lte'</span>) || value &lt;= <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lte'</span>));
    valid = valid &amp;&amp; (!<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'eq'</span>) || value === <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eq'</span>));
    <span class="hljs-keyword">return</span> valid;
  },

  message: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'eq'</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'eq'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'eq'</span>)});
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> s = [<span class="hljs-string">''</span>,<span class="hljs-string">''</span>];

      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gt'</span>)) s[<span class="hljs-number">0</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'gt'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gt'</span>)});
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'gte'</span>)) s[<span class="hljs-number">0</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'gte'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'gte'</span>)});

      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lt'</span>)) s[<span class="hljs-number">1</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'lt'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lt'</span>)});
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.has(<span class="hljs-string">'lte'</span>)) s[<span class="hljs-number">1</span>] += <span class="hljs-keyword">this</span>.t(<span class="hljs-string">'lte'</span>, {count: <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'lte'</span>)});

      <span class="hljs-keyword">return</span> pie.array.toSentence(pie.array.compact(s, <span class="hljs-literal">true</span>), <span class="hljs-keyword">this</span>.i18n).trim();
    }
  },
});</pre></div></div>
            
        </li>
        
        
        <li id="section-377">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-377">&#182;</a>
              </div>
              <p>general framework for transitioning between views.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.abstractViewTransition = pie.base.extend(<span class="hljs-string">'abstractViewTransition'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parent, options)</span> </span>{
    options = options || {};

    <span class="hljs-keyword">this</span>.emitter    = <span class="hljs-keyword">new</span> pie.emitter();
    <span class="hljs-keyword">this</span>.parent     = parent;
    <span class="hljs-keyword">this</span>.oldChild   = options.oldChild;
    <span class="hljs-keyword">this</span>.newChild   = options.newChild;
    <span class="hljs-keyword">this</span>.childName  = options.childName || <span class="hljs-keyword">this</span>.oldChild &amp;&amp; <span class="hljs-keyword">this</span>.oldChild._nameWithinParent;
    <span class="hljs-keyword">this</span>.targetEl   = options.targetEl  || <span class="hljs-keyword">this</span>.oldChild &amp;&amp; <span class="hljs-keyword">this</span>.oldChild.el.parentNode;

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.childName) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"No child name provided for view transition"</span>);
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.targetEl)  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"No target element provided for view transition"</span>);

    <span class="hljs-keyword">this</span>.options = options;

    <span class="hljs-keyword">this</span>.emitter.on(<span class="hljs-string">'beforeTransition'</span>, <span class="hljs-keyword">this</span>.manageChildren.bind(<span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-378">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-378">&#182;</a>
              </div>
              <p>fire a sequence which looks like</p>
<pre><code>| beforeTransition
| transition
|--| beforeRemoveOldChild
|  | removeOldChild
|  | afterRemoveOldChild
|  |--| beforeAddNewChild
|     | addNewChild
|     | afterAddNewChild
| afterTransition
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  transition: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
    <span class="hljs-keyword">var</span> em = <span class="hljs-keyword">this</span>.emitter;

    em.on(<span class="hljs-string">'afterAddNewChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'afterTransition'</span>);
      <span class="hljs-keyword">if</span>(cb) cb();
    });

    em.on(<span class="hljs-string">'afterRemoveOldChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'beforeAddNewChild'</span>);
      em.fireAround(<span class="hljs-string">'aroundAddNewChlid'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'addNewChild'</span>);
      });
    });

    em.on(<span class="hljs-string">'transition'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'beforeRemoveOldChild'</span>);
      em.fireAround(<span class="hljs-string">'aroundRemoveOldChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'removeOldChild'</span>);
      });
    });

    em.fire(<span class="hljs-string">'beforeTransition'</span>);
    em.fireAround(<span class="hljs-string">'aroundTransition'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'transition'</span>);
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-379">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-379">&#182;</a>
              </div>
              <p>to be called at the beginning of each transition.
this removes the old child from it’s parent and adds the new one
it also begins the setup process for the new child.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  manageChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.oldChild) <span class="hljs-keyword">this</span>.parent.removeChild(<span class="hljs-keyword">this</span>.oldChild);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.newChild) {
      <span class="hljs-keyword">this</span>.parent.addChild(<span class="hljs-keyword">this</span>.childName, <span class="hljs-keyword">this</span>.newChild);
      <span class="hljs-keyword">this</span>.newChild.setup();
    }
  },

});</pre></div></div>
            
        </li>
        
        
        <li id="section-380">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-380">&#182;</a>
              </div>
              <p>Simple view transition: remove the old child from the view and dom, add the new child immediately after.
Uses the default sequence of events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.simpleViewTransition = pie.abstractViewTransition.extend(<span class="hljs-string">'simpleViewTransition'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">this</span>.emitter.on(<span class="hljs-string">'removeOldChild'</span>, <span class="hljs-keyword">this</span>.removeOldChild.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.emitter.on(<span class="hljs-string">'addNewChild'</span>,    <span class="hljs-keyword">this</span>.addNewChild.bind(<span class="hljs-keyword">this</span>));
  },

  addNewChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.newChild) {
      <span class="hljs-keyword">this</span>.newChild.emitter.once(<span class="hljs-string">'afterSetup'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">this</span>.newChild.appendToDom(<span class="hljs-keyword">this</span>.targetEl);
        <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'afterAddNewChild'</span>);
      }.bind(<span class="hljs-keyword">this</span>), {immediate: <span class="hljs-literal">true</span>});
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'afterAddNewChild'</span>);
    }
  },

  removeOldChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.oldChild) {
      <span class="hljs-keyword">this</span>.oldChild.teardown();
    }
    <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'afterRemoveOldChild'</span>);
  }

});

pie.loadingViewTransition = pie.simpleViewTransition.extend(<span class="hljs-string">'loadingViewTransition'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">this</span>.options.loadingClass = <span class="hljs-keyword">this</span>.options.loadingClass || <span class="hljs-string">'is-loading'</span>;
  },

  setLoading: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bool)</span> </span>{
    <span class="hljs-keyword">this</span>.targetEl.classList[bool ? <span class="hljs-string">'add'</span> : <span class="hljs-string">'remove'</span>](<span class="hljs-keyword">this</span>.options.loadingClass);
  },

  addNewChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.newChild) {
      <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'afterAddNewChild'</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">this</span>.begin = pie.date.now();

    <span class="hljs-keyword">this</span>.setLoading(<span class="hljs-literal">true</span>);

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.minDelay) {
      setTimeout(<span class="hljs-keyword">this</span>.attemptToAddChild.bind(<span class="hljs-keyword">this</span>), <span class="hljs-keyword">this</span>.options.minDelay);
    }

    <span class="hljs-keyword">this</span>.newChild.emitter.once(<span class="hljs-string">'afterSetup'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">this</span>.attemptToAddChild(<span class="hljs-literal">true</span>);
    }.bind(<span class="hljs-keyword">this</span>), {immediate: <span class="hljs-literal">true</span>});
  },

  attemptToAddChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(partOfAfterSetup)</span> </span>{
    <span class="hljs-keyword">var</span> now = pie.date.now();
    <span class="hljs-keyword">if</span>(partOfAfterSetup || <span class="hljs-keyword">this</span>.newChild.emitter.hasEvent(<span class="hljs-string">'afterSetup'</span>)) {
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.options.minDelay || now &gt;= (<span class="hljs-keyword">this</span>.begin + <span class="hljs-keyword">this</span>.options.minDelay)) {
        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.newChild.emitter.hasEvent(<span class="hljs-string">'removedFromParent'</span>)) {
          <span class="hljs-keyword">this</span>.setLoading(<span class="hljs-literal">false</span>);
          <span class="hljs-keyword">this</span>.newChild.appendToDom(<span class="hljs-keyword">this</span>.targetEl);
          <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'afterAddNewChild'</span>);
        }
      }
    }
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-381">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-381">&#182;</a>
              </div>
              <p>A transition which applies an “out” class to the old view, removes it after it transitions out, then adds
the new view to the dom and applies an “in” class.
Preparation of the new view is done as soon as the transition is started, enabling the shortest possible
amount of delay before the next view is added to the dom.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pie.inOutViewTransition = pie.abstractViewTransition.extend(<span class="hljs-string">'inOutViewTransition'</span>, {

  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>._super.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">this</span>.options = pie.object.merge({</pre></div></div>
            
        </li>
        
        
        <li id="section-382">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-382">&#182;</a>
              </div>
              <p>the new view will gain this class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      inClass: <span class="hljs-string">'view-in'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-383">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-383">&#182;</a>
              </div>
              <p>the old view will gain this class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      outClass: <span class="hljs-string">'view-out'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-384">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-384">&#182;</a>
              </div>
              <p>if the browser doesn’t support onTransitionEnd, here’s the backup transition duration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      backupDuration: <span class="hljs-number">250</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-385">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-385">&#182;</a>
              </div>
              <p>async=true means the new view doesn’t wait for the old one to leave.
async=false means the new view won’t be added to the dom until the previous is removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      async: <span class="hljs-literal">false</span>
    }, <span class="hljs-keyword">this</span>.options);

    <span class="hljs-keyword">this</span>.setupObservations();
  },

  setupObservations: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> em = <span class="hljs-keyword">this</span>.emitter;

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.oldChild) {
      em.on(<span class="hljs-string">'transitionOldChild'</span>,       <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'transitionOldChild'</span>));
      em.on(<span class="hljs-string">'afterTransitionOldChild'</span>,  <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'teardownOldChild'</span>));
    } <span class="hljs-keyword">else</span> {
      em.on(<span class="hljs-string">'transitionOldChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'afterTransitionOldChild'</span>);
      });
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.newChild) {
      em.on(<span class="hljs-string">'addNewChild'</span>,              <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'addNewChild'</span>));
      em.on(<span class="hljs-string">'aroundTransitionNewChild'</span>, <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'ensureNewChildPrepared'</span>));
      em.on(<span class="hljs-string">'transitionNewChild'</span>,       <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'refresh'</span>));
      em.on(<span class="hljs-string">'transitionNewChild'</span>,       <span class="hljs-keyword">this</span>.cancelWrap(<span class="hljs-string">'transitionNewChild'</span>));

      <span class="hljs-keyword">this</span>.newChild.emitter.once(<span class="hljs-string">'removedFromParent'</span>, <span class="hljs-keyword">this</span>.cancel.bind(<span class="hljs-keyword">this</span>));
    } <span class="hljs-keyword">else</span> {
      em.on(<span class="hljs-string">'transitionNewChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'afterTransitionNewChild'</span>);
      });
    }
  },

  cancelWrap: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fnName)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.emitter.hasEvent(<span class="hljs-string">'cancel'</span>)) {
        <span class="hljs-keyword">this</span>[fnName].apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
      }
    }.bind(<span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-386">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-386">&#182;</a>
              </div>
              <p>apply the relevant class(es) to the element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  applyClass: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, isIn)</span> </span>{
    <span class="hljs-keyword">var</span> add = isIn ? <span class="hljs-keyword">this</span>.options.inClass : <span class="hljs-keyword">this</span>.options.outClass,
        remove = isIn ? <span class="hljs-keyword">this</span>.options.outClass : <span class="hljs-keyword">this</span>.options.inClass;

    <span class="hljs-keyword">if</span>(add) el.classList.add(add);
    <span class="hljs-keyword">if</span>(remove) el.classList.remove(remove);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-387">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-387">&#182;</a>
              </div>
              <p>WHEN options.async !== true
fire a sequence which looks like</p>
<pre><code>| beforeTransition
| transition
|  |--| beforeRemoveOldChild
|     |--| beforeTransitionOldChild
|        | transitionOldChild
|        |--| afterTransitionOldChild
|           |--| removeOldChild
|           |  |--| afterRemoveOldChild
|           |
|           |--| beforeAddNewChild
|              | addNewChild
|              |--| afterAddNewChild
|                 |--| beforeTransitionNewChild
|                    | transitionNewChild
|                    |--| afterTransitionNewChild
|                       |--| afterTransition
</code></pre><p>WHEN options.async === true
fire a sequence which looks like</p>
<pre><code>| beforeTransition
| transition
|  |--| beforeRemoveOldChild
|  |  |--| beforeTransitionOldChild
|  |     | transitionOldChild
|  |     |--| afterTransitionOldChild
|  |        |--| removeOldChild
|  |           |--| afterRemoveOldChild
|  |
|  |--| beforeAddNewChild
|     | addNewChild
|     |--| afterAddNewChild
|        |--| beforeTransitionNewChild
|           | transitionNewChild
|           |--| afterTransitionNewChild
|              |--| afterTransition
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
  transition: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
    <span class="hljs-keyword">var</span> em = <span class="hljs-keyword">this</span>.emitter;

    em.on(<span class="hljs-string">'afterTransitionNewChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'afterTransition'</span>);
      <span class="hljs-keyword">if</span>(cb) cb();
    });

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.options.async) {
      em.on(<span class="hljs-string">'transition'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fireSequence(<span class="hljs-string">'addNewChild'</span>);
      });
    } <span class="hljs-keyword">else</span> {
      em.on(<span class="hljs-string">'afterRemoveOldChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fireSequence(<span class="hljs-string">'addNewChild'</span>);
      });
    }

    em.on(<span class="hljs-string">'afterAddNewChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'beforeTransitionNewChild'</span>);
      em.fireAround(<span class="hljs-string">'aroundTransitionNewChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'transitionNewChild'</span>);
      });
    });

    em.on(<span class="hljs-string">'afterTransitionOldChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fireSequence(<span class="hljs-string">'removeOldChild'</span>);
    });

    em.on(<span class="hljs-string">'transition'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'beforeTransitionOldChild'</span>);
      em.fireAround(<span class="hljs-string">'aroundTransitionOldChild'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        em.fire(<span class="hljs-string">'transitionOldChild'</span>);
      });
    });

    em.fire(<span class="hljs-string">'beforeTransition'</span>);
    em.fireAround(<span class="hljs-string">'aroundTransition'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      em.fire(<span class="hljs-string">'transition'</span>);
    });

  },

  cancel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.emitter.hasEvent(<span class="hljs-string">'afterTransitionNewChild'</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-388">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-388">&#182;</a>
              </div>
              <p>the goal of a transition is to get the old child out and the new child in,
we make sure we’ve done that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.oldChild) {
        <span class="hljs-keyword">this</span>.teardownOldChild();
      }

      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.newChild) {
        <span class="hljs-keyword">this</span>.applyClass(<span class="hljs-keyword">this</span>.newChild.el, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">this</span>.newChild.appendToDom(<span class="hljs-keyword">this</span>.targetEl);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-389">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-389">&#182;</a>
              </div>
              <p>then we let everyone else know.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'cancel'</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-390">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-390">&#182;</a>
              </div>
              <p>teardown() the child if it hasn’t already.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  teardownOldChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.oldChild.emitter.hasEvent(<span class="hljs-string">'beforeTeardown'</span>)) {
      <span class="hljs-keyword">this</span>.oldChild.teardown();
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-391">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-391">&#182;</a>
              </div>
              <p>give the new child the “out” classes, then add it to the dom.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addNewChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-392">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-392">&#182;</a>
              </div>
              <p>this.applyClass(this.newChild.el, false);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.newChild.appendToDom(<span class="hljs-keyword">this</span>.targetEl);
  },

  ensureNewChildPrepared: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
    <span class="hljs-keyword">this</span>.newChild.emitter.once(<span class="hljs-string">'afterRender'</span>, cb, {immediate: <span class="hljs-literal">true</span>});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-393">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-393">&#182;</a>
              </div>
              <p>make sure we’re rendered, then begin the ui transition in.
when complete, invoke the callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  transitionNewChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.observeTransitionEnd(<span class="hljs-keyword">this</span>.newChild.el, <span class="hljs-literal">true</span>, <span class="hljs-string">'afterTransitionNewChild'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-394">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-394">&#182;</a>
              </div>
              <p>start the transition out. when complete, invoke the callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  transitionOldChild: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.oldChild.el.parentNode) <span class="hljs-keyword">this</span>.emitter.fire(<span class="hljs-string">'afterTransitionOldChild'</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.observeTransitionEnd(<span class="hljs-keyword">this</span>.oldChild.el, <span class="hljs-literal">false</span>, <span class="hljs-string">'afterTransitionOldChild'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-395">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-395">&#182;</a>
              </div>
              <p>ensure the browser has redrawn and locations are up to date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  refresh: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.oldChild) <span class="hljs-keyword">this</span>.oldChild.el.getBoundingClientRect();
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.newChild) <span class="hljs-keyword">this</span>.newChild.el.getBoundingClientRect();
    <span class="hljs-keyword">if</span>(cb) cb();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-396">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-396">&#182;</a>
              </div>
              <p>build a transition callback, and apply the appropriate class.
when the transition is complete, invoke the callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  observeTransitionEnd: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, isIn, fire)</span> </span>{
    <span class="hljs-keyword">var</span> transitionEvent = <span class="hljs-keyword">this</span>.transitionEvent(el),
    trans = transitionEvent.event,
    dur = transitionEvent.duration,
    called = <span class="hljs-literal">false</span>,
    onTransitionEnd = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">if</span>(called) <span class="hljs-keyword">return</span>;
      called = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">if</span>(trans) pie.dom.off(el, trans, onTransitionEnd);
      <span class="hljs-keyword">this</span>.emitter.fire(fire);
    }.bind(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.emitter.once(<span class="hljs-string">'cancel'</span>, onTransitionEnd);

    <span class="hljs-keyword">if</span>(trans) {
      pie.dom.on(el, trans, onTransitionEnd);
    }

    <span class="hljs-keyword">this</span>.applyClass(el, isIn);

    <span class="hljs-keyword">if</span>(trans) {
      <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">isNaN</span>(dur)) {
        setTimeout(onTransitionEnd, dur * <span class="hljs-number">1.1</span>);
      }
    } <span class="hljs-keyword">else</span> {
      setTimeout(onTransitionEnd, <span class="hljs-keyword">this</span>.options.backupDuration);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-397">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-397">&#182;</a>
              </div>
              <p>which transition event should we use?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  transitionEndEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(base)</span></span>{
    <span class="hljs-keyword">var</span> cap = pie.string.capitalize(base);

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._transitionEndEvent === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span>(pie.object.has(<span class="hljs-built_in">window</span>, <span class="hljs-string">'on'</span> + base + <span class="hljs-string">'end'</span>, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">this</span>._transitionEndEvent = base + <span class="hljs-string">'end'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.has(<span class="hljs-built_in">window</span>, <span class="hljs-string">'onwebkit'</span> + base + <span class="hljs-string">'end'</span>, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">this</span>._transitionEndEvent = <span class="hljs-string">'webkit'</span> + cap + <span class="hljs-string">'End'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.has(<span class="hljs-built_in">window</span>, <span class="hljs-string">'ms'</span> + cap + <span class="hljs-string">'End'</span>, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">this</span>._transitionEndEvent = <span class="hljs-string">'ms'</span> + cap + <span class="hljs-string">'End'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pie.object.has(<span class="hljs-built_in">document</span>.body, <span class="hljs-string">'ono'</span> + base + <span class="hljs-string">'end'</span>, <span class="hljs-literal">true</span>) || navigator.appName === <span class="hljs-string">'Opera'</span>) {
        <span class="hljs-keyword">this</span>._transitionEndEvent = <span class="hljs-string">'o'</span> + cap + <span class="hljs-string">'End'</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>._transitionEndEvent = <span class="hljs-literal">false</span>;
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._transitionEndEvent;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-398">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-398">&#182;</a>
              </div>
              <p>get a transition or animation property based on the browser’s compatability.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  subProperty: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(endEvent, prop)</span> </span>{
    <span class="hljs-keyword">return</span> endEvent.replace(<span class="hljs-regexp">/end/i</span>, pie.string.capitalize(prop));
  },

  transitionEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span> </span>{
    <span class="hljs-keyword">var</span> endA = <span class="hljs-keyword">this</span>.transitionEndEvent(<span class="hljs-string">'transition'</span>),
        endB = <span class="hljs-keyword">this</span>.transitionEndEvent(<span class="hljs-string">'animation'</span>),
        objA = <span class="hljs-keyword">this</span>._transitionEvent(endA, el),
        objB = <span class="hljs-keyword">this</span>._transitionEvent(endB, el);


    <span class="hljs-keyword">return</span> objA.duration &gt; objB.duration ? objA : objB;
  },

  _transitionEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(endEvent, el)</span> </span>{
    <span class="hljs-keyword">if</span>(!endEvent) {
      <span class="hljs-keyword">return</span> {
        duration: <span class="hljs-number">0</span>
      };
    }

    <span class="hljs-keyword">var</span> durProp = <span class="hljs-keyword">this</span>.subProperty(endEvent, <span class="hljs-string">'duration'</span>),
        delayProp = <span class="hljs-keyword">this</span>.subProperty(endEvent, <span class="hljs-string">'delay'</span>),
        style = <span class="hljs-built_in">window</span>.getComputedStyle(el),
        durs = durProp &amp;&amp; style[durProp] &amp;&amp; style[durProp].split(<span class="hljs-string">','</span>) || [<span class="hljs-string">'0'</span>],
        delays = delayProp &amp;&amp; style[delayProp] &amp;&amp; style[delayProp].split(<span class="hljs-string">','</span>) || [<span class="hljs-string">'0'</span>],
        dur, delay;

    durs = durs.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseFloat</span>(d.toLowerCase(), <span class="hljs-number">10</span>); });
    delays = delays.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseFloat</span>(d.toLowerCase(), <span class="hljs-number">10</span>); });

    dur = <span class="hljs-built_in">Math</span>.max.apply(<span class="hljs-literal">null</span>, durs);
    delay = <span class="hljs-built_in">Math</span>.max.apply(<span class="hljs-literal">null</span>, delays);

    <span class="hljs-keyword">if</span>(durProp &amp;&amp; durProp.indexOf(<span class="hljs-string">'ms'</span>) &lt; <span class="hljs-number">0</span>) {
      dur *= <span class="hljs-number">1000</span>;
    }

    <span class="hljs-keyword">if</span>(delayProp &amp;&amp; delayProp.indexOf(<span class="hljs-string">'ms'</span>) &lt; <span class="hljs-number">0</span>) {
      delay *= <span class="hljs-number">1000</span>;
    }

    <span class="hljs-keyword">return</span> {
      event: endEvent,
      duration: <span class="hljs-built_in">parseInt</span>(dur + delay, <span class="hljs-number">10</span>)
    };
  }

});
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {</pre></div></div>
            
        </li>
        
        
        <li id="section-399">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-399">&#182;</a>
              </div>
              <p>AMD. Register as an anonymous module.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    define(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> pie;
    });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">window</span>.pie = pie;
  }
})(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
<script type="text/javascript">
  var titles = Array.prototype.slice.call(document.querySelectorAll('[id^="section-"] h1'), 0);
  var html = '<li class="docco-index" id="docco-index"><div class="annotation"><ul>', a = document.createElement('a');
  a.textContent = 'Back to top';
  a.href = '#docco-index';
  a.style.color = '#cccccc';

  titles.forEach(function(title) {
    html += '<li><a href="#' + title.id + '">' + title.innerHTML.replace(/pie\s/i, '') + '</a></li>';
    title.parentNode.insertBefore(a.cloneNode(true), title);
  });

  html += "</ul></div></li>";

  var newEl = document.createElement('div');
  newEl.innerHTML = html;
  newEl = newEl.firstElementChild;

  var title = document.querySelector('#title');
  title.parentNode.insertBefore(newEl, title.nextSibling);


</script>
</body>
</html>
